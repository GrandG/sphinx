<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<!-- saved from url=(0029)http://hedengcheng.com/?p=771 -->
<html xmlns="http://www.w3.org/1999/xhtml"><head profile="http://gmpg.org/xfn/11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">

	<title>何登成的技术博客 » MySQL 加锁处理分析</title>
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0 - 所有文章" href="http://hedengcheng.com/?feed=rss2">
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0 - 所有评论" href="http://hedengcheng.com/?feed=comments-rss2">
	<link rel="pingback" href="http://hedengcheng.com/xmlrpc.php">

	<!-- style START -->
	<style type="text/css" media="screen">@import url( http://hedengcheng.com/wp-content/themes/blocks2/style.css );</style>
			<link rel="stylesheet" href="./何登成的技术博客 » MySQL 加锁处理分析_files/chinese.css" type="text/css" media="screen">
		<!--[if IE]>
		<link rel="stylesheet" href="http://hedengcheng.com/wp-content/themes/blocks2/ie.css" type="text/css" media="screen" />
	<![endif]-->
	<!-- style END -->

	<!-- script START -->
	<script async="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/analytics.js.下载"></script><script type="text/javascript" src="./何登成的技术博客 » MySQL 加锁处理分析_files/base.js.下载"></script>
	<script type="text/javascript" src="./何登成的技术博客 » MySQL 加锁处理分析_files/menu.js.下载"></script>
	<!-- script END -->

		<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="何登成的技术博客 » MySQL 加锁处理分析评论Feed" href="http://hedengcheng.com/?feed=rss2&amp;p=771">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/hedengcheng.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.11"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./何登成的技术博客 » MySQL 加锁处理分析_files/wp-emoji-release.min.js.下载" type="text/javascript" defer=""></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<!-- This site uses the Google Analytics by MonsterInsights plugin v6.0.16 - Using Analytics tracking - https://www.monsterinsights.com/ -->
<script type="text/javascript" data-cfasync="false">
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');

	__gaTracker('create', 'UA-46730929-1', 'auto');
	__gaTracker('set', 'forceSSL', true);
	__gaTracker('send','pageview');
</script>
<!-- / Google Analytics by MonsterInsights -->
<link rel="https://api.w.org/" href="http://hedengcheng.com/?rest_route=/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://hedengcheng.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://hedengcheng.com/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="C/C++ Volatile关键词深度剖析" href="http://hedengcheng.com/?p=725">
<link rel="next" title="并发编程系列之一：锁的意义" href="http://hedengcheng.com/?p=803">
<meta name="generator" content="WordPress 4.7.11">
<link rel="canonical" href="http://hedengcheng.com/?p=771">
<link rel="shortlink" href="http://hedengcheng.com/?p=771">
<link rel="alternate" type="application/json+oembed" href="http://hedengcheng.com/?rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Fhedengcheng.com%2F%3Fp%3D771">
<link rel="alternate" type="text/xml+oembed" href="http://hedengcheng.com/?rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Fhedengcheng.com%2F%3Fp%3D771&amp;format=xml">
		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
		<style id="dark-reader-style" type="text/css">@media screen {

/* Leading rule */
html {
  -webkit-filter: invert(100%) hue-rotate(180deg) brightness(110%) contrast(90%) grayscale(20%) sepia(10%) !important;
  filter: invert(100%) hue-rotate(180deg) brightness(110%) contrast(90%) grayscale(20%) sepia(10%) !important;
}

/* Reverse rule */
img,
video,
:not(object):not(body)>embed,
object,
svg image,
[style*="background:url"],
[style*="background-image:url"],
[style*="background: url"],
[style*="background-image: url"],
[background],
twitterwidget {
  -webkit-filter: invert(100%) hue-rotate(180deg) !important;
  filter: invert(100%) hue-rotate(180deg) !important;
}
[style*="background:url"] *,
[style*="background-image:url"] *,
[style*="background: url"] *,
[style*="background-image: url"] *,
input,
[background] *,
img[src^="https://s0.wp.com/latex.php"] {
  -webkit-filter: none !important;
  filter: none !important;
}
.compatibility-with-darkreader-below-4-3-3 {
  background: white !important;
}

/* Text contrast */
html {
  text-shadow: 0 0 0 !important;
}

/* Full screen */
:-webkit-full-screen, :-webkit-full-screen * {
  -webkit-filter: none !important;
  filter: none !important;
}
:-moz-full-screen, :-moz-full-screen * {
  -webkit-filter: none !important;
  filter: none !important;
}
:fullscreen, :fullscreen * {
  -webkit-filter: none !important;
  filter: none !important;
}

/* Page background */
html {
  background: rgb(13,13,12) !important;
}

/* Custom rules */
.compatibility-with-darkreader-below-4-3-3 {
    background: white !important;
}

}</style></head>


<body>
	<div id="wrap">
		<div id="container">

<!-- header START -->
<div id="header">
	<div id="title">
		<h1><a href="http://hedengcheng.com/">何登成的技术博客</a></h1>
		<div id="tagline">追求技术的道路上，10年如一日</div>
	</div>

	<!-- WordPress searchbox -->
	<div class="searchbox">
		<form action="http://hedengcheng.com/" method="get">
			<div class="content">
				<input type="text" class="textfield" name="s" size="24" value="">
				<input type="submit" class="button" value="搜索">
			</div>
		</form>
	</div>

	<div class="fixed"></div>
</div>
<!-- header END -->

<!-- content START -->
<div id="content">

	<!-- menubar START -->
	<div id="navigation">
		<ul id="menubar">
			<li class="page_item"><a title="首页" href="http://hedengcheng.com/">首页</a></li>
			<li class="page_item page-item-2"><a href="http://hedengcheng.com/?page_id=2">关于我</a></li>
		</ul>
		<div id="subscribe" class="feed"><a title="订阅这个博客的文章" class="feedlink" href="http://hedengcheng.com/?feed=rss2"><abbr title="Really Simple Syndication">RSS</abbr> 订阅</a><ul style="visibility: hidden; display: block;"><li><a rel="external nofollow" title="订阅到鲜果" href="http://www.xianguo.com/subscribe.php?url=http://hedengcheng.com/?feed=rss2">					鲜果	</a></li><li><a rel="external nofollow" title="订阅到抓虾" href="http://www.zhuaxia.com/add_channel.php?url=http://hedengcheng.com/?feed=rss2">					抓虾	</a></li><li><a rel="external nofollow" title="订阅到有道" href="http://reader.yodao.com/#url=http://hedengcheng.com/?feed=rss2">								有道	</a></li><li><a rel="external nofollow" title="订阅到 Google" href="http://fusion.google.com/add?feedurl=http://hedengcheng.com/?feed=rss2">						 Google	</a></li><li><a rel="external nofollow" title="订阅到 netvibes" href="http://www.netvibes.com/subscribe.php?url=http://hedengcheng.com/?feed=rss2">					 netvibes	</a></li><li><a rel="external nofollow" title="订阅到 newsgator" href="http://www.newsgator.com/ngs/subscriber/subfext.aspx?url=http://hedengcheng.com/?feed=rss2">	 newsgator</a></li><li><a rel="external nofollow" title="订阅到 Bloglines" href="http://www.bloglines.com/sub/http://hedengcheng.com/?feed=rss2">								 Bloglines</a></li><li><a rel="external nofollow" title="订阅到哪吒" href="http://inezha.com/add?url=http://hedengcheng.com/?feed=rss2" class=" last">									哪吒	</a></li></ul></div>
				
		<span id="copyright">
			© 2012-2017 何登成的技术博客		</span>
		<div class="fixed"></div>
	</div>
	<!-- menubar END -->

	<!-- main START -->
	<div id="main">

<div class="post" id="post-771">
	<h2 class="title">MySQL 加锁处理分析</h2>
	<div class="meta">
		<div class="info">
			12月 13th, 2013								</div>
		<div class="comments">
			<a href="http://hedengcheng.com/?p=771#respond">发表评论</a>
						 | <a href="http://hedengcheng.com/wp-trackback.php?p=771" rel="trackback">Trackback</a>
								</div>
		<div class="fixed"></div>
	</div>

	<div class="content">
		<p>&nbsp;</p>
<p><a href="http://hedengcheng.com/?p=771#_Toc374698306"><span style="font-size: 10pt;"><strong>1</strong></span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;"><strong>背景&nbsp;&nbsp;&nbsp;&nbsp;1</strong></span><span style="font-size: 10pt;"><br>
</span></a></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698307"><span style="font-size: 10pt;">1.1</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">MVCC：Snapshot Read vs Current Read&nbsp;&nbsp;&nbsp;&nbsp;2</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698308"><span style="font-size: 10pt;">1.2</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">Cluster Index：聚簇索引&nbsp;&nbsp;&nbsp;&nbsp;3</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698309"><span style="font-size: 10pt;">1.3</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">2PL：Two-Phase Locking&nbsp;&nbsp;&nbsp;&nbsp;3</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698310"><span style="font-size: 10pt;">1.4</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">Isolation Level&nbsp;&nbsp;&nbsp;&nbsp;4</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p><a href="http://hedengcheng.com/?p=771#_Toc374698311"><span style="font-size: 10pt;"><strong>2</strong></span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;"><strong>一条简单SQL的加锁实现分析&nbsp;&nbsp;&nbsp;&nbsp;5</strong></span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698312"><span style="font-size: 10pt;">2.1</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合一：id主键+RC&nbsp;&nbsp;&nbsp;&nbsp;6</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698313"><span style="font-size: 10pt;">2.2</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合二：id唯一索引+RC&nbsp;&nbsp;&nbsp;&nbsp;6</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698314"><span style="font-size: 10pt;">2.3</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合三：id非唯一索引+RC&nbsp;&nbsp;&nbsp;&nbsp;7</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698315"><span style="font-size: 10pt;">2.4</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合四：id无索引+RC&nbsp;&nbsp;&nbsp;&nbsp;8</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698316"><span style="font-size: 10pt;">2.5</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合五：id主键+RR&nbsp;&nbsp;&nbsp;&nbsp;9</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698317"><span style="font-size: 10pt;">2.6</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合六：id唯一索引+RR&nbsp;&nbsp;&nbsp;&nbsp;9</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698318"><span style="font-size: 10pt;">2.7</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合七：id非唯一索引+RR&nbsp;&nbsp;&nbsp;&nbsp;9</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698319"><span style="font-size: 10pt;">2.8</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合八：id无索引+RR&nbsp;&nbsp;&nbsp;&nbsp;11</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p style="margin-left: 10pt;"><a href="http://hedengcheng.com/?p=771#_Toc374698320"><span style="font-size: 10pt;">2.9</span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;">组合九：Serializable&nbsp;&nbsp;&nbsp;&nbsp;12</span></a><span style="font-size: 10pt;"><br>
</span></p>
<p><a href="http://hedengcheng.com/?p=771#_Toc374698321"><span style="font-size: 10pt;"><strong>3</strong></span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;"><strong>一条复杂的SQL&nbsp;&nbsp;&nbsp;&nbsp;12</strong></span></a><span style="font-size: 10pt;"><br>
</span></p>
<p><a href="http://hedengcheng.com/?p=771#_Toc374698322"><span style="font-size: 10pt;"><strong>4</strong></span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;"><strong>死锁原理与分析&nbsp;&nbsp;&nbsp;&nbsp;14</strong></span></a><span style="font-size: 10pt;"><br>
</span></p>
<p><a href="http://hedengcheng.com/?p=771#_Toc374698323"><span style="font-size: 10pt;"><strong>5</strong></span><span style="font-size: 10pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-size: 10pt;"><strong>总结&nbsp;&nbsp;&nbsp;&nbsp;16</strong></span></a><span style="font-size: 10pt;"><br>
</span></p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h1><strong>背景</strong></h1>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>MySQL/InnoDB的加锁分析，一直是一个比较困难的话题。我在工作过程中，经常会有同事咨询这方面的问题。同时，微博上也经常会收到MySQL锁相关的私信，让我帮助解决一些死锁的问题。本文，准备就MySQL/InnoDB的加锁问题，展开较为深入的分析与讨论，主要是介绍一种思路，运用此思路，拿到任何一条SQL语句，都能完整的分析出这条语句会加什么锁？会有什么样的使用风险？甚至是分析线上的一个死锁场景，了解死锁产生的原因。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>注：</strong></span>MySQL是一个支持插件式存储引擎的数据库系统。本文下面的所有介绍，都是基于InnoDB存储引擎，其他引擎的表现，会有较大的区别。</p>
<p><span id="more-771"></span></p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>MVCC：Snapshot Read vs Current Read</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>MySQL InnoDB存储引擎，实现的是基于多版本的并发控制协议——MVCC (<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_blank">Multi-Version Concurrency Control</a>) (注：与MVCC相对的，是基于锁的并发控制，Lock-Based Concurrency Control)。MVCC最大的好处，相信也是耳熟能详：读不加锁，读写不冲突。在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能，这也是为什么现阶段，几乎所有的RDBMS，都支持了MVCC。</p>
<p>&nbsp;</p>
<p>在MVCC并发控制中，读操作可以分成两类：快照读 (snapshot read)与当前读 (current read)。快照读，读取的是记录的可见版本 (有可能是历史版本)，不用加锁。当前读，读取的是记录的最新版本，并且，当前读返回的记录，都会加上锁，保证其他事务不会再并发修改这条记录。</p>
<p>&nbsp;</p>
<p>在一个支持MVCC并发控制的系统中，哪些读操作是快照读？哪些操作又是当前读呢？以MySQL InnoDB为例：</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>快照读：</strong></span>简单的select操作，属于快照读，不加锁。(当然，也有例外，下面会分析)<br>
</span></div>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">select * from table where ?;<br>
</span></div>
</li>
</ul>
<p style="text-align: justify;">
</p></li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>当前读：</strong></span>特殊的读操作，插入/更新/删除操作，属于当前读，需要加锁。<br>
</span></div>
<ul>
<li>
<div style="text-align: justify;"><span style="color: #00b050; font-size: 10pt;">select * from table where ? lock in share mode;<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">select * from table where ? for update;<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">insert into table values (…);<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">update table set ? where ?;<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">delete from table where ?;<br>
</span></div>
</li>
</ul>
<p>所有以上的语句，都属于当前读，读取记录的最新版本。并且，读取之后，还需要保证其他并发事务不能修改当前记录，对读取记录加锁。其中，除了第一条语句，对读取记录加S锁 (共享锁)外，其他的操作，都加的是X锁 (排它锁)。</p>
<p>&nbsp;</p></li>
</ul>
<p>为什么将 插入/更新/删除 操作，都归为当前读？可以看看下面这个 更新 操作，在数据库中的执行流程：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010766/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010766/&#39;, &#39;&#39;);" title="update 执行流程"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish.jpg" alt="update 执行流程" width="500" height="424" border="0"></a></p>
<p>从图中，可以看到，一个Update操作的具体流程。当Update SQL被发给MySQL后，MySQL Server会根据where条件，读取第一条满足条件的记录，然后InnoDB引擎会将第一条记录返回，并加锁 (current read)。待MySQL Server收到这条加锁的记录之后，会再发起一个Update请求，更新这条记录。一条记录操作完成，再读取下一条记录，直至没有满足条件的记录为止。因此，Update操作内部，就包含了一个当前读。同理，Delete操作也一样。Insert操作会稍微有些不同，简单来说，就是Insert操作可能会触发Unique Key的冲突检查，也会进行一个当前读。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>注</strong>：</span>根据上图的交互，针对一条当前读的SQL语句，InnoDB与MySQL Server的交互，是一条一条进行的，因此，加锁也是一条一条进行的。先对一条满足条件的记录加锁，返回给MySQL Server，做一些DML操作；然后在读取下一条加锁，直至读取完毕。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>Cluster Index：聚簇索引</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>InnoDB存储引擎的数据组织方式，是聚簇索引表：完整的记录，存储在主键索引中，通过主键索引，就可以获取记录所有的列。关于聚簇索引表的组织方式，可以参考MySQL的官方文档：<a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-index-types.html" target="_blank">Clustered and Secondary Indexes</a> 。本文假设读者对这个，已经有了一定的认识，就不再做具体的介绍。接下来的部分，主键索引/聚簇索引 两个名称，会有一些混用，望读者知晓。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>2PL：Two-Phase Locking</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>传统RDBMS加锁的一个原则，就是2PL (二阶段锁)：<a href="http://en.wikipedia.org/wiki/Two-phase_locking" target="_blank">Two-Phase Locking</a>。相对而言，2PL比较容易理解，说的是锁操作分为两个阶段：加锁阶段与解锁阶段，并且保证加锁阶段与解锁阶段不相交。下面，仍旧以MySQL为例，来简单看看2PL在MySQL中的实现。</p>
<p>&nbsp;</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010758/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010758/&#39;, &#39;&#39;);" title="2PL"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(1).jpg" alt="2PL" width="500" height="475" border="0"></a></p>
<p>从上图可以看出，2PL就是将加锁/解锁分为两个完全不相交的阶段。加锁阶段：只加锁，不放锁。解锁阶段：只放锁，不加锁。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>Isolation Level</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>隔离级别：<a href="http://en.wikipedia.org/wiki/Isolation_(database_systems)">Isolation Level</a>，也是RDBMS的一个关键特性。相信对数据库有所了解的朋友，对于4种隔离级别：Read Uncommited，Read Committed，Repeatable Read，Serializable，都有了深入的认识。本文不打算讨论数据库理论中，是如何定义这4种隔离级别的含义的，而是跟大家介绍一下MySQL/InnoDB是如何定义这4种隔离级别的。</p>
<p>&nbsp;</p>
<p>MySQL/InnoDB定义的4种隔离级别：</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: #ff0000;">Read Uncommited</span><br>
</strong></span></div>
<p style="text-align: justify;"><span style="font-size: 10pt;">可以读取未提交记录。此隔离级别，不会使用，忽略。<br>
</span></p>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: #ff0000;">Read Committed (RC)</span><br>
</strong></span></div>
<p style="text-align: justify;"><span style="font-size: 10pt;">快照读忽略，本文不考虑。<br>
</span></p>
<p style="text-align: justify;"><span style="font-size: 10pt;">针对当前读，<strong>RC隔离级别保证对读取到的记录加锁 (记录锁)</strong>，存在幻读现象。<br>
</span></p>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: #ff0000;">Repeatable Read (RR)</span><br>
</strong></span></div>
<p style="text-align: justify;"><span style="font-size: 10pt;">快照读忽略，本文不考虑。<br>
</span></p>
<p style="text-align: justify;"><span style="font-size: 10pt;">针对当前读，<strong>RR隔离级别保证对读取到的记录加锁 (记录锁)，同时保证对读取的范围加锁，新的满足查询条件的记录不能够插入 (间隙锁)</strong>，不存在幻读现象。<br>
</span></p>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: #ff0000;">Serializable</span><br>
</strong></span></div>
<p style="text-align: justify;"><span style="font-size: 10pt;">从MVCC并发控制退化为基于锁的并发控制。不区别快照读与当前读，所有的读操作均为当前读，读加读锁 (S锁)，写加写锁 (X锁)。<br>
</span></p>
<p style="text-align: justify;"><span style="font-size: 10pt;">Serializable隔离级别下，读写冲突，因此并发度急剧下降，在MySQL/InnoDB下不建议使用。<strong><br>
</strong></span></p>
</li>
</ul>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h1><strong>一条简单SQL的加锁实现分析</strong></h1>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>在介绍完一些背景知识之后，本文接下来将选择几个有代表性的例子，来详细分析MySQL的加锁处理。当然，还是从最简单的例子说起。经常有朋友发给我一个SQL，然后问我，这个SQL加什么锁？就如同下面两条简单的SQL，他们加什么锁？</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong>SQL1：</strong>select * from t1 where id = 10;<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong>SQL2：</strong>delete from t1 where id = 10;<br>
</span></div>
</li>
</ul>
<p>&nbsp;</p>
<p>针对这个问题，该怎么回答？我能想象到的一个答案是：</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong>SQL1：</strong>不加锁。因为MySQL是使用多版本并发控制的，读不加锁。<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong>SQL2：</strong>对id = 10的记录加写锁 (走主键索引)。<br>
</span></div>
</li>
</ul>
<p>&nbsp;</p>
<p>这个答案对吗？说不上来。即可能是正确的，也有可能是错误的，已知条件不足，这个问题没有答案。如果让我来回答这个问题，我必须还要知道以下的一些前提，前提不同，我能给出的答案也就不同。要回答这个问题，还缺少哪些前提条件？</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>前提一：</strong></span>id列是不是主键？<br>
</span></div>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>前提二：</strong></span>当前系统的隔离级别是什么？<br>
</span></div>
</li>
</ul>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>前提三：</strong></span>id列如果不是主键，那么id列上有索引吗？<br>
</span></div>
</li>
</ul>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>前提四：</strong></span>id列上如果有二级索引，那么这个索引是唯一索引吗？<br>
</span></div>
</li>
</ul>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>前提五：</strong></span>两个SQL的执行计划是什么？索引扫描？全表扫描？<br>
</span></div>
</li>
</ul>
<p>&nbsp;</p>
<p>没有这些前提，直接就给定一条SQL，然后问这个SQL会加什么锁，都是很业余的表现。而当这些问题有了明确的答案之后，给定的SQL会加什么锁，也就一目了然。下面，我将这些问题的答案进行组合，然后按照从易到难的顺序，逐个分析每种组合下，对应的SQL会加哪些锁？</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>注：</strong></span>下面的这些组合，我做了一个前提假设，也就是有索引时，执行计划一定会选择使用索引进行过滤 (索引扫描)。但实际情况会复杂很多，真正的执行计划，还是需要根据MySQL输出的为准。</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合一</span>：</strong>id列是主键，RC隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合二</span>：</strong>id列是二级唯一索引，RC隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合三</span>：</strong>id列是二级非唯一索引，RC隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合四</span>：</strong>id列上没有索引，RC隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合五</span>：</strong>id列是主键，RR隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合六</span>：</strong>id列是二级唯一索引，RR隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合七</span>：</strong>id列是二级非唯一索引，RR隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合八</span>：</strong>id列上没有索引，RR隔离级别<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><strong><span style="color: red;">组合九</span>：</strong>Serializable隔离级别<br>
</span></div>
</li>
</ul>
<p>&nbsp;</p>
<p>排列组合还没有列举完全，但是看起来，已经很多了。真的有必要这么复杂吗？事实上，要分析加锁，就是需要这么复杂。但是从另一个角度来说，只要你选定了一种组合，SQL需要加哪些锁，其实也就确定了。接下来，就让我们来逐个分析这9种组合下的SQL加锁策略。</p>
<p>&nbsp;</p>
<p>注：在前面八种组合下，也就是RC，RR隔离级别下，SQL1：select操作均不加锁，采用的是快照读，因此在下面的讨论中就忽略了，主要讨论SQL2：delete操作的加锁。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合一：id主键+RC</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>这个组合，是最简单，最容易分析的组合。id是主键，Read Committed隔离级别，给定SQL：delete from t1 where id = 10; 只需要将主键上，id = 10的记录加上X锁即可。如下图所示：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010765/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010765/&#39;, &#39;&#39;);" title="id主键+rc"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(2).jpg" alt="id主键+rc" width="500" height="440" border="0"></a></p>
<p><span style="color: #ff0000;"><strong>结论：</strong></span>id是主键时，此SQL只需要在id=10这条记录上加X锁即可。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合二：id唯一索引+RC</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>这个组合，id不是主键，而是一个Unique的二级索引键值。那么在RC隔离级别下，delete from t1 where id = 10; 需要加什么锁呢？见下图：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010759/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010759/&#39;, &#39;&#39;);" title="id unique+rc"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(3).jpg" alt="id unique+rc" width="500" height="440" border="0"></a></p>
<p>此组合中，id是unique索引，而主键是name列。此时，加锁的情况由于组合一有所不同。由于id是unique索引，因此delete语句会选择走id列的索引进行where条件的过滤，在找到id=10的记录后，首先会将unique索引上的id=10索引记录加上X锁，同时，会根据读取到的name列，回主键索引(聚簇索引)，然后将聚簇索引上的name = ‘d’ 对应的主键索引项加X锁。为什么聚簇索引上的记录也要加锁？试想一下，如果并发的一个SQL，是通过主键索引来更新：update t1 set id = 100 where name = ‘d’; 此时，如果delete语句没有将主键索引上的记录加锁，那么并发的update就会感知不到delete语句的存在，违背了同一记录上的更新/删除需要串行执行的约束。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>结论</strong>：</span>若id列是unique列，其上有unique索引。那么SQL需要加两个X锁，一个对应于id unique索引上的id = 10的记录，另一把锁对应于聚簇索引上的[name=’d’,id=10]的记录。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合三：id非唯一索引+RC</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>相对于组合一、二，组合三又发生了变化，隔离级别仍旧是RC不变，但是id列上的约束又降低了，id列不再唯一，只有一个普通的索引。假设delete from t1 where id = 10; 语句，仍旧选择id列上的索引进行过滤where条件，那么此时会持有哪些锁？同样见下图：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010762/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010762/&#39;, &#39;&#39;);" title="id 非唯一索引+rc"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(4).jpg" alt="id 非唯一索引+rc" width="500" height="440" border="0"></a></p>
<p>根据此图，可以看到，首先，id列索引上，满足id = 10查询条件的记录，均已加锁。同时，这些记录对应的主键索引上的记录也都加上了锁。与组合二唯一的区别在于，组合二最多只有一个满足等值查询的记录，而组合三会将所有满足查询条件的记录都加锁。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>结论</strong>：</span>若id列上有非唯一索引，那么对应的所有满足SQL查询条件的记录，都会被加锁。同时，这些记录在主键索引上的记录，也会被加锁。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合四：id无索引+RC</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>相对于前面三个组合，这是一个比较特殊的情况。id列上没有索引，where id = 10;这个过滤条件，没法通过索引进行过滤，那么只能走全表扫描做过滤。对应于这个组合，SQL会加什么锁？或者是换句话说，全表扫描时，会加什么锁？这个答案也有很多：有人说会在表上加X锁；有人说会将聚簇索引上，选择出来的id = 10;的记录加上X锁。那么实际情况呢？请看下图：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010763/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010763/&#39;, &#39;&#39;);" title="id 无索引+rc"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(5).jpg" alt="id 无索引+rc" width="500" height="440" border="0"></a></p>
<p>由于id列上没有索引，因此只能走聚簇索引，进行全部扫描。从图中可以看到，满足删除条件的记录有两条，但是，聚簇索引上所有的记录，都被加上了X锁。无论记录是否满足条件，全部被加上X锁。既不是加表锁，也不是在满足条件的记录上加行锁。</p>
<p>&nbsp;</p>
<p>有人可能会问？为什么不是只在满足条件的记录上加锁呢？这是由于MySQL的实现决定的。如果一个条件无法通过索引快速过滤，那么存储引擎层面就会将所有记录加锁后返回，然后由MySQL Server层进行过滤。因此也就把所有的记录，都锁上了。</p>
<p>&nbsp;</p>
<p>注：在实际的实现中，MySQL有一些改进，在MySQL Server过滤条件，发现不满足后，会调用unlock_row方法，把不满足条件的记录放锁 (违背了2PL的约束)。这样做，保证了最后只会持有满足条件记录上的锁，但是每条记录的加锁操作还是不能省略的。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>结论：</strong></span>若id列上没有索引，SQL会走聚簇索引的全扫描进行过滤，由于过滤是由MySQL Server层面进行的。因此每条记录，无论是否满足条件，都会被加上X锁。但是，为了效率考量，MySQL做了优化，对于不满足条件的记录，会在判断后放锁，最终持有的，是满足条件的记录上的锁，但是不满足条件的记录上的加锁/放锁动作不会省略。同时，优化也违背了2PL的约束。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合五：id主键+RR</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>上面的四个组合，都是在Read Committed隔离级别下的加锁行为，接下来的四个组合，是在Repeatable Read隔离级别下的加锁行为。</p>
<p>&nbsp;</p>
<p>组合五，id列是主键列，Repeatable Read隔离级别，针对delete from t1 where id = 10; 这条SQL，加锁与组合一：[<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E4%B8%80%EF%BC%9Aid%E4%B8%BB%E9%94%AE+RC">id主键，Read Committed</a>]一致。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合六：id唯一索引+RR</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>与组合五类似，组合六的加锁，与组合二：[<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E4%BA%8C%EF%BC%9Aid%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95+RC">id唯一索引，Read Committed</a>]一致。两个X锁，id唯一索引满足条件的记录上一个，对应的聚簇索引上的记录一个。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合七：id非唯一索引+RR</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>还记得前面提到的MySQL的四种隔离级别的区别吗？RC隔离级别允许幻读，而RR隔离级别，不允许存在幻读。但是在组合五、组合六中，加锁行为又是与RC下的加锁行为完全一致。那么RR隔离级别下，如何防止幻读呢？问题的答案，就在组合七中揭晓。</p>
<p>&nbsp;</p>
<p>组合七，Repeatable Read隔离级别，id上有一个非唯一索引，执行delete from t1 where id = 10; 假设选择id列上的索引进行条件过滤，最后的加锁行为，是怎么样的呢？同样看下面这幅图：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010761/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010761/&#39;, &#39;&#39;);" title="id 非唯一索引 + rr"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(6).jpg" alt="id 非唯一索引 + rr" width="500" height="440" border="0"></a></p>
<p>此图，相对于组合三：[<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E4%B8%89%EF%BC%9Aid%E9%9D%9E%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95+RC">id列上非唯一锁，Read Committed</a>]看似相同，其实却有很大的区别。最大的区别在于，这幅图中多了一个GAP锁，而且GAP锁看起来也不是加在记录上的，倒像是加载两条记录之间的位置，GAP锁有何用？</p>
<p>&nbsp;</p>
<p>其实这个多出来的GAP锁，就是RR隔离级别，相对于RC隔离级别，不会出现幻读的关键。确实，GAP锁锁住的位置，也不是记录本身，而是两条记录之间的GAP。所谓幻读，就是同一个事务，连续做两次当前读 (例如：select * from t1 where id = 10 for update;)，那么这两次当前读返回的是完全相同的记录 (记录数量一致，记录本身也一致)，第二次的当前读，不会比第一次返回更多的记录 (幻象)。</p>
<p>&nbsp;</p>
<p>如何保证两次当前读返回一致的记录，那就需要在第一次当前读与第二次当前读之间，其他的事务不会插入新的满足条件的记录并提交。为了实现这个功能，GAP锁应运而生。</p>
<p>&nbsp;</p>
<p>如图中所示，有哪些位置可以插入新的满足条件的项 (id = 10)，考虑到B+树索引的有序性，满足条件的项一定是连续存放的。记录[6,c]之前，不会插入id=10的记录；<a name="OLE_LINK1"></a>[6,c]与[10,b]间可以插入[10, aa]；[10,b]与[10,d]间，可以插入新的[10,bb],[10,c]等；[10,d]与[11,f]间可以插入满足条件的[10,e],[10,z]等；而[11,f]之后也不会插入满足条件的记录。因此，为了保证[6,c]与[10,b]间，[10,b]与[10,d]间，[10,d]与[11,f]不会插入新的满足条件的记录，MySQL选择了用GAP锁，将这三个GAP给锁起来。</p>
<p>&nbsp;</p>
<p>Insert操作，如insert [10,aa]，首先会定位到[6,c]与[10,b]间，然后在插入前，会检查这个GAP是否已经被锁上，如果被锁上，则Insert不能插入记录。因此，通过第一遍的当前读，不仅将满足条件的记录锁上 (X锁)，与组合三类似。同时还是增加3把GAP锁，将可能插入满足条件记录的3个GAP给锁上，保证后续的Insert不能插入新的id=10的记录，也就杜绝了同一事务的第二次当前读，出现幻象的情况。</p>
<p>&nbsp;</p>
<p>有心的朋友看到这儿，可以会问：既然防止幻读，需要靠GAP锁的保护，为什么组合五、组合六，也是RR隔离级别，却不需要加GAP锁呢？</p>
<p>&nbsp;</p>
<p>首先，这是一个好问题。其次，回答这个问题，也很简单。GAP锁的目的，是为了防止同一事务的两次当前读，出现幻读的情况。而组合五，id是主键；组合六，id是unique键，都能够保证唯一性。一个等值查询，最多只能返回一条记录，而且新的相同取值的记录，一定不会在新插入进来，因此也就避免了GAP锁的使用。其实，针对此问题，还有一个更深入的问题：<span style="color: red;">如果组合五、组合六下，针对SQL：select * from t1 where id = 10 for update; 第一次查询，没有找到满足查询条件的记录，那么GAP锁是否还能够省略？</span>此问题留给大家思考。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>结论：</strong></span>Repeatable Read隔离级别下，id列上有一个非唯一索引，对应SQL：delete from t1 where id = 10; 首先，通过id索引定位到第一条满足查询条件的记录，加记录上的X锁，加GAP上的GAP锁，然后加主键聚簇索引上的记录X锁，然后返回；然后读取下一条，重复进行。直至进行到第一条不满足条件的记录[11,f]，此时，不需要加记录X锁，但是仍旧需要加GAP锁，最后返回结束。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合八：id无索引+RR</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>组合八，Repeatable Read隔离级别下的最后一种情况，id列上没有索引。此时SQL：delete from t1 where id = 10; 没有其他的路径可以选择，只能进行全表扫描。最终的加锁情况，如下图所示：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010764/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010764/&#39;, &#39;&#39;);" title="id 无索引+rr"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(7).jpg" alt="id 无索引+rr" width="500" height="475" border="0"></a></p>
<p>如图，这是一个很恐怖的现象。首先，聚簇索引上的所有记录，都被加上了X锁。其次，聚簇索引每条记录间的间隙(GAP)，也同时被加上了GAP锁。这个示例表，只有6条记录，一共需要6个记录锁，7个GAP锁。试想，如果表上有1000万条记录呢？</p>
<p>&nbsp;</p>
<p>在这种情况下，这个表上，除了不加锁的快照度，其他任何加锁的并发SQL，均不能执行，不能更新，不能删除，不能插入，全表被锁死。</p>
<p>&nbsp;</p>
<p>当然，跟组合四：[<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E5%9B%9B%EF%BC%9Aid%E6%97%A0%E7%B4%A2%E5%BC%95+RC">id无索引, Read Committed</a>]类似，这个情况下，MySQL也做了一些优化，就是所谓的semi-consistent read。semi-consistent read开启的情况下，对于不满足查询条件的记录，MySQL会提前放锁。针对上面的这个用例，就是除了记录[d,10]，[g,10]之外，所有的记录锁都会被释放，同时不加GAP锁。semi-consistent read如何触发：要么是read committed隔离级别；要么是Repeatable Read隔离级别，同时设置了 <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html">innodb_locks_unsafe_for_binlog</a> 参数。更详细的关于semi-consistent read的介绍，可参考我之前的一篇博客：<a href="http://hedengcheng.com/?p=220">MySQL+InnoDB semi-consitent read原理及实现分析</a> 。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>结论：</strong></span>在Repeatable Read隔离级别下，如果进行全表扫描的当前读，那么会锁上表中的所有记录，同时会锁上聚簇索引内的所有GAP，杜绝所有的并发 更新/删除/插入 操作。当然，也可以通过触发semi-consistent read，来缓解加锁开销与并发影响，但是semi-consistent read本身也会带来其他问题，不建议使用。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h2><strong>组合九：Serializable</strong></h2>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>针对前面提到的简单的SQL，最后一个情况：Serializable隔离级别。对于SQL2：delete from t1 where id = 10; 来说，Serializable隔离级别与Repeatable Read隔离级别完全一致，因此不做介绍。</p>
<p>&nbsp;</p>
<p>Serializable隔离级别，影响的是SQL1：select * from t1 where id = 10; 这条SQL，在RC，RR隔离级别下，都是快照读，不加锁。但是在Serializable隔离级别，SQL1会加读锁，也就是说快照读不复存在，MVCC并发控制降级为Lock-Based CC。</p>
<p>&nbsp;</p>
<p><strong>结论：</strong>在MySQL/InnoDB中，所谓的读不加锁，并不适用于所有的情况，而是隔离级别相关的。Serializable隔离级别，读不加锁就不再成立，所有的读操作，都是当前读。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h1><strong>一条复杂的SQL</strong></h1>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>写到这里，其实MySQL的加锁实现也已经介绍的八八九九。只要将本文上面的分析思路，大部分的SQL，都能分析出其会加哪些锁。而这里，再来看一个稍微复杂点的SQL，用于说明MySQL加锁的另外一个逻辑。SQL用例如下：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010767/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010767/&#39;, &#39;&#39;);" title="复杂SQL"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(8).jpg" alt="复杂SQL" width="500" height="480" border="0"></a></p>
<p>如图中的SQL，会加什么锁？假定在Repeatable Read隔离级别下 (Read Committed隔离级别下的加锁情况，留给读者分析。)，同时，假设SQL走的是idx_t1_pu索引。</p>
<p>&nbsp;</p>
<p>在详细分析这条SQL的加锁情况前，还需要有一个知识储备，那就是一个SQL中的where条件如何拆分？具体的介绍，建议阅读我之前的一篇文章：<a href="http://hedengcheng.com/?p=577">SQL中的where条件，在数据库中提取与应用浅析</a> 。在这里，我直接给出分析后的结果：</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>Index key：</strong></span>pubtime &gt; 1 and puptime &lt; 20。此条件，用于确定SQL在idx_t1_pu索引上的查询范围。<br>
</span></div>
<p style="text-align: justify;">
</p></li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>Index Filter：</strong></span>userid = ‘hdc’ 。此条件，可以在idx_t1_pu索引上进行过滤，但不属于Index Key。<br>
</span></div>
</li>
</ul>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;"><span style="color: #ff0000;"><strong>Table Filter：</strong></span>comment is not NULL。此条件，在idx_t1_pu索引上无法过滤，只能在聚簇索引上过滤。<br>
</span></div>
</li>
</ul>
<p>&nbsp;</p>
<p>在分析出SQL where条件的构成之后，再来看看这条SQL的加锁情况 (RR隔离级别)，如下图所示：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010768/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010768/&#39;, &#39;&#39;);" title="SQL加锁"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(9).jpg" alt="SQL加锁" width="500" height="480" border="0"></a></p>
<p>从图中可以看出，在Repeatable Read隔离级别下，由Index Key所确定的范围，被加上了GAP锁；Index Filter锁给定的条件 (userid = ‘hdc’)何时过滤，视MySQL的版本而定，在MySQL 5.6版本之前，不支持<a href="http://dev.mysql.com/doc/refman/5.6/en/index-condition-pushdown-optimization.html">Index Condition Pushdown</a>(ICP)，因此Index Filter在MySQL Server层过滤，在5.6后支持了Index Condition Pushdown，则在index上过滤。若不支持ICP，不满足Index Filter的记录，也需要加上记录X锁，若支持ICP，则不满足Index Filter的记录，无需加记录X锁 (图中，用红色箭头标出的X锁，是否要加，视是否支持ICP而定)；而Table Filter对应的过滤条件，则在聚簇索引中读取后，在MySQL Server层面过滤，因此聚簇索引上也需要X锁。最后，选取出了一条满足条件的记录[8,hdc,d,5,good]，但是加锁的数量，要远远大于满足条件的记录数量。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>结论：</strong></span>在Repeatable Read隔离级别下，针对一个复杂的SQL，首先需要提取其where条件。Index Key确定的范围，需要加上GAP锁；Index Filter过滤条件，视MySQL版本是否支持ICP，若支持ICP，则不满足Index Filter的记录，不加X锁，否则需要X锁；Table Filter过滤条件，无论是否满足，都需要加X锁。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h1><strong>死锁原理与分析</strong></h1>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>本文前面的部分，基本上已经涵盖了MySQL/InnoDB所有的加锁规则。深入理解MySQL如何加锁，有两个比较重要的作用：</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">可以根据MySQL的加锁规则，写出不会发生死锁的SQL；<br>
</span></div>
<p style="text-align: justify;">
</p></li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">可以根据MySQL的加锁规则，定位出线上产生死锁的原因；<br>
</span></div>
</li>
</ul>
<p>下面，来看看两个死锁的例子 (一个是两个Session的两条SQL产生死锁；另一个是两个Session的一条SQL，产生死锁)：</p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010769/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010769/&#39;, &#39;&#39;);" title="死锁用例"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(10).jpg" alt="死锁用例" width="500" height="350" border="0"></a></p>
<p style="text-align: center;"><a href="http://www.yupoo.com/photos/hedengcheng/90010770/" onclick="__gaTracker(&#39;send&#39;, &#39;event&#39;, &#39;outbound-article&#39;, &#39;http://www.yupoo.com/photos/hedengcheng/90010770/&#39;, &#39;&#39;);" title="死锁用例2"><img src="./何登成的技术博客 » MySQL 加锁处理分析_files/medish(11).jpg" alt="死锁用例2" width="500" height="400" border="0"></a></p>
<p>上面的两个死锁用例。第一个非常好理解，也是最常见的死锁，每个事务执行两条SQL，分别持有了一把锁，然后加另一把锁，产生死锁。</p>
<p>&nbsp;</p>
<p>第二个用例，虽然每个Session都只有一条语句，仍旧会产生死锁。要分析这个死锁，首先必须用到本文前面提到的MySQL加锁的规则。针对Session 1，从name索引出发，读到的[hdc, 1]，[hdc, 6]均满足条件，不仅会加name索引上的记录X锁，而且会加聚簇索引上的记录X锁，加锁顺序为先[1,hdc,100]，后[6,hdc,10]。而Session 2，从pubtime索引出发，[10,6],[100,1]均满足过滤条件，同样也会加聚簇索引上的记录X锁，加锁顺序为[6,hdc,10]，后[1,hdc,100]。发现没有，跟Session 1的加锁顺序正好相反，如果两个Session恰好都持有了第一把锁，请求加第二把锁，死锁就发生了。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>结论：</strong></span>死锁的发生与否，并不在于事务中有多少条SQL语句，<strong>死锁的关键在于</strong>：两个(或以上)的Session<span style="color: #ff0000;"><strong>加锁的顺序</strong></span>不一致。而使用本文上面提到的，分析MySQL每条SQL语句的加锁规则，分析出每条语句的加锁顺序，然后检查多个并发SQL间是否存在以相反的顺序加锁的情况，就可以分析出各种潜在的死锁情况，也可以分析出线上死锁发生的原因。</p>
<p>&nbsp;</p>
<ol>
<li>
<div style="text-align: justify;">
<h1><strong>总结</strong></h1>
</div>
</li>
</ol>
<p>&nbsp;</p>
<p>写到这儿，本文也告一段落，做一个简单的总结，要做的完全掌握MySQL/InnoDB的加锁规则，甚至是其他任何数据库的加锁规则，需要具备以下的一些知识点：</p>
<p>&nbsp;</p>
<ul>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">了解数据库的一些基本理论知识：数据的存储格式 (堆组织表 vs 聚簇索引表)；并发控制协议 (MVCC vs Lock-Based CC)；Two-Phase Locking；数据库的隔离级别定义 (Isolation Level)；<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">了解SQL本身的执行计划 (主键扫描 vs 唯一键扫描 vs 范围扫描 vs 全表扫描)；<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">了解数据库本身的一些实现细节 (过滤条件提取；Index Condition Pushdown；Semi-Consistent Read)；<br>
</span></div>
</li>
<li>
<div style="text-align: justify;"><span style="font-size: 10pt;">了解死锁产生的原因及分析的方法 (加锁顺序不一致；分析每个SQL的加锁顺序)<br>
</span></div>
</li>
</ul>
<p>&nbsp;</p>
<p>有了这些知识点，再加上适当的实战经验，全面掌控MySQL/InnoDB的加锁规则，当不在话下。</p>
		<div class="fixed"></div>
					<div class="tags">标签: <a href="http://hedengcheng.com/?tag=database" rel="tag">Database</a>, <a href="http://hedengcheng.com/?tag=deadlock" rel="tag">Deadlock</a>, <a href="http://hedengcheng.com/?tag=lock" rel="tag">Lock</a>, <a href="http://hedengcheng.com/?tag=1-2" rel="tag">MySQL</a></div>
			</div>
</div>

<!-- related posts -->

<div id="postnavi">
	<span class="alignleft floatleft"><a href="http://hedengcheng.com/?p=803" rel="next">并发编程系列之一：锁的意义</a></span>
	<span class="alignright floatright"><a href="http://hedengcheng.com/?p=725" rel="prev">C/C++ Volatile关键词深度剖析</a></span>
	<div class="fixed"></div>
</div>

<script type="text/javascript" src="./何登成的技术博客 » MySQL 加锁处理分析_files/comment.js.下载"></script>



	<ol class="commentlist">
			<li id="comment-5331" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/5243556ac88e6c4427cfe95d0a073306.png" srcset="http://2.gravatar.com/avatar/5243556ac88e6c4427cfe95d0a073306?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5331">
				
				七月流火
									</span>
								<div class="date">12月 13th, 201313:13</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5331#respond" onclick="return addComment.moveForm( &quot;comment-5331&quot;, &quot;5331&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给七月流火">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5331&#39;, &#39;comment-5331&#39;, &#39;commentbody-5331&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5331">#1</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5331">
					<p>何大师，咨询个优化器的问题。select * from a,b group by a.name是先驱动表group by再join，还是先join再group by？我看几乎所有执行计划里都是前者，profile也看不出什么。何大师麻烦从源码角度解释下！多谢了！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5336" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/095f70e48952367b7c561b797a479601.png" srcset="http://0.gravatar.com/avatar/095f70e48952367b7c561b797a479601?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5336">
				
				catmonkeyxu
									</span>
								<div class="date">12月 13th, 201315:21</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5336#respond" onclick="return addComment.moveForm( &quot;comment-5336&quot;, &quot;5336&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给catmonkeyxu">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5336&#39;, &#39;comment-5336&#39;, &#39;commentbody-5336&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5336">#2</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5336">
					<p>是否因为group后再join，能够降低中间结果数量？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5332" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/deb257d789695bc2c6a4c958dd97279c.jpeg" srcset="http://1.gravatar.com/avatar/deb257d789695bc2c6a4c958dd97279c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5332">
				
				Rex
									</span>
								<div class="date">12月 13th, 201313:41</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5332#respond" onclick="return addComment.moveForm( &quot;comment-5332&quot;, &quot;5332&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Rex">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5332&#39;, &#39;comment-5332&#39;, &#39;commentbody-5332&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5332">#3</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5332">
					<p>难得的数据库技术文章，对Mysql innodb事务与锁介绍的全面透彻。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5333" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d5ff06c37591e1e3a9648a56366dc7cf.png" srcset="http://1.gravatar.com/avatar/d5ff06c37591e1e3a9648a56366dc7cf?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-5333" href="http://firefall.cc/rokr" rel="external nofollow">
				
				ROKR
									</a>
								<div class="date">12月 13th, 201313:48</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5333#respond" onclick="return addComment.moveForm( &quot;comment-5333&quot;, &quot;5333&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ROKR">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5333&#39;, &#39;comment-5333&#39;, &#39;commentbody-5333&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5333">#4</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5333">
					<p>目前还用不上，但是介意我转载下么？以后学习可能有用</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5334" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5334">
				
				hedengcheng
									</span>
								<div class="date">12月 13th, 201314:41</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5334#respond" onclick="return addComment.moveForm( &quot;comment-5334&quot;, &quot;5334&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5334&#39;, &#39;comment-5334&#39;, &#39;commentbody-5334&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5334">#5</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5334">
					<p>转载，请标明下出处吧。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-344499" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/cb73719203039cf383a435a13a689588.png" srcset="http://0.gravatar.com/avatar/cb73719203039cf383a435a13a689588?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-344499">
				
				hhkb4
									</span>
								<div class="date">6月 8th, 201619:51</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=344499#respond" onclick="return addComment.moveForm( &quot;comment-344499&quot;, &quot;344499&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hhkb4">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-344499&#39;, &#39;comment-344499&#39;, &#39;commentbody-344499&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-344499">#6</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-344499">
					<p>讲的很通透，借用来给科普下，</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5335" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/99ec2bba825b5a0f91b7b5039e1a0738.png" srcset="http://0.gravatar.com/avatar/99ec2bba825b5a0f91b7b5039e1a0738?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5335">
				
				dukope
									</span>
								<div class="date">12月 13th, 201314:50</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5335#respond" onclick="return addComment.moveForm( &quot;comment-5335&quot;, &quot;5335&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给dukope">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5335&#39;, &#39;comment-5335&#39;, &#39;commentbody-5335&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5335">#7</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5335">
					<p>深入潜出，nice!</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5339" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/6105109843ae0882d864153ff633ffb3.png" srcset="http://0.gravatar.com/avatar/6105109843ae0882d864153ff633ffb3?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-5339" href="http://gpfeng.com/" rel="external nofollow">
				
				gpfeng
									</a>
								<div class="date">12月 13th, 201323:23</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5339#respond" onclick="return addComment.moveForm( &quot;comment-5339&quot;, &quot;5339&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给gpfeng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5339&#39;, &#39;comment-5339&#39;, &#39;commentbody-5339&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5339">#8</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5339">
					<p>可以针对insert专门出一篇，顺便介绍下隐式缩</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5350" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5350">
				
				hedengcheng
									</span>
								<div class="date">12月 15th, 201317:08</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5350#respond" onclick="return addComment.moveForm( &quot;comment-5350&quot;, &quot;5350&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5350&#39;, &#39;comment-5350&#39;, &#39;commentbody-5350&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5350">#9</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5350">
					<p>这个建议，可以考虑。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-166886" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/c034473547300b2a9336484fc1bc70c4.png" srcset="http://0.gravatar.com/avatar/c034473547300b2a9336484fc1bc70c4?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-166886">
				
				and1
									</span>
								<div class="date">1月 6th, 201521:00</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=166886#respond" onclick="return addComment.moveForm( &quot;comment-166886&quot;, &quot;166886&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给and1">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-166886&#39;, &#39;comment-166886&#39;, &#39;commentbody-166886&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-166886">#10</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-166886">
					<p>求大师 出一篇insert加锁的文章</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5341" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/fc3be57c2daf7d7b2ca70ccddc2f88a9.png" srcset="http://0.gravatar.com/avatar/fc3be57c2daf7d7b2ca70ccddc2f88a9?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5341">
				
				lyxing
									</span>
								<div class="date">12月 14th, 201311:09</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5341#respond" onclick="return addComment.moveForm( &quot;comment-5341&quot;, &quot;5341&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给lyxing">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5341&#39;, &#39;comment-5341&#39;, &#39;commentbody-5341&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5341">#11</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5341">
					<p>当前读，读取的是记录的最新版本，并且，当前读返回的记录，都会加上锁，保证其他事务不会再并发修改这条记录。</p>
<p>mysql正常关闭时，undo的脏块会写入datafile，undo会被释放吧？重启后，数据第一次被读取到buffer，此时应该是从datafile直接读取，应该为当前读吧？上锁？<br>
可能我理解有误，请登成师解读下！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5351" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5351">
				
				hedengcheng
									</span>
								<div class="date">12月 15th, 201317:10</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5351#respond" onclick="return addComment.moveForm( &quot;comment-5351&quot;, &quot;5351&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5351&#39;, &#39;comment-5351&#39;, &#39;commentbody-5351&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5351">#12</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5351">
					<p>最新版本，必须保证是已经提交的一致版本，你说的情况，如果事物已提交，就读取。如果事务未提交，则通过undo回滚。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5357" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/fc3be57c2daf7d7b2ca70ccddc2f88a9.png" srcset="http://0.gravatar.com/avatar/fc3be57c2daf7d7b2ca70ccddc2f88a9?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5357">
				
				lyxing
									</span>
								<div class="date">12月 15th, 201321:13</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5357#respond" onclick="return addComment.moveForm( &quot;comment-5357&quot;, &quot;5357&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给lyxing">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5357&#39;, &#39;comment-5357&#39;, &#39;commentbody-5357&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5357">#13</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5357">
					<p>假如已经提交，那么我觉得应该是当前读，这应该不上锁。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5342" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4f31bdbeac2305c40f70e15dae16c9fe.png" srcset="http://1.gravatar.com/avatar/4f31bdbeac2305c40f70e15dae16c9fe?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5342">
				
				WenlongMeng
									</span>
								<div class="date">12月 14th, 201312:17</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5342#respond" onclick="return addComment.moveForm( &quot;comment-5342&quot;, &quot;5342&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给WenlongMeng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5342&#39;, &#39;comment-5342&#39;, &#39;commentbody-5342&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5342">#14</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5342">
					<p>“在读多些少的OLTP应用中” =&gt; “在读多写少的OLTP应用中”</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5352" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5352">
				
				hedengcheng
									</span>
								<div class="date">12月 15th, 201317:11</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5352#respond" onclick="return addComment.moveForm( &quot;comment-5352&quot;, &quot;5352&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5352&#39;, &#39;comment-5352&#39;, &#39;commentbody-5352&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5352">#15</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5352">
					<p>谢谢指正。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5343" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/c9cc3ebf1dbd655b6ff0fb79aab4d1b3.png" srcset="http://0.gravatar.com/avatar/c9cc3ebf1dbd655b6ff0fb79aab4d1b3?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5343">
				
				fuyou001
									</span>
								<div class="date">12月 14th, 201316:15</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5343#respond" onclick="return addComment.moveForm( &quot;comment-5343&quot;, &quot;5343&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给fuyou001">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5343&#39;, &#39;comment-5343&#39;, &#39;commentbody-5343&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5343">#16</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5343">
					<p>请问聚簇索引上所有的记录，都被加上了X锁。无论记录是否满足条件，全部被加上X锁。这个锁的效果和表锁有什么区别？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5353" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5353">
				
				hedengcheng
									</span>
								<div class="date">12月 15th, 201317:13</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5353#respond" onclick="return addComment.moveForm( &quot;comment-5353&quot;, &quot;5353&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5353&#39;, &#39;comment-5353&#39;, &#39;commentbody-5353&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5353">#17</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5353">
					<p>rc隔离级别下，有区别，记录仍旧可以插入。rr下，功能上无区别。但是innodb不会主动升级表锁。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-236878" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/a9454afec460605659999e1a75b60fce.png" srcset="http://1.gravatar.com/avatar/a9454afec460605659999e1a75b60fce?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-236878">
				
				ZoneJ
									</span>
								<div class="date">6月 16th, 201510:59</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=236878#respond" onclick="return addComment.moveForm( &quot;comment-236878&quot;, &quot;236878&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ZoneJ">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-236878&#39;, &#39;comment-236878&#39;, &#39;commentbody-236878&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-236878">#18</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-236878">
					<p>有个select的问题，select * from t1 where id=1 for update。这种情况对于组合1的加锁情况是怎样的？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-236879" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/a9454afec460605659999e1a75b60fce.png" srcset="http://1.gravatar.com/avatar/a9454afec460605659999e1a75b60fce?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-236879">
				
				ZoneJ
									</span>
								<div class="date">6月 16th, 201511:00</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=236879#respond" onclick="return addComment.moveForm( &quot;comment-236879&quot;, &quot;236879&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ZoneJ">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-236879&#39;, &#39;comment-236879&#39;, &#39;commentbody-236879&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-236879">#19</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-236879">
					<p>有个select的问题，select * from t1 where id&gt;=1  and id &lt;=10 for update。这种情况对于组合1的加锁情况是怎样的？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-300163" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/16ea7e72de9c97cebd7d718783e407f1.png" srcset="http://1.gravatar.com/avatar/16ea7e72de9c97cebd7d718783e407f1?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-300163">
				
				steven
									</span>
								<div class="date">1月 27th, 201609:27</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=300163#respond" onclick="return addComment.moveForm( &quot;comment-300163&quot;, &quot;300163&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给steven">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-300163&#39;, &#39;comment-300163&#39;, &#39;commentbody-300163&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-300163">#20</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-300163">
					<p>在rc级别下,由于没有间隙锁,因此可以插入.<br>
在rr级别下,由于有间隙锁,因此不能插入.<br>
对吧?<br>
但是什么时候,会触发表锁呢?</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5344" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/21a630b654a521998b65d21d9c77ebaa.png" srcset="http://2.gravatar.com/avatar/21a630b654a521998b65d21d9c77ebaa?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5344">
				
				ken
									</span>
								<div class="date">12月 14th, 201317:23</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5344#respond" onclick="return addComment.moveForm( &quot;comment-5344&quot;, &quot;5344&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ken">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5344&#39;, &#39;comment-5344&#39;, &#39;commentbody-5344&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5344">#21</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5344">
					<p>非常感谢你的分享，受益匪浅：） 我们也用MYSQL，只是简单的insert ，select，但数据量大，30T数据。只用myisam存的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5345" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d62c48a2699e6b08cd6651083465cf70.png" srcset="http://1.gravatar.com/avatar/d62c48a2699e6b08cd6651083465cf70?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5345">
				
				东青
									</span>
								<div class="date">12月 14th, 201322:28</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5345#respond" onclick="return addComment.moveForm( &quot;comment-5345&quot;, &quot;5345&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给东青">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5345&#39;, &#39;comment-5345&#39;, &#39;commentbody-5345&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5345">#22</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5345">
					<p>何大师留的思考题，测试过了，select for update 使用排他锁时，gap 锁是会生效的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5349" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d62c48a2699e6b08cd6651083465cf70.png" srcset="http://1.gravatar.com/avatar/d62c48a2699e6b08cd6651083465cf70?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5349">
				
				东青
									</span>
								<div class="date">12月 15th, 201312:28</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5349#respond" onclick="return addComment.moveForm( &quot;comment-5349&quot;, &quot;5349&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给东青">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5349&#39;, &#39;comment-5349&#39;, &#39;commentbody-5349&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5349">#23</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5349">
					<p>有一个关于死锁检测的问题，想请教一下 。<br>
我在Mac Os 10.8版本下用了mysql  Ver 14.14 Distrib 5.1.71, for apple-darwin12.0.0 (i386）这个版本的mysql做了一个死锁检测实验。</p>
<p>表结构如下:<br>
+——-+————-+——+—–+———+——-+<br>
| Field | Type        | Null | Key | Default | Extra |<br>
+——-+————-+——+—–+———+——-+<br>
| id    | int(11)     | NO   | PRI | NULL    |       |<br>
| name  | varchar(10) | NO   |     | NULL    |       |<br>
+——-+————-+——+—–+———+——-+</p>
<p>我的事务隔离级别是repeatable-read.<br>
现在表里面有两条记录：<br>
+—-+——+<br>
| id | name |<br>
+—-+——+<br>
|  1 | new  |<br>
|  4 | new  |<br>
+—-+——+</p>
<p>—————-实验1:——————————-<br>
事务1：<br>
begin;<br>
select * from t where id =1 for update;</p>
<p>                                                                    事务2：<br>
                                                                     begin;<br>
                                                                     update t set name =’d’ where id =4 ; </p>
<p>事务1：<br>
update t set name=’d’ where id= 4;<br>
(被Hold住）<br>
                                                                    事务2：<br>
                                                                      update t set name =’d’ where id =1;</p>
<p>事务1 此时被检测到死锁，被重启事务了。<br>
ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</p>
<p>但是我做了另外一个测试：<br>
—————–实验2————————<br>
事务1：<br>
begin<br>
select * from t where id =1  for update<br>
                                                                         事务2：<br>
                                                                          begin<br>
                                                                          select * from t where id =4  for update; </p>
<p>事务1：<br>
 update t set name =’d’ where id =4;<br>
  （被阻塞了）<br>
                                                                        事务2：<br>
                                                                         update t set name =’d’ where id =1;<br>
                                                                        ERROR 1213 (40001): Deadlock …. （后面错误省略）</p>
<p>我想问的是，两个测试，mysql都检测到了死锁，为什么实验1中由事务2触发死锁，重启的是事务1；<br>
但是实验2 中，事务2触发死锁，重启的却是事务2。  mysql在检测到死锁以后，重启的事务的依据是什么呢？<br>
有什么好的死锁检测工具能推荐一下么？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5355" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5355">
				
				hedengcheng
									</span>
								<div class="date">12月 15th, 201318:21</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5355#respond" onclick="return addComment.moveForm( &quot;comment-5355&quot;, &quot;5355&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5355&#39;, &#39;comment-5355&#39;, &#39;commentbody-5355&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5355">#24</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5355">
					<p>简单来说，mysql的死锁检测到之后，会选择一个事务进行回滚。而选择的依据：看哪个事务的权重最小，事务权重的计算方法：事务加的锁最少；事务写的日志最少；事务开启的时间最晚。实验1，事务2写了日志，事务1没有，回滚事务1。实验2，都没写日志，但是事务1开始的早，回滚事务2。</p>
<p>死锁检测工具，目前我也不知道有什么好工具。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-279309" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/49ade21b14846e41684616c6e7209db3.jpeg" srcset="http://1.gravatar.com/avatar/49ade21b14846e41684616c6e7209db3?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-279309">
				
				chinaxing
									</span>
								<div class="date">11月 10th, 201514:22</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=279309#respond" onclick="return addComment.moveForm( &quot;comment-279309&quot;, &quot;279309&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给chinaxing">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-279309&#39;, &#39;comment-279309&#39;, &#39;commentbody-279309&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-279309">#25</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-279309">
					<p>事务被重启的操作，会报给应用程序吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5356" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/5981d676509cae32a2e4d7abbed80817.png" srcset="http://2.gravatar.com/avatar/5981d676509cae32a2e4d7abbed80817?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5356">
				
				东青
									</span>
								<div class="date">12月 15th, 201321:04</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5356#respond" onclick="return addComment.moveForm( &quot;comment-5356&quot;, &quot;5356&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给东青">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5356&#39;, &#39;comment-5356&#39;, &#39;commentbody-5356&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5356">#26</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5356">
					<p>谢谢回复，还会一如既往的关注你的技术文章的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5358" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/10696cce9d7c47fd5fee9e43e5e5ed76.png" srcset="http://1.gravatar.com/avatar/10696cce9d7c47fd5fee9e43e5e5ed76?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5358">
				
				hongbin
									</span>
								<div class="date">12月 16th, 201312:15</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5358#respond" onclick="return addComment.moveForm( &quot;comment-5358&quot;, &quot;5358&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hongbin">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5358&#39;, &#39;comment-5358&#39;, &#39;commentbody-5358&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5358">#27</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5358">
					<p>看了你的分析，对MySQL加锁的知识又有了新的认识。非常感谢。<br>
第二种死锁情况，为何不锁[20,100]?<br>
最后总结处的知识点，能否给出一些参考链接或书籍，供深入学习，谢谢！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5359" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5359">
				
				hedengcheng
									</span>
								<div class="date">12月 16th, 201312:52</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5359#respond" onclick="return addComment.moveForm( &quot;comment-5359&quot;, &quot;5359&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5359&#39;, &#39;comment-5359&#39;, &#39;commentbody-5359&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5359">#28</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5359">
					<p>[20,100]也要加锁的，只是跟死锁无关，因此忽略了。</p>
<p>我考虑，添加一些参考资料，不过最好的资料，还是MySQL的源码。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5360" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/ed3384d85b14eff5eebbd8fe4f717b16.png" srcset="http://2.gravatar.com/avatar/ed3384d85b14eff5eebbd8fe4f717b16?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5360">
				
				获思
									</span>
								<div class="date">12月 16th, 201314:01</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5360#respond" onclick="return addComment.moveForm( &quot;comment-5360&quot;, &quot;5360&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给获思">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5360&#39;, &#39;comment-5360&#39;, &#39;commentbody-5360&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5360">#29</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5360">
					<p>非常好</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5364" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/2530aa7c330c1f6498d27b95d3f6d1da.png" srcset="http://2.gravatar.com/avatar/2530aa7c330c1f6498d27b95d3f6d1da?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5364">
				
				jackwu
									</span>
								<div class="date">12月 18th, 201310:20</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5364#respond" onclick="return addComment.moveForm( &quot;comment-5364&quot;, &quot;5364&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给jackwu">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5364&#39;, &#39;comment-5364&#39;, &#39;commentbody-5364&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5364">#30</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5364">
					<p>分析很详细，学习了。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5365" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/542e9c1cc7f8f10142468d78c890ba5b.png" srcset="http://2.gravatar.com/avatar/542e9c1cc7f8f10142468d78c890ba5b?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5365">
				
				benpaorun
									</span>
								<div class="date">12月 18th, 201311:12</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5365#respond" onclick="return addComment.moveForm( &quot;comment-5365&quot;, &quot;5365&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给benpaorun">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5365&#39;, &#39;comment-5365&#39;, &#39;commentbody-5365&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5365">#31</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5365">
					<p>最近刚好碰到了一个死锁问题，看了您这篇文章，收获颇多<br>
但我碰到死锁的表是用的联合主键，想问下mysql的联合主键是如何建立索引的？<br>
如果是建立两个非唯一索引，然后在MySQL Server层面验证主键唯一性的话，似乎无法解释我遇到的死锁问题<br>
求教mysql联合主键的索引机制，谢谢啦！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5371" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5371">
				
				hedengcheng
									</span>
								<div class="date">12月 19th, 201309:22</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5371#respond" onclick="return addComment.moveForm( &quot;comment-5371&quot;, &quot;5371&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5371&#39;, &#39;comment-5371&#39;, &#39;commentbody-5371&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5371">#32</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5371">
					<p>联合主键，跟单一主键一模一样，没有区别。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5376" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/542e9c1cc7f8f10142468d78c890ba5b.png" srcset="http://2.gravatar.com/avatar/542e9c1cc7f8f10142468d78c890ba5b?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5376">
				
				benpaorun
									</span>
								<div class="date">12月 19th, 201317:53</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5376#respond" onclick="return addComment.moveForm( &quot;comment-5376&quot;, &quot;5376&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给benpaorun">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5376&#39;, &#39;comment-5376&#39;, &#39;commentbody-5376&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5376">#33</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5376">
					<p>不理解联合主键和单一主键一模一样啥意思，具体问题简化如下：<br>
表结构为：<br>
CREAT TABLE ‘t_gs_config’ {<br>
     ‘serverId” int(11),<br>
     ‘activityId’ int(11),<br>
     ‘name’ varchar(255),<br>
     PRIMARY KEY(`serverId`, `activityId`)<br>
} ENGINE=InnoDB DEFAULT CHARSET=utf8;<br>
用的是联合主键serverId和activityId。<br>
猜测当时场景，表t_gs_config的内容为<br>
serverId    activityId    name<br>
41               40                  s11<br>
42               40                  s22<br>
43               40                  s13<br>
75               45                   s75<br>
76               45                  s76<br>
77               45                  s77<br>
session1:<br>
      delete from t_gs_config where activityId=37;<br>
session2:<br>
      insert into t_gs_config (name, activityId, serverId) values (‘s70’, 44, 70);<br>
      insert into t_gs_config (name, activityId, serverId) values (‘s71’, 44, 71);<br>
      insert into t_gs_config (name, activityId, serverId) values (‘s72’, 44, 72); </p>
<p>我的理解是，在RR情况下<br>
session1会在activityId的索引表上加一个gap锁，session2会在activityId和serverId的索引表上分别加一个gap锁，不会发生死锁啊<br>
但实际情况是，死锁了。。。回滚了session1</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5380" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5380">
				
				hedengcheng
									</span>
								<div class="date">12月 20th, 201309:30</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5380#respond" onclick="return addComment.moveForm( &quot;comment-5380&quot;, &quot;5380&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5380&#39;, &#39;comment-5380&#39;, &#39;commentbody-5380&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5380">#34</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5380">
					<p>一模一样的意思，就是都是只有一个主键索引。只是一个主键只有一个列，一个有两个列。基本知识，建议先学习些数据库基础。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5384" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/542e9c1cc7f8f10142468d78c890ba5b.png" srcset="http://2.gravatar.com/avatar/542e9c1cc7f8f10142468d78c890ba5b?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5384">
				
				benpaorun
									</span>
								<div class="date">12月 20th, 201311:39</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5384&#39;, &#39;comment-5384&#39;, &#39;commentbody-5384&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5384">#35</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5384">
					<p>确实对数据库基础知识不熟悉，囧<br>
联合主键只有一个主键索引<br>
所以session1中的delete操作的约束条件只有一列，所以相当于组合8的情况，无索引，走的全表扫描，session2中的insert操作把包含了联合主键两列数据，所以相当于组合5的情况，依次加gap锁<br>
这样就能解释通了。。。谢谢啦！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5389" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5389">
				
				hedengcheng
									</span>
								<div class="date">12月 21st, 201318:26</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5389&#39;, &#39;comment-5389&#39;, &#39;commentbody-5389&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5389">#36</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5389">
					<p>呵呵，这就是我这篇文章期待达到的效果。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5592" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/69219d6195639e319862387f26ac6425.png" srcset="http://0.gravatar.com/avatar/69219d6195639e319862387f26ac6425?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5592">
				
				evergreen
									</span>
								<div class="date">1月 27th, 201412:50</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5592#respond" onclick="return addComment.moveForm( &quot;comment-5592&quot;, &quot;5592&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给evergreen">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5592&#39;, &#39;comment-5592&#39;, &#39;commentbody-5592&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5592">#37</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5592">
					<p>应该不会死锁吧，我做实验了，只会锁等待</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5593" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5593">
				
				hedengcheng
									</span>
								<div class="date">1月 27th, 201414:00</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5593&#39;, &#39;comment-5593&#39;, &#39;commentbody-5593&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5593">#38</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5593">
					<p>什么测试？针对什么场景？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5598" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/69219d6195639e319862387f26ac6425.png" srcset="http://0.gravatar.com/avatar/69219d6195639e319862387f26ac6425?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5598">
				
				evergreen
									</span>
								<div class="date">1月 27th, 201417:47</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5598&#39;, &#39;comment-5598&#39;, &#39;commentbody-5598&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5598">#39</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5598">
					<p>用的是和benpaorun一样的数据做的，执行sql的顺序也是一样的，发现只会锁等待。<br>
按照博文来的分析的话，我觉得锁等待也比较合理</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5367" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/3c0e5688d0bb9c2a02f2056cc7c8cd0a.png" srcset="http://0.gravatar.com/avatar/3c0e5688d0bb9c2a02f2056cc7c8cd0a?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5367">
				
				wyh
									</span>
								<div class="date">12月 18th, 201313:44</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5367#respond" onclick="return addComment.moveForm( &quot;comment-5367&quot;, &quot;5367&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给wyh">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5367&#39;, &#39;comment-5367&#39;, &#39;commentbody-5367&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5367">#40</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5367">
					<p>您好， 看了您的文章后，我立即分析了一下我遭遇到的死锁， 想请教您一下。 </p>
<p>Isolation-level: Read-Committed<br>
Table t(id primary key, status key, uuid)</p>
<p>SQL:<br>
update t set uuid=”uuid” where status = 1 limit 50;</p>
<p>这条sql 是多进程执行的， 也就是可能有两个 worker 在同时执行这条 SQL. 根据您的讲解， 因为status 不是 unique key ，所以会针对 status =1 的所有记录全部加锁, 并且 对应的 id 也会全部锁上； 如果有两个进程在同时操作，这就会导致 deadlock 吗？ 两个进程加锁的顺序应当是一致的啊， 也会出现死锁吗？ 还是有可能不一致？</p>
<p>另外，这里的 limit 50 应当和锁没有关系吧，还是说只找 50 条进行加锁呢？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5372" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5372">
				
				hedengcheng
									</span>
								<div class="date">12月 19th, 201309:24</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5372#respond" onclick="return addComment.moveForm( &quot;comment-5372&quot;, &quot;5372&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5372&#39;, &#39;comment-5372&#39;, &#39;commentbody-5372&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5372">#41</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5372">
					<p>仅仅是这一条sql，加锁顺序是一致的，不会产生死锁。除非还有其他sql参与。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5373" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5373">
				
				hedengcheng
									</span>
								<div class="date">12月 19th, 201309:24</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5373#respond" onclick="return addComment.moveForm( &quot;comment-5373&quot;, &quot;5373&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5373&#39;, &#39;comment-5373&#39;, &#39;commentbody-5373&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5373">#42</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5373">
					<p>还需要关注一下，这条sql走的是索引，还是全表扫描？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5377" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/3c0e5688d0bb9c2a02f2056cc7c8cd0a.png" srcset="http://0.gravatar.com/avatar/3c0e5688d0bb9c2a02f2056cc7c8cd0a?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5377">
				
				wyh
									</span>
								<div class="date">12月 19th, 201321:42</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5377#respond" onclick="return addComment.moveForm( &quot;comment-5377&quot;, &quot;5377&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给wyh">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5377&#39;, &#39;comment-5377&#39;, &#39;commentbody-5377&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5377">#43</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5377">
					<p>应当是 索引吧， status 字段是有索引的，这样不会全表扫描吧。 </p>
<p>另外， 这里有 limit 50 是锁 50 条还是满足条件的都锁上呢？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5381" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5381">
				
				hedengcheng
									</span>
								<div class="date">12月 20th, 201309:31</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5381#respond" onclick="return addComment.moveForm( &quot;comment-5381&quot;, &quot;5381&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5381&#39;, &#39;comment-5381&#39;, &#39;commentbody-5381&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5381">#44</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5381">
					<p>有索引，没说就不会走全表扫描。有执行计划，有查询优化，有代价估算。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5375" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/39138a2955db4bce79db6d3e44c955a7.png" srcset="http://0.gravatar.com/avatar/39138a2955db4bce79db6d3e44c955a7?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5375">
				
				yesi
									</span>
								<div class="date">12月 19th, 201317:50</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5375#respond" onclick="return addComment.moveForm( &quot;comment-5375&quot;, &quot;5375&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给yesi">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5375&#39;, &#39;comment-5375&#39;, &#39;commentbody-5375&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5375">#45</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5375">
					<p>delete from  table1 where id in (1,2,3,4,5) ，id是主键，RR级别，这样会加GAP锁吗</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5382" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5382">
				
				hedengcheng
									</span>
								<div class="date">12月 20th, 201309:32</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5382#respond" onclick="return addComment.moveForm( &quot;comment-5382&quot;, &quot;5382&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5382&#39;, &#39;comment-5382&#39;, &#39;commentbody-5382&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5382">#46</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5382">
					<p>你可以把这条sql，拆为5条id = 的sql来分析。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5395" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4171bebffeea2fba5a6f4e7b16bc917c.png" srcset="http://1.gravatar.com/avatar/4171bebffeea2fba5a6f4e7b16bc917c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-5395" href="http://oceanbase.org.cn/" rel="external nofollow">
				
				郁白
									</a>
								<div class="date">12月 23rd, 201314:22</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5395#respond" onclick="return addComment.moveForm( &quot;comment-5395&quot;, &quot;5395&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给郁白">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5395&#39;, &#39;comment-5395&#39;, &#39;commentbody-5395&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5395">#47</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5395">
					<p>在RC隔离级别下，索引表是否可以不加锁，而是在对数据表执行操作的时候执行double check，比如delete from t1 where id = 10; 在操作数据表的时候，检查索引列id是否还是10，如果不是就跳过</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5396" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/1266b27c7caa11495698618a5db58cb4.png" srcset="http://1.gravatar.com/avatar/1266b27c7caa11495698618a5db58cb4?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-5396" href="http://weibo.com/chenyechao/home?wvr=5" rel="external nofollow">
				
				Seven
									</a>
								<div class="date">12月 23rd, 201314:28</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5396#respond" onclick="return addComment.moveForm( &quot;comment-5396&quot;, &quot;5396&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Seven">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5396&#39;, &#39;comment-5396&#39;, &#39;commentbody-5396&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5396">#48</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5396">
					<p>深入浅出，讲得特别好，继续关注博主的博客和微博</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5424" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8bde618d5cc992aaef9aeb0099371c15.png" srcset="http://2.gravatar.com/avatar/8bde618d5cc992aaef9aeb0099371c15?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5424">
				
				KingPoker
									</span>
								<div class="date">12月 24th, 201322:26</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5424#respond" onclick="return addComment.moveForm( &quot;comment-5424&quot;, &quot;5424&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给KingPoker">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5424&#39;, &#39;comment-5424&#39;, &#39;commentbody-5424&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5424">#49</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5424">
					<p>组合七：id非唯一索引+RR<br>
比如一个Session A执行了delete from t1 where id = 10;会加两个锁，X锁和Gap锁<br>
Session B要执行什么样的sql？？才可以在Innodb_locks查看到Gap锁，还是说Gap锁在Innodb_locks就是表现为X锁？试过几种sql:<br>
delete from t1 where id =10;<br>
delete from t1 where name =’b’;<br>
update  t1 set id =111 where name =’b’;</p>
<p>请指教，谢谢！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5425" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8bde618d5cc992aaef9aeb0099371c15.png" srcset="http://2.gravatar.com/avatar/8bde618d5cc992aaef9aeb0099371c15?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5425">
				
				KingPoker
									</span>
								<div class="date">12月 24th, 201323:04</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5425#respond" onclick="return addComment.moveForm( &quot;comment-5425&quot;, &quot;5425&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给KingPoker">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5425&#39;, &#39;comment-5425&#39;, &#39;commentbody-5425&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5425">#50</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5425">
					<p><a href="http://www.mysqlperformanceblog.com/2012/03/27/innodbs-gap-locks/" rel="nofollow">http://www.mysqlperformanceblog.com/2012/03/27/innodbs-gap-locks/</a><br>
看完这个post知道了<br>
Session B中执行insert into t1(name,id) values(‘ddd’,6);<br>
可以查看到Gap锁</p>
<p>建议解释的时候能举个具体的sql例子，这样有图看文章还可以自己测试一把（对于不是很懂得人很有帮助），这样可以更好理解</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5440" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5440">
				
				hedengcheng
									</span>
								<div class="date">12月 25th, 201312:13</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5440#respond" onclick="return addComment.moveForm( &quot;comment-5440&quot;, &quot;5440&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5440&#39;, &#39;comment-5440&#39;, &#39;commentbody-5440&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5440">#51</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5440">
					<p>gap锁不是x锁，是两种不同的类型。关于你给的这个链接，组合七就很好的解释了这个问题。<br>
gap锁的功能，就是锁住此锁对应的区域，不可新插入数据。</p>
<p>当然，你的建议不错，以后会注意新加一些例子。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5444" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8bde618d5cc992aaef9aeb0099371c15.png" srcset="http://2.gravatar.com/avatar/8bde618d5cc992aaef9aeb0099371c15?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-5444" href="http://weibo.com/jjduan" rel="external nofollow">
				
				KingPoker
									</a>
								<div class="date">12月 25th, 201315:39</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5444#respond" onclick="return addComment.moveForm( &quot;comment-5444&quot;, &quot;5444&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给KingPoker">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5444&#39;, &#39;comment-5444&#39;, &#39;commentbody-5444&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5444">#52</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5444">
					<p>只是个人建议，你文章写得很好，思路非常清晰，看着就想动手试试，看看效果</p>
<p>对应这个Gap锁有一点不是很明白，比如举得的例子，删除Id【等于】10，那为什么要锁住相邻的区域。<br>
你列举的数据，是不能插入id为6到11的数据，不在这个范围可以正常插入。<br>
在删除【等于】的情况下，Gap锁的区域范围是怎么限定了？是相邻的两个数（【6】，【11】）之间就不让插入？</p>
<p>删除【大于】【小于】10锁定范围还是很好理解。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5457" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5457">
				
				hedengcheng
									</span>
								<div class="date">12月 26th, 201313:02</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5457#respond" onclick="return addComment.moveForm( &quot;comment-5457&quot;, &quot;5457&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5457&#39;, &#39;comment-5457&#39;, &#39;commentbody-5457&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5457">#53</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5457">
					<p>gap锁的目的，只要把握一点：就是让后续不能插入满足条件的新纪录，然后按照这个点，去考虑哪些地方需要加gap锁。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5433" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/11ae2cfbdcffd415dd61ee9b3e043cb2.png" srcset="http://1.gravatar.com/avatar/11ae2cfbdcffd415dd61ee9b3e043cb2?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5433">
				
				李大玉
									</span>
								<div class="date">12月 25th, 201310:59</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5433#respond" onclick="return addComment.moveForm( &quot;comment-5433&quot;, &quot;5433&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给李大玉">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5433&#39;, &#39;comment-5433&#39;, &#39;commentbody-5433&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5433">#54</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5433">
					<p>能认真写这么多文字出来 还这么专业   不容易！！！！ 没有几个小时搞不定，学mysql的国人有福气啊</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5461" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/5243556ac88e6c4427cfe95d0a073306.png" srcset="http://2.gravatar.com/avatar/5243556ac88e6c4427cfe95d0a073306?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5461">
				
				七月流火
									</span>
								<div class="date">12月 26th, 201316:40</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5461#respond" onclick="return addComment.moveForm( &quot;comment-5461&quot;, &quot;5461&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给七月流火">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5461&#39;, &#39;comment-5461&#39;, &#39;commentbody-5461&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5461">#55</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5461">
					<p>关于组合七最后留的那个问题，（流火工程师）来解答下，此时会对不存在的间隙加上gap锁，比如表中已有id=1,2,3,6，那么select where id=4 for update会锁住(3,6)之间所有的间隙包括小数如3.1,3.2,5.999等，并且在show innodb status里面显示锁住的行为hex 80000006，只显示这一行信息。其他间隙如7,8,9不会锁的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5470" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5470">
				
				hedengcheng
									</span>
								<div class="date">12月 26th, 201321:15</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5470#respond" onclick="return addComment.moveForm( &quot;comment-5470&quot;, &quot;5470&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5470&#39;, &#39;comment-5470&#39;, &#39;commentbody-5470&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5470">#56</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5470">
					<p>锁住间隙是对的，但是表述上有所不当。其实间隙是一个连续范围，例如你这里说的(3, 6)范围，就是一个连续范围，这个范围中的所有插入，均被禁止了。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5463" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-5463" href="http://hedengcheng.com/?p=828" rel="external nofollow">
				
				2013年个人微博推荐技术资料汇总 | 何登成的技术博客
									</a>
								<div class="date">12月 26th, 201316:42</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-5463">#57</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5467" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/6718aa2316196e68cefdf5fd09f3c177.png" srcset="http://0.gravatar.com/avatar/6718aa2316196e68cefdf5fd09f3c177?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5467">
				
				ontheway
									</span>
								<div class="date">12月 26th, 201318:08</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5467#respond" onclick="return addComment.moveForm( &quot;comment-5467&quot;, &quot;5467&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ontheway">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5467&#39;, &#39;comment-5467&#39;, &#39;commentbody-5467&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5467">#58</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5467">
					<p>弱弱地问一句，我看的书里面都说的是RR隔离级别不允许脏读和不可重复读，但是可以幻读，怎么和作者说的不一样呢？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5468" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5468">
				
				hedengcheng
									</span>
								<div class="date">12月 26th, 201321:10</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5468#respond" onclick="return addComment.moveForm( &quot;comment-5468&quot;, &quot;5468&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5468&#39;, &#39;comment-5468&#39;, &#39;commentbody-5468&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5468">#59</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5468">
					<p>你说的没错，因此我在文章一开始，就强调了这一点。mysql innodb引擎的实现，跟标准有所不同。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5540" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/84bd896a2ff5947f7b32d71247748088.png" srcset="http://2.gravatar.com/avatar/84bd896a2ff5947f7b32d71247748088?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5540">
				
				笨笨爱琳琳
									</span>
								<div class="date">1月 21st, 201419:48</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5540#respond" onclick="return addComment.moveForm( &quot;comment-5540&quot;, &quot;5540&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给笨笨爱琳琳">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5540&#39;, &#39;comment-5540&#39;, &#39;commentbody-5540&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5540">#60</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5540">
					<p>这正是我这两天最大的困惑！<br>
一般大家提到Serializable才会来解决幻读的问题，RR只是解决不可重复读+脏读的问题。或者说，很多描述下，不可重复读有时候只是针对某条已经存在的记录，有时候是针对某个给定的条件。这么一看，确实明白了，Innodb的实现，与ISO定义的隔离级别及其解决问题的范围，是不一致的！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5542" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5542">
				
				hedengcheng
									</span>
								<div class="date">1月 22nd, 201409:37</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5542#respond" onclick="return addComment.moveForm( &quot;comment-5542&quot;, &quot;5542&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5542&#39;, &#39;comment-5542&#39;, &#39;commentbody-5542&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5542">#61</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5542">
					<p>嗯，是的。InnoDB在这个处理上，比较奇葩…</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5575" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/84bd896a2ff5947f7b32d71247748088.png" srcset="http://2.gravatar.com/avatar/84bd896a2ff5947f7b32d71247748088?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5575">
				
				笨笨爱琳琳
									</span>
								<div class="date">1月 24th, 201413:26</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5575&#39;, &#39;comment-5575&#39;, &#39;commentbody-5575&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5575">#62</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5575">
					<p>这问题应该算“奇葩”，还是算innodb做得更好？或者是对于“不可重复读”的理解和实现不一致？当然我不知道我理解的四层隔离级别及其对应处理的问题，是否和ANSI/ISO定义的是一致（希望回答一下）。我看其他博客中解释mysql（应该就是指InnoDB）的RR，解决了“幻读”问题。</p>
<p>既然RR解决了“幻读”的问题，那么在mysql中，Serializable级别，应该解决哪些其他的问题呢？</p>
<p>谢谢。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-328274" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/a4809ca625ee551fcef02f00129cddff.jpeg" srcset="http://1.gravatar.com/avatar/a4809ca625ee551fcef02f00129cddff?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-328274" href="http://yhzhtk.info/" rel="external nofollow">
				
				Yhzhtk
									</a>
								<div class="date">4月 14th, 201612:25</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=328274#respond" onclick="return addComment.moveForm( &quot;comment-328274&quot;, &quot;328274&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Yhzhtk">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-328274&#39;, &#39;comment-328274&#39;, &#39;commentbody-328274&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-328274">#63</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-328274">
					<p><a href="https://dev.mysql.com/doc/refman/5.6/en/set-transaction.html#isolevel_repeatable-read" rel="nofollow">https://dev.mysql.com/doc/refman/5.6/en/set-transaction.html#isolevel_repeatable-read</a></p>
<p>For locking reads (SELECT with FOR UPDATE or LOCK IN SHARE MODE), UPDATE, and DELETE statements, locking depends on whether the statement uses a unique index with a unique search condition, or a range-type search condition. For a unique index with a unique search condition, InnoDB locks only the index record found, not the gap before it. For other search conditions, InnoDB locks the index range scanned, using gap locks or next-key locks to block insertions by other sessions into the gaps covered by the range.</p>
<p>官方的解释，RR级别时，如果查询是个范围，会加 gap locks 或者 next-key。 但是我不太确定是否会有例外，仍然不能避免幻读。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5473" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-5473" href="http://www.sentangle.com/136.html" rel="external nofollow">
				
				(转)MySQL 加锁处理分析 | 幽静的麦田_临沂php程序员
									</a>
								<div class="date">12月 27th, 201314:27</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-5473">#64</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5518" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/63772160aad196a6c2558a6c1fa7a4a5.png" srcset="http://0.gravatar.com/avatar/63772160aad196a6c2558a6c1fa7a4a5?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5518">
				
				joey
									</span>
								<div class="date">1月 10th, 201413:06</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5518#respond" onclick="return addComment.moveForm( &quot;comment-5518&quot;, &quot;5518&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给joey">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5518&#39;, &#39;comment-5518&#39;, &#39;commentbody-5518&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5518">#65</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5518">
					<p>您好，能不能介绍一下 insert into … select…from… 中 select 的 加锁方式？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5522" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5522">
				
				hedengcheng
									</span>
								<div class="date">1月 13th, 201409:53</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5522#respond" onclick="return addComment.moveForm( &quot;comment-5522&quot;, &quot;5522&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5522&#39;, &#39;comment-5522&#39;, &#39;commentbody-5522&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5522">#66</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5522">
					<p>insert into … select … from …中的select，会对表加读锁(更确切的说，应该是对表中所有的记录加读锁)，因此，select的操作，是一个当前读。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-257483" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/a15ee270097c14cf9ba5287a8c2ba2c1.png" srcset="http://1.gravatar.com/avatar/a15ee270097c14cf9ba5287a8c2ba2c1?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-257483">
				
				SeanSoong
									</span>
								<div class="date">8月 13th, 201517:18</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=257483#respond" onclick="return addComment.moveForm( &quot;comment-257483&quot;, &quot;257483&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给SeanSoong">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-257483&#39;, &#39;comment-257483&#39;, &#39;commentbody-257483&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-257483">#67</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-257483">
					<p>这个为什么要锁所有记录呢？不是可以MVCC实现多版本读吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5524" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/6718aa2316196e68cefdf5fd09f3c177.png" srcset="http://0.gravatar.com/avatar/6718aa2316196e68cefdf5fd09f3c177?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5524">
				
				ontheway
									</span>
								<div class="date">1月 13th, 201415:23</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5524#respond" onclick="return addComment.moveForm( &quot;comment-5524&quot;, &quot;5524&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ontheway">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5524&#39;, &#39;comment-5524&#39;, &#39;commentbody-5524&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5524">#68</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5524">
					<p>问题：如果组合五、组合六下，针对SQL：select * from t1 where id = 10 for update; 第一次查询，没有找到满足查询条件的记录，那么GAP锁是否还能够省略？<br>
这个问题我在RR隔离级别下试过，感觉很奇怪，事务1执行select * from t1 where id = 10 for update; 后，事务2就不能插入insert id为10 的记录，说明是加了GAP锁，但是事务2也可以执行 select * from t1 where id = 10 for update;，这个时候事务1和事务2貌似都有id=10的GAP锁，2个事务都不能执行insert id=10的记录，会报死锁异常。给我的感觉就像是此时拿到的GAP锁不是一个排他锁，像是一个共享锁。作者能不能详细说明下这块。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5526" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5526">
				
				hedengcheng
									</span>
								<div class="date">1月 14th, 201409:28</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5526#respond" onclick="return addComment.moveForm( &quot;comment-5526&quot;, &quot;5526&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5526&#39;, &#39;comment-5526&#39;, &#39;commentbody-5526&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5526">#69</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5526">
					<p>gap锁本身的作用是防止后续的插入操作，因此gap锁只跟插入相冲突，gap锁之间不冲突，就会发生你这提到的情况。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5586" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/6718aa2316196e68cefdf5fd09f3c177.png" srcset="http://0.gravatar.com/avatar/6718aa2316196e68cefdf5fd09f3c177?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5586">
				
				ontheway
									</span>
								<div class="date">1月 26th, 201415:03</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5586#respond" onclick="return addComment.moveForm( &quot;comment-5586&quot;, &quot;5586&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ontheway">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5586&#39;, &#39;comment-5586&#39;, &#39;commentbody-5586&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5586">#70</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5586">
					<p>我下去针对GAP锁冲突做了如下测试，感觉GAP锁之间是有冲突，测试情况如下：<br>
&gt;&gt;表article数据如下：<br>
+——-+————-+<br>
| id     |   name  |<br>
+——-+————-+<br>
| 1      | title1     |<br>
+——-+————-+<br>
| 2      | title2    |<br>
+——-+————-+<br>
| 3      | title3    |<br>
+——-+————-+<br>
| 9      | title9    |<br>
+——-+————-+<br>
| 10    | title10  |<br>
+——-+————-+</p>
<p>分别开2个mysql窗口模拟2个事务，设置autocommit=0，然后分别执行如下语句：<br>
select * from article where [] for update;<br>
+—————————-+——————-+——————-+——————-+————————-+<br>
|                                 | id=6             | id6            | id&gt;5 and id&lt;7 |<br>
+—————————-+——————-+——————-+——————-+————————-+<br>
| id=6                       | 不冲突          | 不冲突          | 不冲突         | 不冲突                 |<br>
+—————————-+——————-+——————-+——————-+————————-+<br>
| id6                       | 不冲突          | 冲突              | 冲突             | 冲突                     |<br>
+—————————-+——————-+——————-+——————-+————————-+<br>
| id&gt;5 and id5 and id&lt;7的时候也是加GAP锁，但是二个事务就会冲突，<br>
这是什么原因？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5587" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/6718aa2316196e68cefdf5fd09f3c177.png" srcset="http://0.gravatar.com/avatar/6718aa2316196e68cefdf5fd09f3c177?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5587">
				
				ontheway
									</span>
								<div class="date">1月 26th, 201415:21</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5587#respond" onclick="return addComment.moveForm( &quot;comment-5587&quot;, &quot;5587&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给ontheway">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5587&#39;, &#39;comment-5587&#39;, &#39;commentbody-5587&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5587">#71</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5587">
					<p>上面的内容被转码了，直接看图片吧，http://pan.baidu.com/s/1i34xAst</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5590" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5590">
				
				hedengcheng
									</span>
								<div class="date">1月 27th, 201411:03</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5590#respond" onclick="return addComment.moveForm( &quot;comment-5590&quot;, &quot;5590&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5590&#39;, &#39;comment-5590&#39;, &#39;commentbody-5590&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5590">#72</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5590">
					<p>你这个问题真的很好，也指出了我文中的一点小问题。</p>
<p>按照原理来说，id&gt;5 and id&lt;7这个查询条件，在表中找不到满足条件的项，因此会对第一个不满足条件的项(id = 9)上加GAP锁，防止后续其他事务插入满足条件的记录。</p>
<p>而GAP锁与GAP锁是不冲突的，那么为什么两个同时执行id&gt;5 and id&lt;7查询的事务会冲突呢？</p>
<p>原因在于，MySQL Server并没有将id&lt;7这个查询条件下降到InnoDB引擎层，因此InnoDB看到的查询，是id&gt;5，正向扫描。读出的记录id=9，先加上next key锁(Lock X + GAP lock)，然后返回给MySQL Server进行判断。<br>
MySQL Server此时才会判断返回的记录是否满足id&lt;7的查询条件。此处不满足，查询结束。</p>
<p>因此，id=9记录上，真正持有的锁是next key锁，而next key锁之间是相互冲突的，这也说明了为什么两个id&gt;5 and id&lt;7查询的事务会冲突的原因。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5597" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/69219d6195639e319862387f26ac6425.png" srcset="http://0.gravatar.com/avatar/69219d6195639e319862387f26ac6425?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5597">
				
				evergreen
									</span>
								<div class="date">1月 27th, 201417:22</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5597&#39;, &#39;comment-5597&#39;, &#39;commentbody-5597&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5597">#73</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5597">
					<p>id&gt;6为何会与id&lt;6冲突，一个间隙为(3, positive infinity)一个为(negative infinity, 9)；但是间隙锁不会冲突的啊</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5599" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5599">
				
				hedengcheng
									</span>
								<div class="date">1月 27th, 201418:31</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5599&#39;, &#39;comment-5599&#39;, &#39;commentbody-5599&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5599">#74</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5599">
					<p>看我给ontheway的回复。查询过程中，不是只加间隙锁，而是加next key，next key是会冲突的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5536" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8c040b5af86cbdba3488b6a0810f2156.png" srcset="http://2.gravatar.com/avatar/8c040b5af86cbdba3488b6a0810f2156?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5536">
				
				周波
									</span>
								<div class="date">1月 20th, 201415:35</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5536#respond" onclick="return addComment.moveForm( &quot;comment-5536&quot;, &quot;5536&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给周波">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5536&#39;, &#39;comment-5536&#39;, &#39;commentbody-5536&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5536">#75</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5536">
					<p>关于MySQL的锁有些地方没搞清楚<br>
1. 意向锁的作用<br>
SELECT  … FOR UPDATE 会锁住选中的行，和直接对那些行加X锁有什么区别？<br>
2. S和X锁什么时候加？<br>
     在RR级别下的SELECT好像不会加S锁，但是会加X锁。那什么时候会加S锁呢？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5537" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8c040b5af86cbdba3488b6a0810f2156.png" srcset="http://2.gravatar.com/avatar/8c040b5af86cbdba3488b6a0810f2156?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5537">
				
				周波
									</span>
								<div class="date">1月 20th, 201415:59</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5537#respond" onclick="return addComment.moveForm( &quot;comment-5537&quot;, &quot;5537&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给周波">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5537&#39;, &#39;comment-5537&#39;, &#39;commentbody-5537&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5537">#76</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5537">
					<p>补充一下，在网上找到一些资料说Intention lock 是表级锁，但是我这边试下来，在RR级别下是next key lock，并不会锁住整张表。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5543" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5543">
				
				hedengcheng
									</span>
								<div class="date">1月 22nd, 201409:38</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5543#respond" onclick="return addComment.moveForm( &quot;comment-5543&quot;, &quot;5543&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5543&#39;, &#39;comment-5543&#39;, &#39;commentbody-5543&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5543">#77</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5543">
					<p>谁说Intention Lock是表级锁？谁写的？拉出去突突了。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-73584" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/b6076d7560b29859c43201837279fcb3.png" srcset="http://2.gravatar.com/avatar/b6076d7560b29859c43201837279fcb3?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-73584">
				
				now
									</span>
								<div class="date">9月 30th, 201415:14</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=73584#respond" onclick="return addComment.moveForm( &quot;comment-73584&quot;, &quot;73584&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给now">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-73584&#39;, &#39;comment-73584&#39;, &#39;commentbody-73584&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-73584">#78</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-73584">
					<p>Intention Lock是用在哪个级别上的？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5544" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5544">
				
				hedengcheng
									</span>
								<div class="date">1月 22nd, 201409:39</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5544#respond" onclick="return addComment.moveForm( &quot;comment-5544&quot;, &quot;5544&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5544&#39;, &#39;comment-5544&#39;, &#39;commentbody-5544&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5544">#79</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5544">
					<p>看你这些问题，我真不知道如何回答，感觉你对锁的理解，比较混乱。至于第二点，select lock in share mode; 会加S锁。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5547" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8c040b5af86cbdba3488b6a0810f2156.png" srcset="http://2.gravatar.com/avatar/8c040b5af86cbdba3488b6a0810f2156?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5547">
				
				周波
									</span>
								<div class="date">1月 22nd, 201414:57</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5547#respond" onclick="return addComment.moveForm( &quot;comment-5547&quot;, &quot;5547&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给周波">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5547&#39;, &#39;comment-5547&#39;, &#39;commentbody-5547&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5547">#80</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5547">
					<p>我理解的select lock in share mode会加IS锁，select for update会加IX锁。<br>
所以我没搞清楚IX锁和X锁，他们的区别在哪里。都是对一些记录加锁。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5558" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5558">
				
				hedengcheng
									</span>
								<div class="date">1月 23rd, 201409:48</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5558#respond" onclick="return addComment.moveForm( &quot;comment-5558&quot;, &quot;5558&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5558&#39;, &#39;comment-5558&#39;, &#39;commentbody-5558&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5558">#81</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5558">
					<p>建议去看一些锁相关的基础文章，你这些理解，都是有问题的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5545" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/84bd896a2ff5947f7b32d71247748088.png" srcset="http://2.gravatar.com/avatar/84bd896a2ff5947f7b32d71247748088?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5545">
				
				笨笨爱琳琳
									</span>
								<div class="date">1月 22nd, 201410:08</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5545#respond" onclick="return addComment.moveForm( &quot;comment-5545&quot;, &quot;5545&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给笨笨爱琳琳">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5545&#39;, &#39;comment-5545&#39;, &#39;commentbody-5545&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5545">#82</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5545">
					<p>登博，帮你搞了一个净版的pdf，见：http://yun.baidu.com/share/link?shareid=3229086908&amp;uk=4146200807#dir/path=%2F%E5%85%A8%E5%B1%80%E5%85%B1%E4%BA%AB</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5557" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5557">
				
				hedengcheng
									</span>
								<div class="date">1月 23rd, 201409:47</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5557#respond" onclick="return addComment.moveForm( &quot;comment-5557&quot;, &quot;5557&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5557&#39;, &#39;comment-5557&#39;, &#39;commentbody-5557&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5557">#83</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5557">
					<p>🙂</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5549" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4c3bea0a838f58554b7ff06aea0b0418.png" srcset="http://1.gravatar.com/avatar/4c3bea0a838f58554b7ff06aea0b0418?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5549">
				
				润洁
									</span>
								<div class="date">1月 22nd, 201421:37</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5549#respond" onclick="return addComment.moveForm( &quot;comment-5549&quot;, &quot;5549&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给润洁">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5549&#39;, &#39;comment-5549&#39;, &#39;commentbody-5549&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5549">#84</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5549">
					<p>理论上不应该出现死锁的死锁，请帮忙诊断一下吧，多谢！<br>
场景：<br>
    两个或多个事务同时删除同一条记录，使用的条件是一个唯一索引的值，但不是主键。<br>
表结构：<br>
    CREATE TABLE dltask (<br>
        id  bigint unsigned NOT NULL AUTO_INCREMENT COMMENT ‘auto id’,<br>
        a   varchar(30)     NOT NULL                COMMENT ‘uniq.a’,<br>
        b   varchar(30)     NOT NULL                COMMENT ‘uniq.b’,<br>
        c   varchar(30)     NOT NULL                COMMENT ‘uniq.c’,<br>
        x   varchar(30)     NOT NULL                COMMENT ‘data’,<br>
        PRIMARY KEY (id),<br>
        UNIQUE KEY uniq_a_b_c (a, b, c)<br>
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=’deadlock test’;<br>
事务隔离级别：<br>
    REPEATABLE READ<br>
事务内仅有的一条SQL语句：<br>
    delete from dltask where a=? and b=? and c=?;</p>
<p>5.5.20 版本的死锁日志：<br>
————————<br>
LATEST DETECTED DEADLOCK<br>
————————<br>
140122 18:11:58<br>
*** (1) TRANSACTION:<br>
TRANSACTION 930F9, ACTIVE 0 sec starting index read<br>
mysql tables in use 1, locked 1<br>
LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)<br>
MySQL thread id 2096, OS thread handle 0x7f3570976700, query id 1485879 localhost 127.0.0.1 rj updating<br>
delete from dltask where a=’b’ and b=’b’ and c=’a’<br>
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>
RECORD LOCKS space id 0 page no 12713 n bits 96 index `uniq_a_b_c` of table `dltst`.`dltask` trx id 930F9 lock_mode X waiting<br>
*** (2) TRANSACTION:<br>
TRANSACTION 930F3, ACTIVE 0 sec starting index read<br>
mysql tables in use 1, locked 1<br>
3 lock struct(s), heap size 376, 2 row lock(s)<br>
MySQL thread id 2101, OS thread handle 0x7f3573d88700, query id 1485872 localhost 127.0.0.1 rj updating<br>
delete from dltask where a=’b’ and b=’b’ and c=’a’<br>
*** (2) HOLDS THE LOCK(S):<br>
RECORD LOCKS space id 0 page no 12713 n bits 96 index `uniq_a_b_c` of table `dltst`.`dltask` trx id 930F3 lock_mode X locks rec but not gap<br>
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>
RECORD LOCKS space id 0 page no 12713 n bits 96 index `uniq_a_b_c` of table `dltst`.`dltask` trx id 930F3 lock_mode X waiting<br>
*** WE ROLL BACK TRANSACTION (1)</p>
<p>5.6.15 版本的死锁日志：<br>
————————<br>
LATEST DETECTED DEADLOCK<br>
————————<br>
2014-01-22 20:48:08 7f4248516700<br>
*** (1) TRANSACTION:<br>
TRANSACTION 2268, ACTIVE 0 sec starting index read<br>
mysql tables in use 1, locked 1<br>
LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)<br>
MySQL thread id 11, OS thread handle 0x7f4248494700, query id 1207 localhost 127.0.0.1 rj updating<br>
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>
RECORD LOCKS space id 6 page no 4 n bits 96 index `uniq_a_b_c` of table `dltst`.`dltask` trx id 2268 lock_mode X locks rec but not gap waiting<br>
*** (2) TRANSACTION:<br>
TRANSACTION 2271, ACTIVE 0 sec starting index read<br>
mysql tables in use 1, locked 1<br>
3 lock struct(s), heap size 376, 2 row lock(s)<br>
MySQL thread id 9, OS thread handle 0x7f4248516700, query id 1208 localhost 127.0.0.1 rj updating<br>
delete from dltask where a=’b’ and b=’a’ and c=’c’<br>
*** (2) HOLDS THE LOCK(S):<br>
RECORD LOCKS space id 6 page no 4 n bits 96 index `uniq_a_b_c` of table `dltst`.`dltask` trx id 2271 lock_mode X locks rec but not gap<br>
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>
RECORD LOCKS space id 6 page no 4 n bits 96 index `uniq_a_b_c` of table `dltst`.`dltask` trx id 2271 lock_mode X waiting<br>
*** WE ROLL BACK TRANSACTION (1)</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5560" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5560">
				
				hedengcheng
									</span>
								<div class="date">1月 23rd, 201411:21</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5560#respond" onclick="return addComment.moveForm( &quot;comment-5560&quot;, &quot;5560&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5560&#39;, &#39;comment-5560&#39;, &#39;commentbody-5560&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5560">#85</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5560">
					<p>几个问题：<br>
1. 此问题重现频率如何，高不？</p>
<p>2. 确定每个事务都只有一条delete语句？</p>
<p>3. 确定delete走的是uniq_a_b_c索引？</p>
<p>4. 针对delete from dltask where a=’b’ and b=’b’ and c=’a’删除操作，表中有没有找到对应的记录？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5561" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4c3bea0a838f58554b7ff06aea0b0418.png" srcset="http://1.gravatar.com/avatar/4c3bea0a838f58554b7ff06aea0b0418?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5561">
				
				润洁
									</span>
								<div class="date">1月 23rd, 201412:52</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5561#respond" onclick="return addComment.moveForm( &quot;comment-5561&quot;, &quot;5561&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给润洁">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5561&#39;, &#39;comment-5561&#39;, &#39;commentbody-5561&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5561">#86</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5561">
					<p>1. 线上主要的机率不高，毕竟不同请求会操作同一条记录的机率很小，操作同一条的情况出现死锁的就更小一些，因为总有个时机问题嘛。但确实偶尔就出现。<br>
　　这里发出来的，是针对线上问题做的一个完全等价的模拟，模拟程序提高了多个线程删除同一条记录的机率，所以死锁就特别多。<br>
2. 确定只有这一条delete语句。<br>
3. 用 explain select * from dltask where a=? and b=? and c=? 看，是走了这个唯一索引的。<br>
4. 线上的，相应的记录在表中不一定存在，但等价的模拟程序里，相应的记录在删除之前，在表中肯定是存在的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5562" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4c3bea0a838f58554b7ff06aea0b0418.png" srcset="http://1.gravatar.com/avatar/4c3bea0a838f58554b7ff06aea0b0418?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5562">
				
				润洁
									</span>
								<div class="date">1月 23rd, 201412:53</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5562#respond" onclick="return addComment.moveForm( &quot;comment-5562&quot;, &quot;5562&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给润洁">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5562&#39;, &#39;comment-5562&#39;, &#39;commentbody-5562&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5562">#87</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5562">
					<p>不好意思，错字了：<br>
1. 线上主要的机率不高　-&gt; 线上出现的机率不高</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5563" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5563">
				
				hedengcheng
									</span>
								<div class="date">1月 23rd, 201416:11</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5563&#39;, &#39;comment-5563&#39;, &#39;commentbody-5563&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5563">#88</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5563">
					<p>是AutoCommit吗？还是有begin commit？ 有测试脚本不？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5564" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5564">
				
				hedengcheng
									</span>
								<div class="date">1月 23rd, 201418:31</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5564&#39;, &#39;comment-5564&#39;, &#39;commentbody-5564&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5564">#89</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5564">
					<p>我对这个问题很感兴趣，有其他联系方式吗？讨论下。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5565" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4c3bea0a838f58554b7ff06aea0b0418.png" srcset="http://1.gravatar.com/avatar/4c3bea0a838f58554b7ff06aea0b0418?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5565">
				
				润洁
									</span>
								<div class="date">1月 23rd, 201419:07</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5565#respond" onclick="return addComment.moveForm( &quot;comment-5565&quot;, &quot;5565&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给润洁">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5565&#39;, &#39;comment-5565&#39;, &#39;commentbody-5565&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5565">#90</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5565">
					<p>AutoCommit 无影响，true 或者 false 效果都一样。<br>
是Java程序，模拟程序也同样是用Java写的，如果您觉得有必要使用这个测试程序，就往我邮箱里发个消息吧，我用附件的形式把测试的程序发给您。<br>
我很佩服您对问题的分析，透彻清晰有条理，所以才把这个问题发上来的，如果觉得有必要，我可以在回邮件的时候带上电话。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5566" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5566">
				
				hedengcheng
									</span>
								<div class="date">1月 23rd, 201419:10</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5566#respond" onclick="return addComment.moveForm( &quot;comment-5566&quot;, &quot;5566&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5566&#39;, &#39;comment-5566&#39;, &#39;commentbody-5566&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5566">#91</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5566">
					<p>这个问题有点颠覆了我对InnoDB锁实现的认识，因此一定要搞清楚，我给你发邮件，可以的话，把测试程序给我看一下吧。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5570" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4c3bea0a838f58554b7ff06aea0b0418.png" srcset="http://1.gravatar.com/avatar/4c3bea0a838f58554b7ff06aea0b0418?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5570">
				
				润洁
									</span>
								<div class="date">1月 23rd, 201422:25</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5570#respond" onclick="return addComment.moveForm( &quot;comment-5570&quot;, &quot;5570&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给润洁">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5570&#39;, &#39;comment-5570&#39;, &#39;commentbody-5570&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5570">#92</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5570">
					<p>邮件已发，谢谢！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5569" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5569">
				
				hedengcheng
									</span>
								<div class="date">1月 23rd, 201420:08</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5569#respond" onclick="return addComment.moveForm( &quot;comment-5569&quot;, &quot;5569&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5569&#39;, &#39;comment-5569&#39;, &#39;commentbody-5569&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5569">#93</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5569">
					<p>我大概知道原因了，明天再确认下。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5571" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4c3bea0a838f58554b7ff06aea0b0418.png" srcset="http://1.gravatar.com/avatar/4c3bea0a838f58554b7ff06aea0b0418?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5571">
				
				润洁
									</span>
								<div class="date">1月 23rd, 201422:27</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5571#respond" onclick="return addComment.moveForm( &quot;comment-5571&quot;, &quot;5571&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给润洁">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5571&#39;, &#39;comment-5571&#39;, &#39;commentbody-5571&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5571">#94</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5571">
					<p>静侯佳音</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5591" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5591">
				
				hedengcheng
									</span>
								<div class="date">1月 27th, 201411:04</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5591#respond" onclick="return addComment.moveForm( &quot;comment-5591&quot;, &quot;5591&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5591&#39;, &#39;comment-5591&#39;, &#39;commentbody-5591&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5591">#95</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5591">
					<p>可见我最新博文的分析：《一个最不可思议的MySQL死锁分析》 <a href="http://hedengcheng.com/?p=844" rel="nofollow">http://hedengcheng.com/?p=844</a></p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5578" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-5578" href="http://hedengcheng.com/?p=844" rel="external nofollow">
				
				一个最不可思议的MySQL死锁分析 | 何登成的技术博客
									</a>
								<div class="date">1月 24th, 201415:54</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-5578">#96</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5588" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-5588" href="http://guanmian.net/?p=2555" rel="external nofollow">
				
				MySQL 加锁处理分析 | Steve Guan
									</a>
								<div class="date">1月 26th, 201420:21</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-5588">#97</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5612" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/df0f8401a7ce1cc83ef9b5bffc13075f.png" srcset="http://1.gravatar.com/avatar/df0f8401a7ce1cc83ef9b5bffc13075f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5612">
				
				taowei
									</span>
								<div class="date">2月 4th, 201421:06</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5612#respond" onclick="return addComment.moveForm( &quot;comment-5612&quot;, &quot;5612&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给taowei">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5612&#39;, &#39;comment-5612&#39;, &#39;commentbody-5612&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5612">#98</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5612">
					<p>何大师，你写的很好啊，能否再细致些啊，比如在8种情况下 分别对二级索引和主键索引加了何种锁，比如第三种情况，对id 、 name 分别加的是哪一种锁？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5648" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/323acb1f3667a6c08dbcd71063692e00.png" srcset="http://0.gravatar.com/avatar/323acb1f3667a6c08dbcd71063692e00?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5648">
				
				peiyuc
									</span>
								<div class="date">2月 17th, 201421:56</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5648#respond" onclick="return addComment.moveForm( &quot;comment-5648&quot;, &quot;5648&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给peiyuc">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5648&#39;, &#39;comment-5648&#39;, &#39;commentbody-5648&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5648">#99</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5648">
					<p>在RR+非唯一索引的情况下，在两个事务中可以同时执行有共同gap锁区间的sql，是怎么回事呢？就是您所说的组合七中的例子，insert [10,aa]是可以执行的</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5650" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5650">
				
				hedengcheng
									</span>
								<div class="date">2月 18th, 201410:46</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5650#respond" onclick="return addComment.moveForm( &quot;comment-5650&quot;, &quot;5650&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5650&#39;, &#39;comment-5650&#39;, &#39;commentbody-5650&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5650">#100</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5650">
					<p>Gap lock之间是不相互冲突的。能举个例子吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5680" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8cde1134dd193a39bcc53ef3134882c7.png" srcset="http://2.gravatar.com/avatar/8cde1134dd193a39bcc53ef3134882c7?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5680">
				
				+01
									</span>
								<div class="date">2月 23rd, 201416:54</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5680#respond" onclick="return addComment.moveForm( &quot;comment-5680&quot;, &quot;5680&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给+01">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5680&#39;, &#39;comment-5680&#39;, &#39;commentbody-5680&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5680">#101</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5680">
					<p>大师，我有两个观点和您不同，请指正<br>
1.id非唯一索引，RR下，对所有满足条件的记录加next-key lock，这样可以保证每个记录之前不会插入幻读行，然后再最后一个满足条件的记录之后再加一个gap lock，防止尾部添加幻读行<br>
2.无索引的时候，我的理解是加表锁。因为任何写操作都要先申请写意向锁，意向锁是表锁，IX与表X是互斥的，这样可以做到表在加锁的时候不会被写入。虽然我没读过源码，但觉得如果把所有记录都加锁没有这个必要，意向锁的设计就是为了解决行锁和表锁冲突的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5682" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5682">
				
				hedengcheng
									</span>
								<div class="date">2月 24th, 201409:21</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5682#respond" onclick="return addComment.moveForm( &quot;comment-5682&quot;, &quot;5682&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5682&#39;, &#39;comment-5682&#39;, &#39;commentbody-5682&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5682">#102</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5682">
					<p>“意向锁的设计就是为了解决行锁和表锁冲突的”，原则性错误，建议再看一些锁相关的资料。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5684" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8cde1134dd193a39bcc53ef3134882c7.png" srcset="http://2.gravatar.com/avatar/8cde1134dd193a39bcc53ef3134882c7?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5684">
				
				+01
									</span>
								<div class="date">2月 24th, 201412:33</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5684#respond" onclick="return addComment.moveForm( &quot;comment-5684&quot;, &quot;5684&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给+01">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5684&#39;, &#39;comment-5684&#39;, &#39;commentbody-5684&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5684">#103</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5684">
					<p>这个只是我的个人理解，因为意向锁本身是表锁且意向锁之间没有冲突的，意向锁和行锁存在不兼容。如果意向锁不是在表被锁的时候阻止行锁的请求，那意向锁设计的意义是为了什么呢？。无索引的时候加表锁，这个理解是否有问题？如果是对所有记录加锁，那innodb是否在dml语句里就不会对表加锁呢？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5687" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5687">
				
				hedengcheng
									</span>
								<div class="date">2月 25th, 201409:38</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5687#respond" onclick="return addComment.moveForm( &quot;comment-5687&quot;, &quot;5687&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5687&#39;, &#39;comment-5687&#39;, &#39;commentbody-5687&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5687">#104</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5687">
					<p>“那innodb是否在dml语句里就不会对表加锁呢？”这个理解是对的，InnoDB在dml语句时，只会加表意向锁，不会加真正的表锁。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5688" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8cde1134dd193a39bcc53ef3134882c7.png" srcset="http://2.gravatar.com/avatar/8cde1134dd193a39bcc53ef3134882c7?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5688">
				
				+01
									</span>
								<div class="date">2月 25th, 201416:04</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5688&#39;, &#39;comment-5688&#39;, &#39;commentbody-5688&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5688">#105</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5688">
					<p>大师，我扔有疑问，据我了解，死锁有另一个原因：申请锁的数量太多。如果无索引的时候对每个记录都加锁，那是否会因为申请锁太多而导致死锁呢？我曾经在无索引的情况下更新过亿级别的表，没有造成死锁，我使用的mysql版本是5.1.63，innodb不是plugin的，和版本有关系吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5689" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5689">
				
				hedengcheng
									</span>
								<div class="date">2月 25th, 201418:46</div>
			</div>
			<div class="count">
																									<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5689&#39;, &#39;comment-5689&#39;, &#39;commentbody-5689&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5689">#106</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5689">
					<p>死锁的原因，就是两线程以上，加锁的顺序相反，跟锁数量多少没有任何关系。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-5782" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8f4af970aa099e39236a4883c91c3529.png" srcset="http://2.gravatar.com/avatar/8f4af970aa099e39236a4883c91c3529?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5782">
				
				randy.su
									</span>
								<div class="date">4月 17th, 201422:31</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5782#respond" onclick="return addComment.moveForm( &quot;comment-5782&quot;, &quot;5782&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给randy.su">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5782&#39;, &#39;comment-5782&#39;, &#39;commentbody-5782&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5782">#107</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5782">
					<p>大师好啊，我现在的情况是这样：多个进程对一张表t进行并发的批量更新操作，比如：update t set t.status=’0′ where t.id in (${ids})，表t没有主键，id有非唯一索引，其中${id}是逗号分隔的id串，比如：<br>
进程1：update t set t.status=’0′ where t.id in (1,3,5,7,9})<br>
进程2：update t set t.status=’0′ where t.id in (2,4,6,8,10})<br>
进程3：update t set t.status=’0′ where t.id in (11,12,13,14,15})<br>
进程4：….<br>
我们保证了各自进程查询出的记录是不会跟别的进程重复的，这样会发生死锁，为什么呢？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5783" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8f4af970aa099e39236a4883c91c3529.png" srcset="http://2.gravatar.com/avatar/8f4af970aa099e39236a4883c91c3529?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5783">
				
				randy.su
									</span>
								<div class="date">4月 17th, 201422:37</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5783#respond" onclick="return addComment.moveForm( &quot;comment-5783&quot;, &quot;5783&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给randy.su">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5783&#39;, &#39;comment-5783&#39;, &#39;commentbody-5783&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5783">#108</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5783">
					<blockquote cite="./何登成的技术博客 » MySQL 加锁处理分析_files/saved_resource"><p>
<strong><a href="http://hedengcheng.com/?p=771#comment-5782" rel="nofollow">randy.su</a> :</strong><br>
大师好啊，我现在的情况是这样：多个进程对一张表t进行并发的批量更新操作，比如：update t set t.status=’0′ where t.id in (${ids})，表t没有主键，id有非唯一索引，其中${id}是逗号分隔的id串，比如：<br>
进程1：update t set t.status=’0′ where t.id in (1,3,5,7,9})<br>
进程2：update t set t.status=’0′ where t.id in (2,4,6,8,10})<br>
进程3：update t set t.status=’0′ where t.id in (11,12,13,14,15})<br>
进程4：….<br>
我们保证了各自进程查询出的记录是不会跟别的进程重复的，这样会发生死锁，为什么呢？
</p></blockquote>
<p>进程1：update t set t.status=’0′ where t.id in (1,3,5,7,9)<br>
进程2：update t set t.status=’0′ where t.id in (2,4,6,8,10)<br>
进程3：update t set t.status=’0′ where t.id in (11,12,13,14,15)<br>
进程4：….</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-5785" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8f4af970aa099e39236a4883c91c3529.png" srcset="http://2.gravatar.com/avatar/8f4af970aa099e39236a4883c91c3529?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5785">
				
				randy.su
									</span>
								<div class="date">4月 18th, 201416:59</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5785#respond" onclick="return addComment.moveForm( &quot;comment-5785&quot;, &quot;5785&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给randy.su">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5785&#39;, &#39;comment-5785&#39;, &#39;commentbody-5785&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5785">#109</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5785">
					<blockquote cite="./何登成的技术博客 » MySQL 加锁处理分析_files/saved_resource(1)"><p>
<strong><a href="http://hedengcheng.com/?p=771#comment-5783" rel="nofollow">randy.su</a> :</strong></p>
<blockquote cite="./何登成的技术博客 » MySQL 加锁处理分析_files/saved_resource"><p>
<strong><a href="http://hedengcheng.com/?p=771#comment-5782" rel="nofollow">randy.su</a> :</strong><br>
大师好啊，我现在的情况是这样：多个进程对一张表t进行并发的批量更新操作，比如：update t set t.status=’0′ where t.id in (${ids})，表t没有主键，id有非唯一索引，其中${id}是逗号分隔的id串，比如：<br>
进程1：update t set t.status=’0′ where t.id in (1,3,5,7,9})<br>
进程2：update t set t.status=’0′ where t.id in (2,4,6,8,10})<br>
进程3：update t set t.status=’0′ where t.id in (11,12,13,14,15})<br>
进程4：….<br>
我们保证了各自进程查询出的记录是不会跟别的进程重复的，这样会发生死锁，为什么呢？
</p></blockquote>
<p>进程1：update t set t.status=’0′ where t.id in (1,3,5,7,9)<br>
进程2：update t set t.status=’0′ where t.id in (2,4,6,8,10)<br>
进程3：update t set t.status=’0′ where t.id in (11,12,13,14,15)<br>
进程4：….
</p></blockquote>
<p>上面讲错了，有主键，是另外一个字段，比如key，而id是具有非唯一性索引的字段。<br>
t表结构：<br>
CREATE TABLE `t` (<br>
  `key` bigint(20) NOT NULL AUTO_INCREMENT,<br>
  `id` bigint(20) DEFAULT NULL,<br>
  `name` varchar(60) DEFAULT NULL,<br>
  `createTime` datetime DEFAULT NULL,<br>
  PRIMARY KEY (`key`),<br>
  KEY `idx_id` (`id`)<br>
) ENGINE=InnoDB AUTO_INCREMENT=50000 DEFAULT CHARSET=utf8;</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-5802" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-5802">
				
				hedengcheng
									</span>
								<div class="date">4月 28th, 201409:09</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=5802#respond" onclick="return addComment.moveForm( &quot;comment-5802&quot;, &quot;5802&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-5802&#39;, &#39;comment-5802&#39;, &#39;commentbody-5802&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-5802">#110</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-5802">
					<p>这个无法保证不产生死锁，无论是rr还是rc隔离级别。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-11676" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/3974756f1fa8468ca36121b71d89ef97.png" srcset="http://0.gravatar.com/avatar/3974756f1fa8468ca36121b71d89ef97?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-11676" href="http://www.cnblogs.com/gomysql/" rel="external nofollow">
				
				Atlas
									</a>
								<div class="date">5月 20th, 201415:37</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=11676#respond" onclick="return addComment.moveForm( &quot;comment-11676&quot;, &quot;11676&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Atlas">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-11676&#39;, &#39;comment-11676&#39;, &#39;commentbody-11676&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-11676">#111</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-11676">
					<p>真心的好啊，深入浅出，纠正了我很多理解错误的地方。继续关注。继续膜拜</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-32171" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/704297761c837197a36fe149b7d30c2c.png" srcset="http://1.gravatar.com/avatar/704297761c837197a36fe149b7d30c2c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-32171">
				
				java文盲
									</span>
								<div class="date">7月 9th, 201418:45</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=32171#respond" onclick="return addComment.moveForm( &quot;comment-32171&quot;, &quot;32171&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给java文盲">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-32171&#39;, &#39;comment-32171&#39;, &#39;commentbody-32171&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-32171">#112</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-32171">
					<p>RECORD LOCKS space id 2523 page no 4 n bits 72 index `uid_itemType_itemId_uinque` of table `payment`.`test_dead_lock` trx id A41BEFA lock_mode X insert intention waiting</p>
<p>请问插入意向锁是不是不区分rr和rc，我之前理解的是插入意向锁属于gap锁 ，如果用rc不就相当于关掉gap锁了吗？那为什么rc级别下还会出现insert intention waiting。。。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-32666" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/ea605550f7ec5e91ae7d6a3ab1d26ace.png" srcset="http://2.gravatar.com/avatar/ea605550f7ec5e91ae7d6a3ab1d26ace?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-32666">
				
				大自在真人
									</span>
								<div class="date">7月 10th, 201422:42</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=32666#respond" onclick="return addComment.moveForm( &quot;comment-32666&quot;, &quot;32666&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给大自在真人">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-32666&#39;, &#39;comment-32666&#39;, &#39;commentbody-32666&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-32666">#113</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-32666">
					<p>遇到了相同的问题，死锁冲突，二级唯一索引上，单条inser语句事务。一个事务锁定 lock_mode X locks rec but not gap，然后请求lock_mode X locks gap before rec insert intention waiting，另一个insert语句 lock mode S waiting，所有的锁请求都是同一数据文件同一数据块的同一位置，然后第二个事务就因为死锁被杀掉了，很是奇怪，麻烦解说一下，谢谢。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-32794" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/ea605550f7ec5e91ae7d6a3ab1d26ace.png" srcset="http://2.gravatar.com/avatar/ea605550f7ec5e91ae7d6a3ab1d26ace?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-32794">
				
				大自在真人
									</span>
								<div class="date">7月 11th, 201406:05</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=32794#respond" onclick="return addComment.moveForm( &quot;comment-32794&quot;, &quot;32794&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给大自在真人">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-32794&#39;, &#39;comment-32794&#39;, &#39;commentbody-32794&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-32794">#114</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-32794">
					<p>表上有三个索引，主键索引，一个唯一索引，一个非唯一索引，但报告锁冲突的是唯一索引</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-37666" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d09aa9a7a703dd5429475f708ae41687.png" srcset="http://1.gravatar.com/avatar/d09aa9a7a703dd5429475f708ae41687?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-37666" href="http://www.cnblogs.com/lyhabc/" rel="external nofollow">
				
				桦仔
									</a>
								<div class="date">7月 23rd, 201417:23</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=37666#respond" onclick="return addComment.moveForm( &quot;comment-37666&quot;, &quot;37666&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给桦仔">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-37666&#39;, &#39;comment-37666&#39;, &#39;commentbody-37666&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-37666">#115</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-37666">
					<p>Intention lock 不一定是表级锁<br>
我个人理解是更大范围的锁，但不一定是表锁<br>
我从sqlserver转过来的<br>
<a href="http://www.cnblogs.com/shanksgao/p/3140149.html?ADUIN=1815357042&amp;ADSESSION=1405653123&amp;ADTAG=CLIENT.QQ.5335_.0&amp;ADPUBNO=26366" rel="nofollow">http://www.cnblogs.com/shanksgao/p/3140149.html?ADUIN=1815357042&amp;ADSESSION=1405653123&amp;ADTAG=CLIENT.QQ.5335_.0&amp;ADPUBNO=26366</a><br>
比如表做了分区，那么就是分区锁，虽然作用的对象在表上<br>
我从sqlserver转过来的</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-47902" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/2c9708e4c0b3d1b4dbcc883a953c2c8f.png" srcset="http://2.gravatar.com/avatar/2c9708e4c0b3d1b4dbcc883a953c2c8f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-47902">
				
				leezq
									</span>
								<div class="date">8月 11th, 201409:30</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=47902#respond" onclick="return addComment.moveForm( &quot;comment-47902&quot;, &quot;47902&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给leezq">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-47902&#39;, &#39;comment-47902&#39;, &#39;commentbody-47902&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-47902">#116</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-47902">
					<p>HI,博主，您好。有个地方没看懂，能否解释下。组合四：从图中可以看到，满足删除条件的记录有两条，但是，聚簇索引上所有的记录，都被加上了X锁。无论记录是否满足条件，全部被加上X锁。既不是加表锁，也不是在满足条件的记录上加行锁。  既然锁定了所有的聚簇索引的全部记录，这不就是表锁吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-214714" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-214714">
				
				hedengcheng
									</span>
								<div class="date">4月 13th, 201521:05</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=214714#respond" onclick="return addComment.moveForm( &quot;comment-214714&quot;, &quot;214714&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-214714&#39;, &#39;comment-214714&#39;, &#39;commentbody-214714&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-214714">#117</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-214714">
					<p>表锁就是真正的表锁，哪怕我把表中所有记录都加上了行锁，也不能说就是加上表锁了。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-65926" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/559861a5fe3514755df62326c3128ace.png" srcset="http://2.gravatar.com/avatar/559861a5fe3514755df62326c3128ace?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-65926">
				
				Beginning
									</span>
								<div class="date">9月 12th, 201418:16</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=65926#respond" onclick="return addComment.moveForm( &quot;comment-65926&quot;, &quot;65926&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Beginning">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-65926&#39;, &#39;comment-65926&#39;, &#39;commentbody-65926&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-65926">#118</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-65926">
					<p>登博，你好，有个问题想请教下，关于组合七中，会加gap lock，比如那里[6,c]和[10,b]之间加了gap锁，也就是说能够插入[6,a] 但是不能插入[6,d]，为何gap锁要这样加呢？在哪里能够查到gap锁范围这方面的资料？希望网易前同事能够指点下，嘿嘿</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-214716" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-214716">
				
				hedengcheng
									</span>
								<div class="date">4月 13th, 201521:06</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=214716#respond" onclick="return addComment.moveForm( &quot;comment-214716&quot;, &quot;214716&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-214716&#39;, &#39;comment-214716&#39;, &#39;commentbody-214716&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-214716">#119</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-214716">
					<p>gap锁范围，简单来说，就是锁当前记录和上一条记录之间的空白区域。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-116623" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/2d226debd081fd5754a6bdb02149cbc9.png" srcset="http://2.gravatar.com/avatar/2d226debd081fd5754a6bdb02149cbc9?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-116623">
				
				简
									</span>
								<div class="date">11月 12th, 201409:36</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=116623#respond" onclick="return addComment.moveForm( &quot;comment-116623&quot;, &quot;116623&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给简">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-116623&#39;, &#39;comment-116623&#39;, &#39;commentbody-116623&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-116623">#120</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-116623">
					<p>何博，我有这样一个问题，希望您能帮解答一下，问题如下：<br>
有这样一个存储过程，<br>
BEGIN<br>
	DECLARE myid INT DEFAULT 0;<br>
	DECLARE myname CHAR(50) DEFAULT ”;</p>
<p>	START TRANSACTION;</p>
<p>	SELECT * FROM test ORDER BY id LIMIT 1 FOR UPDATE;</p>
<p>	SELECT id,d INTO myid, myname FROM test2 WHERE c = 0.4 ORDER BY id LIMIT 1;</p>
<p>	UPDATE test2 SET c = 09 WHERE id = myid;</p>
<p>	INSERT test3(name) VALUES(myname);</p>
<p>	COMMIT;</p>
<p>END<br>
业务前提，test2中的d字段数据不重复，而test3中不能有test2中d字段的重复数据，如果在高并发下，发现test3有了test2字段d的重复数据，说明test2被两个session执行过，如果我在“SELECT id,d INTO myid, myname FROM test2 WHERE c = 0.4 ORDER BY id LIMIT 1;” 这句中加上for update确没有问题。在我的理解是，test1中使用了锁应该是处于竞争锁而等待，直到一个sp运行完才会释放锁，为什么会test2中的并发，麻烦您帮解答下</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-116627" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/2d226debd081fd5754a6bdb02149cbc9.png" srcset="http://2.gravatar.com/avatar/2d226debd081fd5754a6bdb02149cbc9?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-116627">
				
				简
									</span>
								<div class="date">11月 12th, 201409:39</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=116627#respond" onclick="return addComment.moveForm( &quot;comment-116627&quot;, &quot;116627&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给简">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-116627&#39;, &#39;comment-116627&#39;, &#39;commentbody-116627&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-116627">#121</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-116627">
					<p>问题补充，隔离等级是RR，test1，test2中的id都是PK，两个表都没有使用二级索引</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-118395" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/0fa6d084ca2e98264d4ce830feee7b85.png" srcset="http://0.gravatar.com/avatar/0fa6d084ca2e98264d4ce830feee7b85?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-118395">
				
				xep
									</span>
								<div class="date">11月 13th, 201412:22</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=118395#respond" onclick="return addComment.moveForm( &quot;comment-118395&quot;, &quot;118395&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给xep">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-118395&#39;, &#39;comment-118395&#39;, &#39;commentbody-118395&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-118395">#122</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-118395">
					<p>组合五：id主键+RR<br>
  应该也加了gap lock<br>
测试：  s1:<br>
   (root@localhost) [db_t1]&gt; select * from test1;<br>
+—-+——-+———————+<br>
| id | name  | cdate               |<br>
+—-+——-+———————+<br>
|  1 | test1 | 2014-11-12 14:32:41 |<br>
|  2 | test2 | 2014-11-13 11:43:01 |<br>
|  3 | test3 | 2014-11-13 10:58:12 |<br>
+—-+——-+———————+<br>
3 rows in set (0.00 sec)</p>
<p>(root@localhost) [db_t1]&gt; update test1 set name = ‘test22’ where id=2;<br>
(root@localhost) [db_t1]&gt; commit;      </p>
<p>   s2:<br>
(root@localhost) [db_t1]&gt; select * from test1;<br>
+—-+——-+———————+<br>
| id | name  | cdate               |<br>
+—-+——-+———————+<br>
|  1 | test1 | 2014-11-12 14:32:41 |<br>
|  2 | test2 | 2014-11-13 11:43:01 |<br>
|  3 | test3 | 2014-11-13 10:58:12 |<br>
+—-+——-+———————+<br>
3 rows in set (0.00 sec)</p>
<p>(root@localhost) [db_t1]&gt; commit;<br>
Query OK, 0 rows affected (0.00 sec)</p>
<p>(root@localhost) [db_t1]&gt; select * from test1;<br>
+—-+——–+———————+<br>
| id | name   | cdate               |<br>
+—-+——–+———————+<br>
|  1 | test1  | 2014-11-12 14:32:41 |<br>
|  2 | test22 | 2014-11-13 11:43:37 |<br>
|  3 | test3  | 2014-11-13 10:58:12 |<br>
+—-+——–+———————+</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-138261" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/fb09293e20bb185c79d92e7de6d58402.png" srcset="http://0.gravatar.com/avatar/fb09293e20bb185c79d92e7de6d58402?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-138261">
				
				CC
									</span>
								<div class="date">12月 1st, 201416:44</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=138261#respond" onclick="return addComment.moveForm( &quot;comment-138261&quot;, &quot;138261&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给CC">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-138261&#39;, &#39;comment-138261&#39;, &#39;commentbody-138261&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-138261">#123</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-138261">
					<p>请教登博，博客中说的那些是否有index的判断是在storage层还是在sql层呢，因为如果delete的话在storage的接口应该是delete_row()。我现在正在看storage中的heap，因为才开始，想找个比较简单的看看先熟悉熟悉，希望能从你那得到点建议。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-141725" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/fa0540cb34ec98cddea23d30f4143d16.png" srcset="http://0.gravatar.com/avatar/fa0540cb34ec98cddea23d30f4143d16?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-141725">
				
				nick
									</span>
								<div class="date">12月 5th, 201413:38</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=141725#respond" onclick="return addComment.moveForm( &quot;comment-141725&quot;, &quot;141725&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给nick">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-141725&#39;, &#39;comment-141725&#39;, &#39;commentbody-141725&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-141725">#124</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-141725">
					<p>对于案例8，RR级别下无索引锁住所有记录和gap，为何不直接加table lock呢？innodb的table lock和myisam的实现方式是否一样？在innodb中直接用命令lock table xx read会调用row lock吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-158556" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/dda9968bdc73b1a76e61c5a42e91b079.jpeg" srcset="http://1.gravatar.com/avatar/dda9968bdc73b1a76e61c5a42e91b079?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-158556">
				
				shun
									</span>
								<div class="date">12月 23rd, 201417:26</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=158556#respond" onclick="return addComment.moveForm( &quot;comment-158556&quot;, &quot;158556&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给shun">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-158556&#39;, &#39;comment-158556&#39;, &#39;commentbody-158556&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-158556">#125</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-158556">
					<p>期待出书《MySQL源码剖析》，马上预订！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-181369" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/76e52922a67462b26d4c06a828d23a41.png" srcset="http://1.gravatar.com/avatar/76e52922a67462b26d4c06a828d23a41?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-181369">
				
				prclqz
									</span>
								<div class="date">1月 30th, 201511:57</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=181369#respond" onclick="return addComment.moveForm( &quot;comment-181369&quot;, &quot;181369&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给prclqz">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-181369&#39;, &#39;comment-181369&#39;, &#39;commentbody-181369&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-181369">#126</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-181369">
					<p>学长，关于MySQL的意向锁有点搞不懂，能有机会解释下吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-184813" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8eb635bbfdaad65e806d0b6f0bfb4a41.png" srcset="http://2.gravatar.com/avatar/8eb635bbfdaad65e806d0b6f0bfb4a41?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-184813">
				
				trikker
									</span>
								<div class="date">2月 5th, 201514:53</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=184813#respond" onclick="return addComment.moveForm( &quot;comment-184813&quot;, &quot;184813&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给trikker">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-184813&#39;, &#39;comment-184813&#39;, &#39;commentbody-184813&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-184813">#127</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-184813">
					<p>文章讲得非常好，深入浅出。只是做了实验之后，结果和你的“一条复杂的SQL加锁分析”有一点不一样。<br>
前提都和你的一样，事务隔离级别是RR，innodb_locks_unsafe_for_binlog是关闭的。<br>
官方的mysql-5.6.21<br>
实验结果如下：</p>
<p>首先数据是和你一样的。<br>
mysql&gt; show create table t1\G<br>
*************************** 1. row ***************************<br>
       Table: t1<br>
Create Table: CREATE TABLE `t1` (<br>
  `id` int(11) NOT NULL,<br>
  `userid` varchar(20) DEFAULT NULL,<br>
  `blogid` varchar(20) DEFAULT NULL,<br>
  `pubtime` int(11) DEFAULT NULL,<br>
  `comment` varchar(20) DEFAULT NULL,<br>
  PRIMARY KEY (`id`),<br>
  KEY `idx_t1_pu` (`pubtime`,`userid`)<br>
) ENGINE=InnoDB DEFAULT CHARSET=latin1<br>
1 row in set (0.04 sec)</p>
<p>mysql&gt; select * from t1;<br>
+—–+——–+——–+———+———+<br>
| id  | userid | blogid | pubtime | comment |<br>
+—–+——–+——–+———+———+<br>
|   1 | hdc    | a      |      10 | NULL    |<br>
|   4 | yyy    | b      |       3 | NULL    |<br>
|   6 | hdc    | c      |     100 | NULL    |<br>
|   8 | hdc    | d      |       5 | good    |<br>
|  10 | hdc    | e      |       1 | NULL    |<br>
| 100 | bbb    | f      |      20 | NULL    |<br>
+—–+——–+——–+———+———+<br>
6 rows in set (0.00 sec)</p>
<p>然后，那条delete语句的执行计划如下，可以看出没有用到ICP：<br>
mysql&gt; desc delete from t1 where pubtime&gt;1 and pubtime begin;<br>
Query OK, 0 rows affected (0.00 sec)</p>
<p>mysql&gt; delete from t1 where pubtime&gt;1 and pubtime select * from t1 where id=100 for update;<br>
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</p>
<p>从这里可以看出，MySQL没有使用ICP，所以按照你的分析是锁了3行索引记录（对应到主键上面也是锁3行记录），但是实验表明id=100的那行记录也被锁了。</p>
<p>也就是说,delete from t1 where pubtime&lt;20;(假设pubtime上面有非唯一索引且存在pubtime=20这条记录)，这样的where条件pubtime&lt;20是会锁pubtime=20这条记录的，这和你的文章说的不一样。</p>
<p>我的推理也和你一样，不应该锁这条记录，但是MySQL就是锁了。为什么？？？？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-184814" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8eb635bbfdaad65e806d0b6f0bfb4a41.png" srcset="http://2.gravatar.com/avatar/8eb635bbfdaad65e806d0b6f0bfb4a41?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-184814">
				
				trikker
									</span>
								<div class="date">2月 5th, 201514:57</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=184814#respond" onclick="return addComment.moveForm( &quot;comment-184814&quot;, &quot;184814&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给trikker">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-184814&#39;, &#39;comment-184814&#39;, &#39;commentbody-184814&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-184814">#128</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-184814">
					<p>我的评论不知道为什么很多行的字消失了，所以看上去好像没有逻辑，不知道你的评论系统出了什么状况。反正就是，delete from t1 where pubtime&lt;20;(假设pubtime上面有非唯一索引且存在pubtime=20这条记录)，这样的where条件pubtime&lt;20是会锁pubtime=20这条记录的，这和你的文章说的不一样。我的推理也和你一样，不应该锁这条记录，但是MySQL就是锁了。为什么？？？？我可以发邮件给你的，但是我现在不知道你的邮箱！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-184817" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/8eb635bbfdaad65e806d0b6f0bfb4a41.png" srcset="http://2.gravatar.com/avatar/8eb635bbfdaad65e806d0b6f0bfb4a41?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-184817">
				
				trikker
									</span>
								<div class="date">2月 5th, 201515:07</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=184817#respond" onclick="return addComment.moveForm( &quot;comment-184817&quot;, &quot;184817&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给trikker">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-184817&#39;, &#39;comment-184817&#39;, &#39;commentbody-184817&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-184817">#129</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-184817">
					<p>更具体点说，就是实际上那条复杂的delete语句delete from t1 where pubtime &gt;1 and pubtime &lt;20 and userid='hdc' and comment is not null;锁住的并非只是pubtime=3、5、10这3条记录（没有使用ICP情况下），还有pubtime=20这条记录，但是没有锁pubtime=1这条记录。不知道原因！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-189184" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/43116ea7390e1c95e4b93932b110ca9a.png" srcset="http://1.gravatar.com/avatar/43116ea7390e1c95e4b93932b110ca9a?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-189184">
				
				Huyet
									</span>
								<div class="date">2月 13th, 201511:50</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=189184#respond" onclick="return addComment.moveForm( &quot;comment-189184&quot;, &quot;189184&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Huyet">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-189184&#39;, &#39;comment-189184&#39;, &#39;commentbody-189184&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-189184">#130</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-189184">
					<p>对于组合四<br>
begin;<br>
delete from t where id=10;<br>
不commit</p>
<p>然后查看状态，会看到锁住了7行，而不是2行？<br>
就是说，文中提到的优化没效果。<br>
我理解的优化就是应该只锁住2行，其他不满足条件的都防锁了.</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-189238" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/43116ea7390e1c95e4b93932b110ca9a.png" srcset="http://1.gravatar.com/avatar/43116ea7390e1c95e4b93932b110ca9a?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-189238">
				
				Huyet
									</span>
								<div class="date">2月 13th, 201514:25</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=189238#respond" onclick="return addComment.moveForm( &quot;comment-189238&quot;, &quot;189238&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Huyet">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-189238&#39;, &#39;comment-189238&#39;, &#39;commentbody-189238&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-189238">#131</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-189238">
					<p>唉，原来是自己搞错，mysql默认是rr，我就动态修改为rc后，出现上面那种问题。后来我直接改了配置文件再时，在rc下，组合四中，的确有优化，最后只锁了符合条件的行。是我动态修改系统变量的写法出问题。。。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-234741" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d12ee2445efed2de84f745154da88f12.jpeg" srcset="http://1.gravatar.com/avatar/d12ee2445efed2de84f745154da88f12?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-234741">
				
				Richard
									</span>
								<div class="date">6月 11th, 201510:59</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=234741#respond" onclick="return addComment.moveForm( &quot;comment-234741&quot;, &quot;234741&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Richard">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-234741&#39;, &#39;comment-234741&#39;, &#39;commentbody-234741&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-234741">#132</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-234741">
					<p>RR主要是防止幻象才加的gap锁。不过官方不建议改默认级别。 不过能把控的话，什么级别都无所谓</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-198204" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/210b506ed782fe5a66a8225a03a6b7c3.png" srcset="http://2.gravatar.com/avatar/210b506ed782fe5a66a8225a03a6b7c3?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-198204">
				
				MYSQL菜鸟
									</span>
								<div class="date">3月 2nd, 201516:22</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=198204#respond" onclick="return addComment.moveForm( &quot;comment-198204&quot;, &quot;198204&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给MYSQL菜鸟">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-198204&#39;, &#39;comment-198204&#39;, &#39;commentbody-198204&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-198204">#133</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-198204">
					<p>你好，你的文章我看了好几遍了，但是关于RR级别组合七那种，按照您说的应该是加了那几条记录的行级锁，比如id为主键  name 为非唯一索引,先执行 delete from person where name = ‘zhang’, 然后这个事务不提交，再在另外一个事务里执行 delete from person where name = ‘li’ 就会锁等待呢，我如果执行delete from person where id = ‘2’就可以成功。   假定有2条数据   id = ‘1’ name = ‘zhang’ 和 id=’2′ name=’li’. 希望您能抽空解答 谢了 我qq 785848201</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-214713" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-214713">
				
				hedengcheng
									</span>
								<div class="date">4月 13th, 201521:00</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=214713#respond" onclick="return addComment.moveForm( &quot;comment-214713&quot;, &quot;214713&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-214713&#39;, &#39;comment-214713&#39;, &#39;commentbody-214713&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-214713">#134</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-214713">
					<p>你再仔细想想，这个问题我其实写的比较明白了</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-222816" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d6182f895d7ef2961204f8b02f78dfb0.png" srcset="http://1.gravatar.com/avatar/d6182f895d7ef2961204f8b02f78dfb0?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-222816">
				
				mysqlzac
									</span>
								<div class="date">5月 13th, 201516:20</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=222816#respond" onclick="return addComment.moveForm( &quot;comment-222816&quot;, &quot;222816&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给mysqlzac">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-222816&#39;, &#39;comment-222816&#39;, &#39;commentbody-222816&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-222816">#135</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-222816">
					<p>这个是因为gap只会出现在二级index中</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-202552" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/3f009d72559f51e7e454b16e5d0687a1.png" srcset="http://0.gravatar.com/avatar/3f009d72559f51e7e454b16e5d0687a1?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-202552">
				
				alexniver
									</span>
								<div class="date">3月 12th, 201515:29</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=202552#respond" onclick="return addComment.moveForm( &quot;comment-202552&quot;, &quot;202552&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给alexniver">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-202552&#39;, &#39;comment-202552&#39;, &#39;commentbody-202552&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-202552">#136</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-202552">
					<p>牛逼………… 之前遇到死锁都晕得不行~~ 这回有解决的思路了</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-208394" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/f10e606ef8be3a526309ddb8f09483df.png" srcset="http://0.gravatar.com/avatar/f10e606ef8be3a526309ddb8f09483df?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-208394">
				
				Bin
									</span>
								<div class="date">3月 26th, 201520:48</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=208394#respond" onclick="return addComment.moveForm( &quot;comment-208394&quot;, &quot;208394&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Bin">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-208394&#39;, &#39;comment-208394&#39;, &#39;commentbody-208394&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-208394">#137</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-208394">
					<p>读了博主的文章，解惑了，非常感谢！</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-211537" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/81643fcca3f2c2e18b615caf1583a9f7.png" srcset="http://2.gravatar.com/avatar/81643fcca3f2c2e18b615caf1583a9f7?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-211537">
				
				i9944
									</span>
								<div class="date">4月 4th, 201511:41</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=211537#respond" onclick="return addComment.moveForm( &quot;comment-211537&quot;, &quot;211537&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给i9944">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-211537&#39;, &#39;comment-211537&#39;, &#39;commentbody-211537&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-211537">#138</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-211537">
					<p>有个死锁log麻烦大家看下    我不明白事务2 为什么获取了一个锁后  为什么还会获取这个锁 导致等待呢  </p>
<p>LATEST DETECTED DEADLOCK<br>
————————<br>
150319 11:55:31<br>
*** (1) TRANSACTION:<br>
TRANSACTION 37BA66104, ACTIVE 0 sec starting index read<br>
mysql tables in use 1, locked 1<br>
LOCK WAIT 5 lock struct(s), heap size 1248, 4 row lock(s), undo log entries 1<br>
MySQL thread id 386472597, OS thread handle 0x7f893b061700, query id 11094033559 10.64.29.226 hotel_service statistics<br>
select * from `tab`<br>
WHERE id = 3863754<br>
for update<br>
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>
RECORD LOCKS space id 250 page no 46518 n bits 280 index `PRIMARY` of table `tab`.`tab` trx id 37BA66104 lock_mode X locks rec but not gap waiting<br>
*** (2) TRANSACTION:<br>
TRANSACTION 37BA66106, ACTIVE 0 sec starting index read<br>
mysql tables in use 1, locked 1<br>
5 lock struct(s), heap size 1248, 4 row lock(s), undo log entries 1<br>
MySQL thread id 386481878, OS thread handle 0x7f8c0a0c2700, query id 11094033564 10.64.17.221 hotel_service statistics<br>
select * from `tab`<br>
WHERE id = 3863753<br>
for update<br>
*** (2) HOLDS THE LOCK(S):<br>
RECORD LOCKS space id 250 page no 46518 n bits 280 index `PRIMARY` of table `tab`.`tab` trx id 37BA66106 lock_mode X locks rec but not gap<br>
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>
RECORD LOCKS space id 250 page no 46518 n bits 280 index `PRIMARY` of table `tab`.`tab` trx id 37BA66106 lock_mode X locks rec but not gap waiting<br>
*** WE ROLL BACK TRANSACTION (2)<br>
————<br>
TRANSACTIONS<br>
————<br>
Trx id counter 37BA87F6F<br>
Purge done for trx’s n:o = 37BA87ED2, sees &lt; 37BA87ED2<br>
—————————-<br>
END OF INNODB MONITOR OUTPUT<br>
============================</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-214987" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/6f012c59ba5b83103b326bd67d15f675.png" srcset="http://0.gravatar.com/avatar/6f012c59ba5b83103b326bd67d15f675?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-214987">
				
				xiangzi
									</span>
								<div class="date">4月 14th, 201515:56</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=214987#respond" onclick="return addComment.moveForm( &quot;comment-214987&quot;, &quot;214987&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给xiangzi">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-214987&#39;, &#39;comment-214987&#39;, &#39;commentbody-214987&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-214987">#139</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-214987">
					<p>id非唯一索引+RC</p>
<p>create table tidx (id int, name varchar(100));<br>
create index idx_tidx on tidx(id);<br>
insert into tidx values (10, ‘zhao’);<br>
insert into tidx values (11, ‘qian’);<br>
insert into tidx values (12, ‘sun’);</p>
<p>begin;<br>
delete from tidx where id=10;</p>
<p>查看事务<br>
trx_rows_locked: 3</p>
<p>与描述的不是期待的4行</p>
<p>使用相同表结构和数据，trx_rows_locked是5个，而不是期待的4个。</p>
<p>或者是我的期待有问题？</p>
<p>mysql的版本是5.6.21</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-214989" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/6f012c59ba5b83103b326bd67d15f675.png" srcset="http://0.gravatar.com/avatar/6f012c59ba5b83103b326bd67d15f675?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-214989">
				
				xiangzi
									</span>
								<div class="date">4月 14th, 201516:09</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=214989#respond" onclick="return addComment.moveForm( &quot;comment-214989&quot;, &quot;214989&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给xiangzi">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-214989&#39;, &#39;comment-214989&#39;, &#39;commentbody-214989&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-214989">#140</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-214989">
					<blockquote cite="./何登成的技术博客 » MySQL 加锁处理分析_files/saved_resource(2)"><p>
<strong><a href="http://hedengcheng.com/?p=771#comment-214987" rel="nofollow">xiangzi</a> :</strong><br>
id非唯一索引+RC<br>
create table tidx (id int, name varchar(100));<br>
create index idx_tidx on tidx(id);<br>
insert into tidx values (10, ‘zhao’);<br>
insert into tidx values (11, ‘qian’);<br>
insert into tidx values (12, ‘sun’);<br>
begin;<br>
delete from tidx where id=10;<br>
查看事务<br>
trx_rows_locked: 3<br>
与描述的不是期待的4行<br>
使用相同表结构和数据，trx_rows_locked是5个，而不是期待的4个。<br>
或者是我的期待有问题？<br>
mysql的版本是5.6.21
</p></blockquote>
<p>抱歉，在设置事务隔离级的时候出现问题。实际的事务隔离级为rr</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-215436" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/9d8bb1ca25384d7e7710001a59b9f56f.png" srcset="http://0.gravatar.com/avatar/9d8bb1ca25384d7e7710001a59b9f56f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-215436">
				
				闫宗帅
									</span>
								<div class="date">4月 16th, 201522:33</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=215436#respond" onclick="return addComment.moveForm( &quot;comment-215436&quot;, &quot;215436&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给闫宗帅">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-215436&#39;, &#39;comment-215436&#39;, &#39;commentbody-215436&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-215436">#141</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-215436">
					<p>登博，您好，我想请教下：在铺助索引加锁后，对应的聚集索引也需要加锁，这情况在lock in share mode也适用吗？<br>
我测试时，for update的话，在对应聚集索引加锁，但是lock in share mode的话，没有加</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-215439" class="comment admincomment">

		<div class="info admininfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d778b7da56c21298f152ebab7a8509ee.png" srcset="http://1.gravatar.com/avatar/d778b7da56c21298f152ebab7a8509ee?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-215439">
				
				hedengcheng
									</span>
								<div class="date">4月 16th, 201522:38</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=215439#respond" onclick="return addComment.moveForm( &quot;comment-215439&quot;, &quot;215439&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给hedengcheng">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-215439&#39;, &#39;comment-215439&#39;, &#39;commentbody-215439&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-215439">#142</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-215439">
					<p>聚簇索引记录上，一定会加锁的。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-268355" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/9d8bb1ca25384d7e7710001a59b9f56f.png" srcset="http://0.gravatar.com/avatar/9d8bb1ca25384d7e7710001a59b9f56f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-268355">
				
				闫宗帅
									</span>
								<div class="date">9月 18th, 201523:05</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=268355#respond" onclick="return addComment.moveForm( &quot;comment-268355&quot;, &quot;268355&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给闫宗帅">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-268355&#39;, &#39;comment-268355&#39;, &#39;commentbody-268355&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-268355">#143</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-268355">
					<p>您好，<br>
测试的这种情况for update对应聚集索引加了锁，但是lock in share mode没加</p>
<p>1、表结构：<br>
CREATE TABLE `c` (<br>
  `id1` int(11) NOT NULL DEFAULT ‘0’,<br>
  `id2` int(11) DEFAULT NULL,<br>
  `id3` int(11) DEFAULT NULL,<br>
  PRIMARY KEY (`id1`),<br>
  KEY `id2` (`id2`)<br>
) ENGINE=InnoDB DEFAULT CHARSET=utf8<br>
2、数据<br>
MariaDB [mytest]&gt; select *from c;<br>
+—–+——+——+<br>
| id1 | id2  | id3  |<br>
+—–+——+——+<br>
|   6 |    1 |    2 |<br>
|   7 |    2 |    5 |<br>
|   8 |    3 |    5 |<br>
|   9 |    4 |    5 |<br>
|  10 |    5 |    5 |<br>
+—–+——+——+<br>
5 rows in set (0.00 sec)<br>
3、对应执行计划：<br>
MariaDB [mytest]&gt; explain select id1 from c where id2 explain select id1 from c where id2 begin;<br>
Query OK, 0 rows affected (0.00 sec)</p>
<p>MariaDB [mytest]&gt;  select id1 from c where id2 begin;<br>
Query OK, 0 rows affected (0.00 sec)</p>
<p>MariaDB [mytest]&gt;  select id1 from c where id2&lt;2 lock in share mode;<br>
+—–+<br>
| id1 |<br>
+—–+<br>
|   6 |<br>
+—–+<br>
1 row in set (0.00 sec)</p>
<p> —TRANSACTION 284984, ACTIVE 6 sec<br>
2 lock struct(s), heap size 320, 2 row lock(s)<br>
MySQL thread id 2, OS thread handle 0xa61ffb90, query id 111 localhost root cleaning up<br>
TABLE LOCK table `mytest`.`c` trx id 284984 lock mode IS<br>
RECORD LOCKS space id 115 page no 4 n bits 80 index `id2` of table `mytest`.`c` trx id 284984 lock mode S<br>
Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000001; asc     ;;<br>
 1: len 4; hex 80000006; asc     ;;</p>
<p>Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000002; asc     ;;<br>
 1: len 4; hex 80000007; asc     ;;</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-225620" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/037b946f7beee940103e65a2a5126875.png" srcset="http://0.gravatar.com/avatar/037b946f7beee940103e65a2a5126875?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-225620">
				
				林
									</span>
								<div class="date">5月 21st, 201516:11</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=225620#respond" onclick="return addComment.moveForm( &quot;comment-225620&quot;, &quot;225620&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给林">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-225620&#39;, &#39;comment-225620&#39;, &#39;commentbody-225620&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-225620">#144</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-225620">
					<p>登博主:   以下一段解释和结论是不是搞反结论了?(RR不存在幻读,那么幻读是会有幻象的吧) .  文章::: 所谓幻读，就是同一个事务，连续做两次当前读 (例如：select * from t1 where id = 10 for update;)，那么这两次当前读返回的是完全相同的记录 (记录数量一致，记录本身也一致)，第二次的当前读，不会比第一次返回更多的记录 (幻象)。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-229840" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/5ef16bdb8de55037bf8aebb51c7439a0.png" srcset="http://2.gravatar.com/avatar/5ef16bdb8de55037bf8aebb51c7439a0?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-229840">
				
				西楼
									</span>
								<div class="date">6月 1st, 201522:04</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=229840#respond" onclick="return addComment.moveForm( &quot;comment-229840&quot;, &quot;229840&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给西楼">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-229840&#39;, &#39;comment-229840&#39;, &#39;commentbody-229840&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-229840">#145</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-229840">
					<p>困惑了！按你这分析加行锁是啥概念？直接加行锁不就结了，你这才两字段，这表要多几个带索引字段，是不可以通过各种where 字段来修改表，那如第二种情况，是不每个字段都要加x锁</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-234733" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d12ee2445efed2de84f745154da88f12.jpeg" srcset="http://1.gravatar.com/avatar/d12ee2445efed2de84f745154da88f12?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-234733">
				
				Richard
									</span>
								<div class="date">6月 11th, 201510:36</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=234733#respond" onclick="return addComment.moveForm( &quot;comment-234733&quot;, &quot;234733&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Richard">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-234733&#39;, &#39;comment-234733&#39;, &#39;commentbody-234733&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-234733">#146</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-234733">
					<p>大师，请问怎么解释这个：<br>
CREATE TABLE test (a int, index (a));<br>
INSERT INTO test VALUES (5), (10), (15);<br>
RR级别下<br>
tx1:<br>
select * from test where a=10 for update;</p>
<p>tx2:<br>
INSERT INTO test VALUES(5); //On hold<br>
INSERT INTO test VALUES(9); //On hold<br>
INSERT INTO test VALUES(14); //On hold<br>
INSERT INTO test VALUES(4); //Works<br>
INSERT INTO test VALUES (15); //Works<br>
UPDATE test SET a = 1 WHERE a = 5; //Works<br>
UPDATE test SET a = 8 WHERE a = 5; //On hold<br>
UPDATE test SET a = 7 WHERE a = 15; //On hold<br>
UPDATE test SET a = 100 WHERE a = 15; //Works</p>
<p>按分析，这种非唯一辅助索引，锁范围应该是(5,15)<br>
奇怪的是：<br>
INSERT INTO test VALUES(5); //On hold<br>
UPDATE test SET a = 1 WHERE a = 5; //Works</p>
<p>5这个到底锁没有啊？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-234740" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/d12ee2445efed2de84f745154da88f12.jpeg" srcset="http://1.gravatar.com/avatar/d12ee2445efed2de84f745154da88f12?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-234740">
				
				Richard
									</span>
								<div class="date">6月 11th, 201510:56</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=234740#respond" onclick="return addComment.moveForm( &quot;comment-234740&quot;, &quot;234740&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Richard">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-234740&#39;, &#39;comment-234740&#39;, &#39;commentbody-234740&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-234740">#147</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-234740">
					<p>何大师，顺便再多问一个</p>
<p>关于那个Intention Lock, 具体是个什么鬼。<br>
什么时候锁，什么时候起作用</p>
<p>看官方文档说得不清不楚的</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-240018" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/f1cdc46aaec0283f3d5d02af0562000f.png" srcset="http://0.gravatar.com/avatar/f1cdc46aaec0283f3d5d02af0562000f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-240018">
				
				jjbond
									</span>
								<div class="date">6月 23rd, 201515:22</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=240018#respond" onclick="return addComment.moveForm( &quot;comment-240018&quot;, &quot;240018&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给jjbond">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-240018&#39;, &#39;comment-240018&#39;, &#39;commentbody-240018&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-240018">#148</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-240018">
					<p>大牛，打扰～我想咨询一下，如果是多字段的唯一索引（ex unique key(a,b)），那么RR + 唯一索引是不是也应该会产生gap锁?</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-240027" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/f1cdc46aaec0283f3d5d02af0562000f.png" srcset="http://0.gravatar.com/avatar/f1cdc46aaec0283f3d5d02af0562000f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-240027">
				
				jjbond
									</span>
								<div class="date">6月 23rd, 201515:29</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=240027#respond" onclick="return addComment.moveForm( &quot;comment-240027&quot;, &quot;240027&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给jjbond">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-240027&#39;, &#39;comment-240027&#39;, &#39;commentbody-240027&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-240027">#149</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-240027">
					<p>补充一下，delete操作只针对a 例如 delete…where a = xxx</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-254858" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-254858" href="http://www.programerhome.com/?p=29664" rel="external nofollow">
				
				Mysql文章笔记 | 程序员之家
									</a>
								<div class="date">7月 26th, 201520:59</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-254858">#150</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-264719" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/970b4e2159b578e857797e4fbf6e435c.png" srcset="http://0.gravatar.com/avatar/970b4e2159b578e857797e4fbf6e435c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-264719">
				
				王三
									</span>
								<div class="date">9月 5th, 201512:13</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=264719#respond" onclick="return addComment.moveForm( &quot;comment-264719&quot;, &quot;264719&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给王三">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-264719&#39;, &#39;comment-264719&#39;, &#39;commentbody-264719&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-264719">#151</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-264719">
					<p>非常nice的文章，授人以渔，解决了很多关于mysql锁的疑惑，感谢博主</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-268356" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/9d8bb1ca25384d7e7710001a59b9f56f.png" srcset="http://0.gravatar.com/avatar/9d8bb1ca25384d7e7710001a59b9f56f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-268356">
				
				闫宗帅
									</span>
								<div class="date">9月 18th, 201523:09</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=268356#respond" onclick="return addComment.moveForm( &quot;comment-268356&quot;, &quot;268356&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给闫宗帅">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-268356&#39;, &#39;comment-268356&#39;, &#39;commentbody-268356&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-268356">#152</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-268356">
					<p>您好，<br>
测试的这种情况for update对应聚集索引加了锁，但是lock in share mode没加</p>
<p>1、表结构：<br>
CREATE TABLE `c` (<br>
  `id1` int(11) NOT NULL DEFAULT ‘0’,<br>
  `id2` int(11) DEFAULT NULL,<br>
  `id3` int(11) DEFAULT NULL,<br>
  PRIMARY KEY (`id1`),<br>
  KEY `id2` (`id2`)<br>
) ENGINE=InnoDB DEFAULT CHARSET=utf8<br>
2、数据<br>
MariaDB [mytest]&gt; select *from c;<br>
+—–+——+——+<br>
| id1 | id2  | id3  |<br>
+—–+——+——+<br>
|   6 |    1 |    2 |<br>
|   7 |    2 |    5 |<br>
|   8 |    3 |    5 |<br>
|   9 |    4 |    5 |<br>
|  10 |    5 |    5 |<br>
+—–+——+——+<br>
5 rows in set (0.00 sec)<br>
3、对应执行计划：<br>
MariaDB [mytest]&gt; explain select id1 from c where id2 explain select id1 from c where id2 begin;<br>
Query OK, 0 rows affected (0.00 sec)</p>
<p>MariaDB [mytest]&gt;  select id1 from c where id2 begin;<br>
Query OK, 0 rows affected (0.00 sec)</p>
<p>MariaDB [mytest]&gt;  select id1 from c where id2&lt;2 lock in share mode;<br>
+—–+<br>
| id1 |<br>
+—–+<br>
|   6 |<br>
+—–+<br>
1 row in set (0.00 sec)</p>
<p> —TRANSACTION 284984, ACTIVE 6 sec<br>
2 lock struct(s), heap size 320, 2 row lock(s)<br>
MySQL thread id 2, OS thread handle 0xa61ffb90, query id 111 localhost root cleaning up<br>
TABLE LOCK table `mytest`.`c` trx id 284984 lock mode IS<br>
RECORD LOCKS space id 115 page no 4 n bits 80 index `id2` of table `mytest`.`c` trx id 284984 lock mode S<br>
Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000001; asc     ;;<br>
 1: len 4; hex 80000006; asc     ;;</p>
<p>Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000002; asc     ;;<br>
 1: len 4; hex 80000007; asc     ;;</p>
				</div>
			</div>
		
		<div class="fixed"></div>

<ul class="children">
	<li id="comment-268358" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/9d8bb1ca25384d7e7710001a59b9f56f.png" srcset="http://0.gravatar.com/avatar/9d8bb1ca25384d7e7710001a59b9f56f?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-268358">
				
				闫宗帅
									</span>
								<div class="date">9月 18th, 201523:14</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=268358#respond" onclick="return addComment.moveForm( &quot;comment-268358&quot;, &quot;268358&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给闫宗帅">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-268358&#39;, &#39;comment-268358&#39;, &#39;commentbody-268358&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-268358">#153</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-268358">
					<p>提交了2次都没显示全。</p>
<p>我再提下加锁情况：<br>
1、select id1 from c where id2&lt;2 for update;有4个锁，2个二级索引上锁，2个二级索引对应聚集索引上的锁<br>
3 lock struct(s), heap size 320, 4 row lock(s)<br>
MySQL thread id 2, OS thread handle 0xa61ffb90, query id 107 localhost root cleaning up<br>
TABLE LOCK table `mytest`.`c` trx id 284983 lock mode IX<br>
RECORD LOCKS space id 115 page no 4 n bits 80 index `id2` of table `mytest`.`c` trx id 284983 lock_mode X<br>
Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000001; asc     ;;<br>
 1: len 4; hex 80000006; asc     ;;</p>
<p>Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000002; asc     ;;<br>
 1: len 4; hex 80000007; asc     ;;<br>
RECORD LOCKS space id 115 page no 3 n bits 88 index `PRIMARY` of table `mytest`.`c` trx id 284983 lock_mode X locks rec but not gap<br>
Record lock, heap no 7 PHYSICAL RECORD: n_fields 5; compact format; info bits 0<br>
 0: len 4; hex 80000006; asc     ;;<br>
 1: len 6; hex 00000004577e; asc     W~;;<br>
 2: len 7; hex 44000002190d34; asc D     4;;<br>
 3: len 4; hex 80000001; asc     ;;<br>
 4: len 4; hex 80000002; asc     ;;</p>
<p>Record lock, heap no 8 PHYSICAL RECORD: n_fields 5; compact format; info bits 0<br>
 0: len 4; hex 80000007; asc     ;;<br>
 1: len 6; hex 000000045912; asc     Y ;;<br>
 2: len 7; hex 100000014116d6; asc     A  ;;<br>
 3: len 4; hex 80000002; asc     ;;<br>
 4: len 4; hex 80000005; asc     ;;</p>
<p>2、select id1 from c where id2&lt;2 lock in share mode;<br>
2 lock struct(s), heap size 320, 2 row lock(s)<br>
MySQL thread id 2, OS thread handle 0xa61ffb90, query id 111 localhost root cleaning up<br>
TABLE LOCK table `mytest`.`c` trx id 284984 lock mode IS<br>
RECORD LOCKS space id 115 page no 4 n bits 80 index `id2` of table `mytest`.`c` trx id 284984 lock mode S<br>
Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000001; asc     ;;<br>
 1: len 4; hex 80000006; asc     ;;</p>
<p>Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>
 0: len 4; hex 80000002; asc     ;;<br>
 1: len 4; hex 80000007; asc     ;;</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
	<li id="comment-273227" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-273227" href="http://www.daniel-journey.com/archives/1439" rel="external nofollow">
				
				MYSQL的锁机制 | Daniel Hu的技术博客
									</a>
								<div class="date">10月 4th, 201508:38</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-273227">#154</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-274030" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/4ba90eccc25f87fd7218acf749e57fd1.png" srcset="http://1.gravatar.com/avatar/4ba90eccc25f87fd7218acf749e57fd1?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-274030">
				
				Hereicome
									</span>
								<div class="date">10月 7th, 201521:00</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=274030#respond" onclick="return addComment.moveForm( &quot;comment-274030&quot;, &quot;274030&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给Hereicome">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-274030&#39;, &#39;comment-274030&#39;, &#39;commentbody-274030&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-274030">#155</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-274030">
					<p>之前片断式的看过一些锁的东西，但是还是有很多困惑，这篇文章解了很多困惑:）</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-274570" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/cde41f72d5b11146d629dc00b37a69fa.png" srcset="http://0.gravatar.com/avatar/cde41f72d5b11146d629dc00b37a69fa?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-274570">
				
				dblover
									</span>
								<div class="date">10月 10th, 201517:53</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=274570#respond" onclick="return addComment.moveForm( &quot;comment-274570&quot;, &quot;274570&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给dblover">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-274570&#39;, &#39;comment-274570&#39;, &#39;commentbody-274570&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-274570">#156</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-274570">
					<p>下面几个是关键信息啊：<br>
当前读：特殊的读操作，插入/更新/删除操作，属于当前读，需要加锁。<br>
当前读，读取的是记录的最新版本，必须保证是已经提交的一致版本。<br>
    select * from table where ? lock in share mode;<br>
    select * from table where ? for update;<br>
    insert into table values (…);<br>
    update table set ? where ?;<br>
    delete from table where ?;</p>
<p>为什么将 插入/更新/删除 操作，都归为当前读？<br>
针对一条当前读的SQL语句，InnoDB与MySQL Server的交互，是一条一条进行的，因此，加锁也是一条一条进行的。先对一条满足条件的记录加锁，返回给MySQL Server，做一些DML操作；然后在读取下一条加锁，直至读取完毕。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-276298" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/83bd52f3ff77dc7c91c0615157bc8111.png" srcset="http://2.gravatar.com/avatar/83bd52f3ff77dc7c91c0615157bc8111?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-276298">
				
				lexin
									</span>
								<div class="date">10月 28th, 201514:26</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=276298#respond" onclick="return addComment.moveForm( &quot;comment-276298&quot;, &quot;276298&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给lexin">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-276298&#39;, &#39;comment-276298&#39;, &#39;commentbody-276298&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-276298">#157</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-276298">
					<blockquote cite="./何登成的技术博客 » MySQL 加锁处理分析_files/saved_resource(3)"><p>
<strong><a href="http://hedengcheng.com/?p=771#comment-5543" rel="nofollow">hedengcheng </a> :</strong>谁说Intention Lock是表级锁？谁写的？拉出去突突了。</p></blockquote>
<p><a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-lock-modes.html" rel="nofollow">http://dev.mysql.com/doc/refman/5.5/en/innodb-lock-modes.html</a></p>
<p>Intention Locks</p>
<p>Additionally, InnoDB supports multiple granularity locking which permits coexistence of record locks and locks on entire tables. To make locking at multiple granularity levels practical, additional types of locks called intention locks are used. Intention locks are table locks in InnoDB that indicate which type of lock (shared or exclusive) a transaction will require later for a row in that table. There are two types of intention locks used in InnoDB</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-277603" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/10c7a5b56f4d67f33136872e2e7e2cce.png" srcset="http://1.gravatar.com/avatar/10c7a5b56f4d67f33136872e2e7e2cce?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-277603">
				
				江河汇
									</span>
								<div class="date">11月 2nd, 201516:10</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=277603#respond" onclick="return addComment.moveForm( &quot;comment-277603&quot;, &quot;277603&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给江河汇">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-277603&#39;, &#39;comment-277603&#39;, &#39;commentbody-277603&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-277603">#158</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-277603">
					<p>针对SQL：select * from t1 where id = 10 for update; 第一次查询，没有找到满足查询条件的记录，那么GAP锁是否还能够省略？此问题留给大家思考。</p>
<p>这个不需要了吧。在rr隔离级别下， 第一次查询一般新建readview，假如有其他的事物插入了一条，在进行读取的时候能够通过readview机制，读不到新的事物插入的记录。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-279118" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/96ca71a7321869e5967fd7521e7e3a06.png" srcset="http://0.gravatar.com/avatar/96ca71a7321869e5967fd7521e7e3a06?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-279118">
				
				liuyingjie
									</span>
								<div class="date">11月 9th, 201517:44</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=279118#respond" onclick="return addComment.moveForm( &quot;comment-279118&quot;, &quot;279118&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给liuyingjie">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-279118&#39;, &#39;comment-279118&#39;, &#39;commentbody-279118&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-279118">#159</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-279118">
					<p>何老师，我的生产环境中时长出现子查询的情况，而子查询又往往与join操作联系在一起</p>
<p>当join操作之后，又使用where 条件进行过滤时，请问加锁是根据join操作中选择的字段呢  还是  根据where条件中的字段</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-280767" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/c834889a9f6c9bbb646b6b2a4cd8ef8c.png" srcset="http://0.gravatar.com/avatar/c834889a9f6c9bbb646b6b2a4cd8ef8c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-280767">
				
				chengweiming
									</span>
								<div class="date">11月 16th, 201511:00</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=280767#respond" onclick="return addComment.moveForm( &quot;comment-280767&quot;, &quot;280767&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给chengweiming">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-280767&#39;, &#39;comment-280767&#39;, &#39;commentbody-280767&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-280767">#160</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-280767">
					<p>登博，辛苦帮忙看看。<br>
验证加锁复杂SQL的实践：</p>
<p> MYSQL 5.6,ICP在使用中遇到LOCK的问题，求解惑，详情见下文：<br>
环境：<br>
        数据库版本：mysql  Ver 14.14 Distrib 5.6.25, for Linux (x86_64) using  EditLine wrapper<br>
        数据库隔离级别： REPEATABLE-READ<br>
        autocommit    ：OFF                     optimizer_switch：index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,subquery_materialization_cost_based=on,use_index_extensions=on<br>
数据：<br>
1、 表结构：<br>
  mysql&gt; show create table t1\G<br>
*************************** 1. row ***************************<br>
       Table: t1<br>
Create Table: CREATE TABLE `t1` (<br>
  `a` int(11) NOT NULL,<br>
  `b` int(11) NOT NULL,<br>
  `c` int(11) NOT NULL,<br>
  `d` int(11) NOT NULL,<br>
  `e` varchar(20) DEFAULT NULL,<br>
  PRIMARY KEY (`a`),<br>
  KEY `idx_t1_bcd` (`b`,`c`,`d`)<br>
) ENGINE=InnoDB DEFAULT CHARSET=latin1<br>
1 row in set (0.00 sec)</p>
<p>2、表数据：<br>
mysql&gt; select * from t1;<br>
+—+—+—+—+——+<br>
| a | b | c | d | e    |<br>
+—+—+—+—+——+<br>
| 1 | 1 | 1 | 1 | a    |<br>
| 2 | 2 | 2 | 2 | b    |<br>
| 3 | 3 | 2 | 2 | c    |<br>
| 4 | 3 | 1 | 1 | d    |<br>
| 5 | 2 | 3 | 5 | e    |<br>
| 6 | 6 | 4 | 4 | f    |<br>
| 7 | 4 | 5 | 5 | g    |<br>
| 8 | 8 | 8 | 8 | h    |<br>
+—+—+—+—+——+<br>
8 rows in set (0.00 sec)</p>
<p>操作过程：<br>
session 1:<br>
         delete from t1 where b&gt;2 and b explain select * from t1 where b&gt;2 and b select * from information_schema.innodb_locks;+—————+————-+———–+———–+————-+————+————+———–+———-+———–+<br>
| lock_id       | lock_trx_id | lock_mode | lock_type | lock_table  | lock_index | lock_space | lock_page | lock_rec | lock_data |<br>
+—————+————-+———–+———–+————-+————+————+———–+———-+———–+<br>
| 38777:390:3:5 | 38777       | X         | RECORD    | `test`.`t1` | PRIMARY    |        390 |         3 |        5 | 4         |<br>
| 38771:390:3:5 | 38771       | X         | RECORD    | `test`.`t1` | PRIMARY    |        390 |         3 |        5 | 4         |<br>
+—————+————-+———–+———–+————-+————+————+———–+———-+———–+</p>
<p>根据锁及ICP的知识，此时加锁的情况应该是在索引  idx_t1_bcd 上的b&gt;2 and b&lt;5之间加gap lock,<br>
                    idx_t1_bcd 上的c=2 加 X锁<br>
             主键 a=3 加 x 锁。<br>
应该a=4上是没有加X锁的，可以进行删除与更改。<br>
但是从session3上的结果来，此时a=4上被加上了X锁。</p>
<p>添加lock monitor,加锁详情如下：<br>
设置：set global innodb_status_output_locks=on</p>
<p>show engine innodb status:</p>
<p>—TRANSACTION 39948, ACTIVE 15 sec<br>
3 lock struct(s), heap size 360, 8 row lock(s), undo log entries 1<br>
MySQL thread id 1, OS thread handle 0x7f7f44263700, query id 15 127.0.0.1 root cleaning up<br>
TABLE LOCK table `test`.`t1` trx id 39948 lock mode IX<br>
RECORD LOCKS space id 390 page no 4 n bits 80 index `idx_t1_bcd` of table `test`.`t1` trx id 39948 lock_mode X<br>
Record lock, heap no 5 PHYSICAL RECORD: n_fields 4; compact format; info bits 0<br>
0: len 4; hex 80000003; asc     ;;<br>
1: len 4; hex 80000001; asc     ;;<br>
2: len 4; hex 80000001; asc     ;;<br>
3: len 4; hex 80000004; asc     ;;</p>
<p>Record lock, heap no 6 PHYSICAL RECORD: n_fields 4; compact format; info bits 32<br>
0: len 4; hex 80000003; asc     ;;<br>
1: len 4; hex 80000002; asc     ;;<br>
2: len 4; hex 80000002; asc     ;;<br>
3: len 4; hex 80000003; asc     ;;</p>
<p>Record lock, heap no 7 PHYSICAL RECORD: n_fields 4; compact format; info bits 0<br>
0: len 4; hex 80000004; asc     ;;<br>
1: len 4; hex 80000005; asc     ;;<br>
2: len 4; hex 80000005; asc     ;;<br>
3: len 4; hex 80000007; asc     ;;</p>
<p>Record lock, heap no 8 PHYSICAL RECORD: n_fields 4; compact format; info bits 0<br>
0: len 4; hex 80000006; asc     ;;<br>
1: len 4; hex 80000004; asc     ;;<br>
2: len 4; hex 80000004; asc     ;;<br>
3: len 4; hex 80000006; asc     ;;</p>
<p>RECORD LOCKS space id 390 page no 3 n bits 80 index `PRIMARY` of table `test`.`t1` trx id 39948 lock_mode X locks rec but not gap<br>
Record lock, heap no 4 PHYSICAL RECORD: n_fields 7; compact format; info bits 32<br>
0: len 4; hex 80000003; asc     ;;<br>
1: len 6; hex 000000009c0c; asc       ;;<br>
2: len 7; hex 0b000001e20224; asc       $;;<br>
3: len 4; hex 80000003; asc     ;;<br>
4: len 4; hex 80000002; asc     ;;<br>
5: len 4; hex 80000002; asc     ;;<br>
6: len 1; hex 63; asc c;;</p>
<p>Record lock, heap no 5 PHYSICAL RECORD: n_fields 7; compact format; info bits 0<br>
0: len 4; hex 80000004; asc     ;;<br>
1: len 6; hex 000000009770; asc      p;;<br>
2: len 7; hex 200000026e0e30; asc     n 0;;<br>
3: len 4; hex 80000003; asc     ;;<br>
4: len 4; hex 80000001; asc     ;;<br>
5: len 4; hex 80000001; asc     ;;<br>
6: len 1; hex 64; asc d;;</p>
<p>Record lock, heap no 7 PHYSICAL RECORD: n_fields 7; compact format; info bits 0<br>
0: len 4; hex 80000006; asc     ;;<br>
1: len 6; hex 00000000970e; asc       ;;<br>
2: len 7; hex dd000001eb0110; asc        ;;<br>
3: len 4; hex 80000006; asc     ;;<br>
4: len 4; hex 80000004; asc     ;;<br>
5: len 4; hex 80000004; asc     ;;<br>
6: len 1; hex 66; asc f;;</p>
<p>Record lock, heap no 8 PHYSICAL RECORD: n_fields 7; compact format; info bits 0<br>
0: len 4; hex 80000007; asc     ;;<br>
1: len 6; hex 00000000970d; asc       ;;<br>
2: len 7; hex dc000001710110; asc     q  ;;<br>
3: len 4; hex 80000004; asc     ;;<br>
4: len 4; hex 80000005; asc     ;;<br>
5: len 4; hex 80000005; asc     ;;<br>
6: len 1; hex 67; asc g;;</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-280769" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/c834889a9f6c9bbb646b6b2a4cd8ef8c.png" srcset="http://0.gravatar.com/avatar/c834889a9f6c9bbb646b6b2a4cd8ef8c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-280769">
				
				chengweiming
									</span>
								<div class="date">11月 16th, 201511:08</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=280769#respond" onclick="return addComment.moveForm( &quot;comment-280769&quot;, &quot;280769&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给chengweiming">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-280769&#39;, &#39;comment-280769&#39;, &#39;commentbody-280769&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-280769">#161</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-280769">
					<p>上面的操作过程显示乱了，我重新贴下：</p>
<p>操作过程：<br>
session 1:<br>
         delete from t1 where b&gt;2 and b explain select * from t1 where b&gt;2 and b select * from information_schema.innodb_locks;+—————+————-+———–+———–+————-+————+————+———–+———-+———–+<br>
| lock_id       | lock_trx_id | lock_mode | lock_type | lock_table  | lock_index | lock_space | lock_page | lock_rec | lock_data |<br>
+—————+————-+———–+———–+————-+————+————+———–+———-+———–+<br>
| 38777:390:3:5 | 38777       | X         | RECORD    | `test`.`t1` | PRIMARY    |        390 |         3 |        5 | 4         |<br>
| 38771:390:3:5 | 38771       | X         | RECORD    | `test`.`t1` | PRIMARY    |        390 |         3 |        5 | 4         |<br>
+—————+————-+———–+———–+————-+————+————+———–+———-+———–+</p>
<p>根据锁及ICP的知识，此时加锁的情况应该是在索引  idx_t1_bcd 上的b&gt;2 and b&lt;5之间加gap lock,<br>
                    idx_t1_bcd 上的c=2 加 X锁<br>
             主键 a=3 加 x 锁。<br>
应该a=4上是没有加X锁的，可以进行删除与更改。<br>
但是从session3上的结果来，此时a=4上被加上了X锁。</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-280770" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/c834889a9f6c9bbb646b6b2a4cd8ef8c.png" srcset="http://0.gravatar.com/avatar/c834889a9f6c9bbb646b6b2a4cd8ef8c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-280770">
				
				chengweiming
									</span>
								<div class="date">11月 16th, 201511:11</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=280770#respond" onclick="return addComment.moveForm( &quot;comment-280770&quot;, &quot;280770&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给chengweiming">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-280770&#39;, &#39;comment-280770&#39;, &#39;commentbody-280770&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-280770">#162</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-280770">
					<p>贴上去就显示错乱了，不好意思。<br>
session 1:<br>
         ‘delete from t1 where b&gt;2 and b&lt;5 and c=2;’</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-280771" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/c834889a9f6c9bbb646b6b2a4cd8ef8c.png" srcset="http://0.gravatar.com/avatar/c834889a9f6c9bbb646b6b2a4cd8ef8c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-280771">
				
				chengweiming
									</span>
								<div class="date">11月 16th, 201511:12</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=280771#respond" onclick="return addComment.moveForm( &quot;comment-280771&quot;, &quot;280771&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给chengweiming">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-280771&#39;, &#39;comment-280771&#39;, &#39;commentbody-280771&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-280771">#163</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-280771">
					<p>session 2:<br>
            delete from t1 where a=4<br>
————被锁住</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-280772" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/c834889a9f6c9bbb646b6b2a4cd8ef8c.png" srcset="http://0.gravatar.com/avatar/c834889a9f6c9bbb646b6b2a4cd8ef8c?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-280772">
				
				chengweiming
									</span>
								<div class="date">11月 16th, 201511:12</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=280772#respond" onclick="return addComment.moveForm( &quot;comment-280772&quot;, &quot;280772&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给chengweiming">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-280772&#39;, &#39;comment-280772&#39;, &#39;commentbody-280772&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-280772">#164</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-280772">
					<p>session 3:<br>
            mysql&gt; select * from information_schema.innodb_locks;+—————+————-+———–+———–+————-+————+————+———–+———-+———–+<br>
| lock_id       | lock_trx_id | lock_mode | lock_type | lock_table  | lock_index | lock_space | lock_page | lock_rec | lock_data |<br>
+—————+————-+———–+———–+————-+————+————+———–+———-+———–+<br>
| 38777:390:3:5 | 38777       | X         | RECORD    | `test`.`t1` | PRIMARY    |        390 |         3 |        5 | 4         |<br>
| 38771:390:3:5 | 38771       | X         | RECORD    | `test`.`t1` | PRIMARY    |        390 |         3 |        5 | 4         |<br>
+—————+————-+———–+———–+————-+————+————+———–+———-+———–+</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-295199" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-295199" href="http://phpor.net/blog/post/3186" rel="external nofollow">
				
				关于mysql锁的学习 | PHPor 的Blog
									</a>
								<div class="date">12月 25th, 201515:15</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-295199">#165</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-297636" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/49ade21b14846e41684616c6e7209db3.jpeg" srcset="http://1.gravatar.com/avatar/49ade21b14846e41684616c6e7209db3?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-297636">
				
				chinaxing
									</span>
								<div class="date">1月 5th, 201611:34</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=297636#respond" onclick="return addComment.moveForm( &quot;comment-297636&quot;, &quot;297636&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给chinaxing">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-297636&#39;, &#39;comment-297636&#39;, &#39;commentbody-297636&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-297636">#166</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-297636">
					<p>博主好，我这边也遇到一个比较费解的mysql 死锁。根据你的文章自己思考了没分析出来。帮忙分析下，多谢了：）</p>
<p><a href="http://stackoverflow.com/questions/34593744/why-insert-statement-hold-gap-lock-in-mysql-innodb" rel="nofollow">http://stackoverflow.com/questions/34593744/why-insert-statement-hold-gap-lock-in-mysql-innodb</a></p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-298207" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/bc0f471d3fc21ba2da54b3e5e564e895.png" srcset="http://2.gravatar.com/avatar/bc0f471d3fc21ba2da54b3e5e564e895?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-298207" href="http://www.163.com/special/0077450P/login_frame.html" rel="external nofollow">
				
				welyss
									</a>
								<div class="date">1月 8th, 201614:30</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=298207#respond" onclick="return addComment.moveForm( &quot;comment-298207&quot;, &quot;298207&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给welyss">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-298207&#39;, &#39;comment-298207&#39;, &#39;commentbody-298207&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-298207">#167</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-298207">
					<p>这是我见过的，mysql最棒的博文了！非常浅显易懂，感谢lz分享</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-301377" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/9d9fd6957d342b2467ec2a4d4aff671a.png" srcset="http://0.gravatar.com/avatar/9d9fd6957d342b2467ec2a4d4aff671a?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-301377">
				
				小马哥
									</span>
								<div class="date">2月 3rd, 201616:36</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=301377#respond" onclick="return addComment.moveForm( &quot;comment-301377&quot;, &quot;301377&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给小马哥">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-301377&#39;, &#39;comment-301377&#39;, &#39;commentbody-301377&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-301377">#168</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-301377">
					<p>非常不错</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-301698" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-301698" href="http://www.itdadao.com/article/347376/" rel="external nofollow">
				
				mysql死锁问题分析-IT大道
									</a>
								<div class="date">2月 5th, 201616:33</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-301698">#169</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-312969" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-312969" href="http://www.wangerbao.com/?p=694" rel="external nofollow">
				
				MySQL 加锁处理分析 | 王二宝的小站
									</a>
								<div class="date">3月 10th, 201618:06</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-312969">#170</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-313471" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-313471" href="http://chattool.sinaapp.com/?p=1423" rel="external nofollow">
				
				MySQL/InnoDB 加锁处理分析 | phper
									</a>
								<div class="date">3月 11th, 201613:44</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-313471">#171</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-323239" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-323239" href="http://www.codeceo.com/article/mysql-deadlock.html" rel="external nofollow">
				
				MySQL 死锁问题分析 – 码农网
									</a>
								<div class="date">4月 1st, 201615:59</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-323239">#172</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-326019" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/2a61768a66c81b550aa7979160f128f9.png" srcset="http://2.gravatar.com/avatar/2a61768a66c81b550aa7979160f128f9?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-326019">
				
				书生
									</span>
								<div class="date">4月 7th, 201621:35</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=326019#respond" onclick="return addComment.moveForm( &quot;comment-326019&quot;, &quot;326019&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给书生">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-326019&#39;, &#39;comment-326019&#39;, &#39;commentbody-326019&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-326019">#173</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-326019">
					<p>请教博主个问题，在组合七的情况下，如果一个session执行:<br>
select * from myt where id&gt;10 for update;<br>
而第二个session插入记录：<br>
insert into myt values(‘bb’, 10);<br>
第二个session的插入操作会卡住，求教下第一个语句加的锁是哪些？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-326020" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/2a61768a66c81b550aa7979160f128f9.png" srcset="http://2.gravatar.com/avatar/2a61768a66c81b550aa7979160f128f9?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-326020">
				
				书生
									</span>
								<div class="date">4月 7th, 201621:36</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=326020#respond" onclick="return addComment.moveForm( &quot;comment-326020&quot;, &quot;326020&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给书生">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-326020&#39;, &#39;comment-326020&#39;, &#39;commentbody-326020&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-326020">#174</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-326020">
					<p>请教博主个问题，在组合七的情况下，如果一个session执行:<br>
select * from T1 where id&gt;10 for update;<br>
而第二个session插入记录：<br>
insert into T1 values(‘bb’, 10);<br>
第二个session的插入操作会卡住，求教下第一个语句加的锁是哪些？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-331705" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/e2bfb8656cb8d00bbb9fcba36261d8d6.png" srcset="http://2.gravatar.com/avatar/e2bfb8656cb8d00bbb9fcba36261d8d6?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-331705">
				
				gameanimal
									</span>
								<div class="date">4月 23rd, 201613:40</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=331705#respond" onclick="return addComment.moveForm( &quot;comment-331705&quot;, &quot;331705&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给gameanimal">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-331705&#39;, &#39;comment-331705&#39;, &#39;commentbody-331705&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-331705">#175</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-331705">
					<p>何大师您好：<br>
最近工作中使用mysql的过程中遇到一个死锁，<br>
mysql version  5.5.20<br>
事务隔离级别是read committed<br>
表结构<br>
create table if not exists  ‘m’<br>
(<br>
  aid                             bigint                        not null AUTO_INCREMENT,<br>
  id                            bigint                        not null default -1,<br>
  sendguid                        bigint                        not null default -1,<br>
  sendname                        varchar(80) binary            not null,<br>
  writetime                       bigint                        not null default  0,<br>
  receiveguid                     bigint                        not null default -1,<br>
  readtime                        bigint                        not null default  0,<br>
  mailtype                        smallint                      not null default  0,<br>
  content                         varchar(192)                  not null,<br>
  moneytype                       smallint                      not null default  0,<br>
  moneyvalue                      int                           not null default  0,<br>
  boxtype                         tinyint                       not null default  0,<br>
  isvalid                         tinyint                       not null default  0,<br>
  itemguid                        bigint                        not null default -1,<br>
  dataid                          int                           not null default -1,<br>
  binded                          tinyint                       not null default -1,<br>
  stackcount                      smallint                      not null default -1,<br>
  createtime                      bigint                        not null default -1,<br>
  enchancelevel                   smallint                      not null default -1,<br>
  enchanceexp                     int                           not null default -1,<br>
  enchancetotalexp                bigint                        not null default -1,<br>
  starlevel                       smallint                      not null default -1,<br>
  startimes                       smallint                      not null default -1,<br>
  dynamicdata1                    int                           not null default -1,<br>
  dynamicdata2                    int                           not null default -1,<br>
  dynamicdata3                    int                           not null default -1,<br>
  dynamicdata4                    int                           not null default -1,<br>
  dynamicdata5                    int                           not null default -1,<br>
  dynamicdata6                    int                           not null default -1,<br>
  dynamicdata7                    int                           not null default -1,<br>
  dynamicdata8                    int                           not null default -1,<br>
  origin                          int                           not null default 0,<br>
  primary key (aid)<br>
)ENGINE = INNODB;</p>
<p>create unique index Index_mail_guid on t_usermail<br>
(<br>
  guid,<br>
  boxtype<br>
);<br>
create index Index_mail_charguid on t_usermail<br>
(<br>
  receiveguid,<br>
  boxtype<br>
);</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-347137" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/70914bd533b5bb4a2b5307042199bdba.png" srcset="http://1.gravatar.com/avatar/70914bd533b5bb4a2b5307042199bdba?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<span class="authorname" id="commentauthor-347137">
				
				970807800@qq.com
									</span>
								<div class="date">6月 15th, 201614:19</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=347137#respond" onclick="return addComment.moveForm( &quot;comment-347137&quot;, &quot;347137&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给970807800@qq.com">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-347137&#39;, &#39;comment-347137&#39;, &#39;commentbody-347137&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-347137">#176</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-347137">
					<p>博主好，我在我本地测试第二个死锁例子时，只会报”ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transacti”，并没有死锁，本人对锁机制不是很清楚，能帮忙解惑吗？</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-365060" class="comment regularcomment">

		<div class="info regularinfo">
			<div class="pic"><img alt="" src="./何登成的技术博客 » MySQL 加锁处理分析_files/118cf1e797f97f85bd4f8fe2af1ea00a.png" srcset="http://1.gravatar.com/avatar/118cf1e797f97f85bd4f8fe2af1ea00a?s=48&amp;d=mm&amp;r=g 2x" class="avatar avatar-24 photo" height="24" width="24"></div>			<div class="author">
									<a class="authorname" id="commentauthor-365060" href="http://foolchild.cn/" rel="external nofollow">
				
				fool
									</a>
								<div class="date">7月 20th, 201619:24</div>
			</div>
			<div class="count">
															<a rel="nofollow" class="comment-reply-link" href="http://hedengcheng.com/?p=771&amp;replytocom=365060#respond" onclick="return addComment.moveForm( &quot;comment-365060&quot;, &quot;365060&quot;, &quot;respond&quot;, &quot;771&quot; )" aria-label="回复给fool">回复</a> | 										<a href="javascript:void(0);" onclick="MGJS_CMT.quote(&#39;commentauthor-365060&#39;, &#39;comment-365060&#39;, &#39;commentbody-365060&#39;, &#39;comment&#39;);">引用</a> | 
												<a href="http://hedengcheng.com/?p=771#comment-365060">#177</a>
			</div>
			<div class="fixed"></div>
		</div>

					<div class="content">
				
				<div id="commentbody-365060">
					<p>?</p>
				</div>
			</div>
		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	<li id="comment-368267" class="comment pingcomment">

		<div class="info pinginfo">
						<div class="author">
									<a class="authorname" id="commentauthor-368267" href="http://www.aliog.com/126552.html" rel="external nofollow">
				
				mysql事务和锁InnoDB_阿里欧歌
									</a>
								<div class="date">8月 7th, 201616:05</div>
			</div>
			<div class="count">
												<a href="http://hedengcheng.com/?p=771#comment-368267">#178</a>
			</div>
			<div class="fixed"></div>
		</div>

		
		<div class="fixed"></div>

</li><!-- #comment-## -->
	</ol>



	<div id="respond">
	<form id="commentform" action="http://hedengcheng.com/wp-comments-post.php" method="post">

					<a rel="nofollow" id="cancel-comment-reply-link" href="http://hedengcheng.com/?p=771#respond" style="display:none;">Cancel reply</a>		
		<!-- comment info -->
					
			<div id="author_info">
				<div class="row">
					<input type="text" name="author" id="author" class="textfield" value="" size="24" tabindex="1">
					<label for="author" class="small">昵称 (必填)</label>
				</div>
				<div class="row">
					<input type="text" name="email" id="email" class="textfield" value="" size="24" tabindex="2">
					<label for="email" class="small">电子邮箱 (我们会为您保密) (必填)</label>
				</div>
				<div class="row">
					<input type="text" name="url" id="url" class="textfield" value="" size="24" tabindex="3">
					<label for="url" class="small">网址</label>
				</div>
			</div>

			
		
	<!-- comment input -->
	<div class="row">
		<textarea name="comment" id="comment" tabindex="4" rows="8" cols="50"></textarea>
	</div>

	<!-- comment submit and rss -->
	<div id="submitbox">
		<a class="feed" href="feed:http://hedengcheng.com/?feed=comments-rss2">订阅评论</a>
		<input name="submit" type="submit" id="submit" class="button" tabindex="5" value="提交评论">
				<input type="hidden" name="comment_post_ID" value="771">
		<div class="fixed"></div>
	</div>

			<input type="hidden" name="comment_post_ID" value="771" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="365e39a951"></p><p style="display: none;"></p>
	<input type="hidden" id="ak_js" name="ak_js" value="1535863784166"></form>
	</div>

	

	</div>
	<!-- main END -->

		
<!-- sidebar START -->
<div id="sidebar">

	<!-- showcase -->
	

	<!-- recent posts -->
	<div class="widget widget_pages">
		<h3>Recent Posts</h3>
		<ul>
						<li><a href="http://hedengcheng.com/?p=1005" id="post-1005">2017阿里巴巴云栖大会数据库内核专场，内容概要</a></li>
						<li><a href="http://hedengcheng.com/?p=985" id="post-985">阿里巴巴数据库内核团队简介&amp;纳新</a></li>
						<li><a href="http://hedengcheng.com/?p=970" id="post-970">生活中的Paxos，原来你我都在使用——对Paxos生活化的解读</a></li>
						<li><a href="http://hedengcheng.com/?p=892" id="post-892">数据一致性-分区可用性-性能——多副本强同步数据库系统实现之我见</a></li>
						<li><a href="http://hedengcheng.com/?p=844" id="post-844">一个最不可思议的MySQL死锁分析</a></li>
					</ul>
	</div>

	<!-- recent comments -->
	
	<!-- tag cloud -->
	<div class="widget widget_tag_cloud">
		<h3>Tag Cloud</h3>
		<a href="http://hedengcheng.com/?tag=2pc" class="tag-link-27 tag-link-position-1" title="1个话题" style="font-size: 8pt;">2PC</a>
<a href="http://hedengcheng.com/?tag=5-6" class="tag-link-121 tag-link-position-2" title="2个话题" style="font-size: 9.2521739130435pt;">5.6</a>
<a href="http://hedengcheng.com/?tag=add-index" class="tag-link-81 tag-link-position-3" title="2个话题" style="font-size: 9.2521739130435pt;">add index</a>
<a href="http://hedengcheng.com/?tag=aio" class="tag-link-17 tag-link-position-4" title="2个话题" style="font-size: 9.2521739130435pt;">AIO</a>
<a href="http://hedengcheng.com/?tag=b-tree" class="tag-link-89 tag-link-position-5" title="2个话题" style="font-size: 9.2521739130435pt;">B+-Tree</a>
<a href="http://hedengcheng.com/?tag=block" class="tag-link-25 tag-link-position-6" title="1个话题" style="font-size: 8pt;">Block</a>
<a href="http://hedengcheng.com/?tag=buffer-pool" class="tag-link-68 tag-link-position-7" title="3个话题" style="font-size: 10.086956521739pt;">Buffer Pool</a>
<a href="http://hedengcheng.com/?tag=checkpoint" class="tag-link-13 tag-link-position-8" title="2个话题" style="font-size: 9.2521739130435pt;">Checkpoint</a>
<a href="http://hedengcheng.com/?tag=cpu" class="tag-link-96 tag-link-position-9" title="2个话题" style="font-size: 9.2521739130435pt;">CPU</a>
<a href="http://hedengcheng.com/?tag=crash-recovery" class="tag-link-34 tag-link-position-10" title="4个话题" style="font-size: 10.782608695652pt;">Crash Recovery</a>
<a href="http://hedengcheng.com/?tag=database" class="tag-link-161 tag-link-position-11" title="4个话题" style="font-size: 10.782608695652pt;">Database</a>
<a href="http://hedengcheng.com/?tag=data-cache" class="tag-link-69 tag-link-position-12" title="2个话题" style="font-size: 9.2521739130435pt;">Data Cache</a>
<a href="http://hedengcheng.com/?tag=deadlock" class="tag-link-141 tag-link-position-13" title="2个话题" style="font-size: 9.2521739130435pt;">Deadlock</a>
<a href="http://hedengcheng.com/?tag=group-commit" class="tag-link-22 tag-link-position-14" title="3个话题" style="font-size: 10.086956521739pt;">Group Commit</a>
<a href="http://hedengcheng.com/?tag=2-2" class="tag-link-10 tag-link-position-15" title="27个话题" style="font-size: 16pt;">InnoDB</a>
<a href="http://hedengcheng.com/?tag=insert-buffer" class="tag-link-16 tag-link-position-16" title="2个话题" style="font-size: 9.2521739130435pt;">Insert Buffer</a>
<a href="http://hedengcheng.com/?tag=join" class="tag-link-44 tag-link-position-17" title="2个话题" style="font-size: 9.2521739130435pt;">join</a>
<a href="http://hedengcheng.com/?tag=linux" class="tag-link-18 tag-link-position-18" title="1个话题" style="font-size: 8pt;">Linux</a>
<a href="http://hedengcheng.com/?tag=lock" class="tag-link-60 tag-link-position-19" title="3个话题" style="font-size: 10.086956521739pt;">Lock</a>
<a href="http://hedengcheng.com/?tag=mariadb" class="tag-link-21 tag-link-position-20" title="1个话题" style="font-size: 8pt;">MariaDB</a>
<a href="http://hedengcheng.com/?tag=mvcc" class="tag-link-30 tag-link-position-21" title="3个话题" style="font-size: 10.086956521739pt;">MVCC</a>
<a href="http://hedengcheng.com/?tag=1-2" class="tag-link-9 tag-link-position-22" title="18个话题" style="font-size: 14.817391304348pt;">MySQL</a>
<a href="http://hedengcheng.com/?tag=mysql-bug" class="tag-link-56 tag-link-position-23" title="3个话题" style="font-size: 10.086956521739pt;">MySQL BUG</a>
<a href="http://hedengcheng.com/?tag=online" class="tag-link-84 tag-link-position-24" title="2个话题" style="font-size: 9.2521739130435pt;">online</a>
<a href="http://hedengcheng.com/?tag=22" class="tag-link-155 tag-link-position-25" title="5个话题" style="font-size: 11.339130434783pt;">Oracle</a>
<a href="http://hedengcheng.com/?tag=page" class="tag-link-23 tag-link-position-26" title="1个话题" style="font-size: 8pt;">Page</a>
<a href="http://hedengcheng.com/?tag=percona" class="tag-link-14 tag-link-position-27" title="4个话题" style="font-size: 10.782608695652pt;">Percona</a>
<a href="http://hedengcheng.com/?tag=range-query" class="tag-link-63 tag-link-position-28" title="2个话题" style="font-size: 9.2521739130435pt;">Range Query</a>
<a href="http://hedengcheng.com/?tag=readview" class="tag-link-32 tag-link-position-29" title="1个话题" style="font-size: 8pt;">ReadView</a>
<a href="http://hedengcheng.com/?tag=redo" class="tag-link-80 tag-link-position-30" title="2个话题" style="font-size: 9.2521739130435pt;">Redo</a>
<a href="http://hedengcheng.com/?tag=rollback-segment" class="tag-link-39 tag-link-position-31" title="3个话题" style="font-size: 10.086956521739pt;">Rollback Segment</a>
<a href="http://hedengcheng.com/?tag=row" class="tag-link-26 tag-link-position-32" title="2个话题" style="font-size: 9.2521739130435pt;">Row</a>
<a href="http://hedengcheng.com/?tag=transaction" class="tag-link-50 tag-link-position-33" title="2个话题" style="font-size: 9.2521739130435pt;">transaction</a>
<a href="http://hedengcheng.com/?tag=trasaction" class="tag-link-35 tag-link-position-34" title="3个话题" style="font-size: 10.086956521739pt;">Trasaction</a>
<a href="http://hedengcheng.com/?tag=undo" class="tag-link-42 tag-link-position-35" title="3个话题" style="font-size: 10.086956521739pt;">Undo</a>
<a href="http://hedengcheng.com/?tag=xa" class="tag-link-28 tag-link-position-36" title="2个话题" style="font-size: 9.2521739130435pt;">XA</a>
<a href="http://hedengcheng.com/?tag=xtradb" class="tag-link-15 tag-link-position-37" title="3个话题" style="font-size: 10.086956521739pt;">XtraDB</a>
<a href="http://hedengcheng.com/?tag=%e4%b8%ad%e6%96%ad" class="tag-link-19 tag-link-position-38" title="1个话题" style="font-size: 8pt;">中断</a>
<a href="http://hedengcheng.com/?tag=%e5%88%86%e5%b8%83%e5%bc%8f" class="tag-link-150 tag-link-position-39" title="2个话题" style="font-size: 9.2521739130435pt;">分布式</a>
<a href="http://hedengcheng.com/?tag=%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" class="tag-link-29 tag-link-position-40" title="2个话题" style="font-size: 9.2521739130435pt;">分布式事务</a>
<a href="http://hedengcheng.com/?tag=%e5%a4%9a%e7%89%88%e6%9c%ac" class="tag-link-31 tag-link-position-41" title="2个话题" style="font-size: 9.2521739130435pt;">多版本</a>
<a href="http://hedengcheng.com/?tag=3" class="tag-link-11 tag-link-position-42" title="3个话题" style="font-size: 10.086956521739pt;">数据库</a>
<a href="http://hedengcheng.com/?tag=%e6%95%b0%e6%8d%ae%e5%ba%93%e5%86%85%e6%a0%b8%e5%88%86%e4%ba%ab" class="tag-link-160 tag-link-position-43" title="3个话题" style="font-size: 10.086956521739pt;">数据库内核分享</a>
<a href="http://hedengcheng.com/?tag=%e6%97%a5%e5%bf%97" class="tag-link-24 tag-link-position-44" title="2个话题" style="font-size: 9.2521739130435pt;">日志</a>
<a href="http://hedengcheng.com/?tag=%e8%bd%af%e4%b8%ad%e6%96%ad" class="tag-link-20 tag-link-position-45" title="1个话题" style="font-size: 8pt;">软中断</a>	</div>

	<!-- categories -->
	<div class="widget widget_categories">
		<h3>Categories</h3>
		<ul>
				<li class="cat-item cat-item-148"><a href="http://hedengcheng.com/?cat=148">Architecture</a> (1)
</li>
	<li class="cat-item cat-item-138"><a href="http://hedengcheng.com/?cat=138">C/C++</a> (2)
</li>
	<li class="cat-item cat-item-149"><a href="http://hedengcheng.com/?cat=149">Distributed</a> (2)
</li>
	<li class="cat-item cat-item-53"><a href="http://hedengcheng.com/?cat=53">Falcon</a> (1)
</li>
	<li class="cat-item cat-item-95"><a href="http://hedengcheng.com/?cat=95">Hardware</a> (3)
</li>
	<li class="cat-item cat-item-62"><a href="http://hedengcheng.com/?cat=62">Optimizer</a> (2)
</li>
	<li class="cat-item cat-item-134"><a href="http://hedengcheng.com/?cat=134">Performance</a> (1)
</li>
	<li class="cat-item cat-item-117"><a href="http://hedengcheng.com/?cat=117">Programming</a> (7)
</li>
	<li class="cat-item cat-item-105"><a href="http://hedengcheng.com/?cat=105">Test</a> (1)
</li>
	<li class="cat-item cat-item-70"><a href="http://hedengcheng.com/?cat=70">TPCC</a> (1)
</li>
	<li class="cat-item cat-item-4"><a href="http://hedengcheng.com/?cat=4" title="包含所有的数据库技术文档">数据库</a> (45)
<ul class="children">
	<li class="cat-item cat-item-6"><a href="http://hedengcheng.com/?cat=6" title="InnoDB引擎文档">InnoDB</a> (34)
</li>
	<li class="cat-item cat-item-5"><a href="http://hedengcheng.com/?cat=5" title="MySQL Server文档">MySQL Server</a> (27)
</li>
	<li class="cat-item cat-item-7"><a href="http://hedengcheng.com/?cat=7" title="Oracle数据库文档">Oracle</a> (6)
</li>
	<li class="cat-item cat-item-8"><a href="http://hedengcheng.com/?cat=8" title="PostgreSQL数据库文档">PostgreSQL</a> (1)
</li>
</ul>
</li>
	<li class="cat-item cat-item-73"><a href="http://hedengcheng.com/?cat=73">数据库内核分享</a> (14)
</li>
	<li class="cat-item cat-item-101"><a href="http://hedengcheng.com/?cat=101">数据库研发</a> (6)
</li>
	<li class="cat-item cat-item-3"><a href="http://hedengcheng.com/?cat=3" title="个人的一些随笔。">杂谈</a> (3)
</li>
		</ul>
	</div>

	<!-- archives -->
	<div id="archives" class="widget widget_archive">
		<h3>Archives</h3>
		<ul>
				<li><a href="http://hedengcheng.com/?m=201709">2017年九月</a></li>
	<li><a href="http://hedengcheng.com/?m=201703">2017年三月</a></li>
	<li><a href="http://hedengcheng.com/?m=201605">2016年五月</a></li>
	<li><a href="http://hedengcheng.com/?m=201503">2015年三月</a></li>
	<li><a href="http://hedengcheng.com/?m=201401">2014年一月</a></li>
	<li><a href="http://hedengcheng.com/?m=201312">2013年十二月</a></li>
	<li><a href="http://hedengcheng.com/?m=201311">2013年十一月</a></li>
	<li><a href="http://hedengcheng.com/?m=201307">2013年七月</a></li>
	<li><a href="http://hedengcheng.com/?m=201304">2013年四月</a></li>
	<li><a href="http://hedengcheng.com/?m=201303">2013年三月</a></li>
	<li><a href="http://hedengcheng.com/?m=201302">2013年二月</a></li>
	<li><a href="http://hedengcheng.com/?m=201301">2013年一月</a></li>
	<li><a href="http://hedengcheng.com/?m=201212">2012年十二月</a></li>
	<li><a href="http://hedengcheng.com/?m=201211">2012年十一月</a></li>
	<li><a href="http://hedengcheng.com/?m=201210">2012年十月</a></li>
	<li><a href="http://hedengcheng.com/?m=201209">2012年九月</a></li>
	<li><a href="http://hedengcheng.com/?m=201208">2012年八月</a></li>
	<li><a href="http://hedengcheng.com/?m=201207">2012年七月</a></li>
	<li><a href="http://hedengcheng.com/?m=201206">2012年六月</a></li>
	<li><a href="http://hedengcheng.com/?m=201205">2012年五月</a></li>
	<li><a href="http://hedengcheng.com/?m=201204">2012年四月</a></li>
		</ul>
	</div>

	<!-- blogroll -->
	<div class="widget widget_links">
		<h3>Blogroll</h3>
		<ul>
			<li><a href="http://queue.acm.org/blog/" title="Architecting Tomorrow’s Computing" target="_blank">ACM Queue</a></li>
<li><a href="http://www.allthingsdistributed.com/" title="Werner Vogels’ weblog on building scalable and robust distributed systems." target="_blank">All Things Distributed</a></li>
<li><a href="http://bartoszmilewski.com/" title="Concurrency, Multicore, C++, Haskell" target="_blank">Bartosz Milewski's Programming Cafe</a></li>
<li><a href="http://dtrace.org/blogs/brendan/" title="Brendan Gregg’s professional blog" target="_blank">Brendan's blog</a></li>
<li><a href="http://dimitrik.free.fr/blog/index.html" target="_blank">Dimitrik's Weblog</a></li>
<li><a href="http://www.drdobbs.com/" title="The World of Software Development" target="_blank">Dr.Dobb's</a></li>
<li><a href="http://duartes.org/gustavo/blog/" title="Software, computers, and business." target="_blank">Gustavo Duarte</a></li>
<li><a href="http://highscalability.com/" target="_blank">High Scalability</a></li>
<li><a href="http://blog.jcole.us/" target="_blank">Jeremy Cole's Blog</a></li>
<li><a href="http://jonathanlewis.wordpress.com/" target="_blank">Jonathan Lewis's Oracle Scratchpad</a></li>
<li><a href="http://engineering.linkedin.com/" target="_blank">LinkedIn Engineering</a></li>
<li><a href="http://mysqlha.blogspot.com/" target="_blank">Mark Callaghan's High Availability MySQL</a></li>
<li><a href="http://mechanical-sympathy.blogspot.com/" title="Hardware and software working together in harmony" target="_blank">Mechanical Sympathy</a></li>
<li><a href="http://www.mysqlperformanceblog.com/" target="_blank">MySQL Performance Blog</a></li>
<li><a href="http://paulmck.livejournal.com/" title="《Is Parallel Programming Hard, And, If So, What Can You Do About It?》一书作者" target="_blank">Paul E. McKenney's Journal</a></li>
<li><a href="http://perspectives.mvdirona.com/" title="James Hamilton’s Blog" target="_blank">Perspectives</a></li>
<li><a href="http://preshing.com/" title="Concurrent Programming, Lock &amp; Lock Free Programming" target="_blank">preshing on programming</a></li>
<li><a href="http://herbsutter.com/" title="Herb Sutter on software, hardware, and concurrency" target="_blank">Sutter’s Mill</a></li>
<li><a href="http://perfdynamics.blogspot.com/" title="Possibly pithy insights into computer performance analysis and capacity planning based on the Guerrilla series of books and training classes provided by Performance Dynamics Company." target="_blank">The Pith of Performance</a></li>
<li><a href="https://blog.twitter.com/engineering" title="Information from Twitter’s engineering team about our technology, tools and events." target="_blank">The Twitter Engineering Blog</a></li>
<li><a href="https://blogs.oracle.com/mysqlinnodb/" target="_blank">Transactions on InnoDB</a></li>
<li><a href="http://www.wired.com/wiredenterprise/" title="最新技术新闻" target="_blank">Wired Enterprise – IT Happens</a></li>
<li><a href="http://blog.codingnow.com/" target="_blank">云风的Blog</a></li>
<li><a href="http://coolshell.cn/" target="_blank">左耳朵耗子的酷壳</a></li>
<li><a href="http://www.dbthink.com/" target="_blank">旺旺的数据库思考者之家</a></li>
<li><a href="http://blog.yufeng.info/" target="_blank">霸爷的系统技术非业余研究</a></li>
<li><a href="http://www.valleytalk.org/" target="_blank">首席的弯曲评论</a></li>
		</ul>
	</div>


<!-- showcase 2 -->

</div>
<!-- sidebar END -->

	<div class="fixed"></div>

	<!-- footer START -->
	<div id="footer">
		<div id="about">
			Powered by <a href="http://wordpress.org/">WordPress</a>			 | Theme by <a href="http://www.neoease.com/">NeoEase</a>			 | Valid <a href="http://validator.w3.org/check?uri=referer">XHTML 1.1</a> and <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3">CSS 3</a>		</div>
		<ul id="admin">
			<li><a href="http://hedengcheng.com/wp-login.php?action=register">注册</a></li>			<li><a href="http://hedengcheng.com/wp-login.php">登录</a></li>
			<li id="gotop"><a href="http://hedengcheng.com/?p=771#" onclick="MGJS.goTop();return false;">置顶</a></li>
		</ul>
		<div class="fixed"></div>
	</div>
	<!-- footer END -->

</div>
<!-- content END -->

		</div><!-- container -->
	</div><!-- wrap -->

<script type="text/javascript" src="./何登成的技术博客 » MySQL 加锁处理分析_files/form.js.下载"></script>
<script type="text/javascript" src="./何登成的技术博客 » MySQL 加锁处理分析_files/comment-reply.min.js.下载"></script>
<script type="text/javascript" src="./何登成的技术博客 » MySQL 加锁处理分析_files/wp-embed.min.js.下载"></script>



</body></html>